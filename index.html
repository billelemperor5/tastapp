<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>My Decor Manager — مدير الديكور</title>
<!-- Google Fonts: Tajawal -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- Dexie.js (for IndexedDB) -->
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<!-- html2canvas.js (for creating images from HTML) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Marked.js (for rendering Markdown from AI) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root{
    --primary:#0f766e; /* teal */
    --accent:#f59e0b;  /* amber */
    --bg:#f8fafc;
    --card:#ffffff;
    --muted:#6b7280;
    --border-color: rgba(2,6,23,.06);
    --text-primary: #071331; /* لون النص الأساسي */
  }
  body.dark{
    --bg:#071026;
    --card:#0b1220;
    --muted:#9aa6b2;
    --border-color: rgba(255,255,255,.06);
    --text-primary: #f1f5f9; /* لون النص الأساسي في الوضع الليلي */
  }
  html,body{height:100%}
  body{
    margin:0;font-family: 'Tajawal', sans-serif; background:var(--bg); color: var(--text-primary);
    -webkit-font-smoothing:antialiased; display:flex;flex-direction:column;min-height:100vh;
  }
  
  /* --- Splash Screen Styles --- */
  .splash{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--primary),#065f46); color:white; z-index:60;
    transition:opacity .4s ease-out, visibility .4s;
  }
  .splash.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
  .splash-content {
    text-align: center;
    animation: fadeInFromBottom 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  @keyframes fadeInFromBottom {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .progress-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 28px; height: 20px; }
  .progress-bar div { width: 12px; height: 12px; background-color: var(--accent); border-radius: 50%; animation: pulse 1.4s infinite ease-in-out both; }
  .progress-bar .dot1 { animation-delay: -0.30s; }
  .progress-bar .dot2 { animation-delay: -0.15s; }
  .progress-bar .dot3 { animation-delay: 0s; }
  @keyframes pulse {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1.0); opacity: 1; }
  }
  /* --- End Splash Screen Styles --- */

  /* --- Responsive App Layout --- */
  .app-layout {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }
  .app{
    display:flex;
    flex-direction:column;
    flex:1; 
    padding-bottom: 70px; /* Space for mobile bottom nav */
  }

  header.app-header{
    display:flex; align-items:center; justify-content:space-between; padding:12px 16px; position:sticky; top:0; z-index:40;
    background:rgba(255,255,255,.7); backdrop-filter: blur(6px); border-bottom:1px solid rgba(2,6,23,.04)
  }
  body.dark header.app-header{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#0b8f81);display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
  main{flex:1;overflow:auto;padding:16px;-webkit-overflow-scrolling:touch}

  .hero{background:linear-gradient(90deg,var(--primary),#047857);color:white;padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:rgba(255,255,255,0.09);padding:10px;border-radius:10px;min-width:110px;text-align:center}

  .grid-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
  
  .card{
    background:var(--card); border-radius:12px; padding:16px; display:flex; flex-direction:column;
    align-items:center; text-align:center; gap:8px; box-shadow:0 10px 30px rgba(2,6,23,.04);
    cursor:pointer; border: 2px solid transparent;
  }
  .card .icon{
    width:60px; height:60px; border-radius:16px; display:flex; align-items:center;
    justify-content:center; color:white; font-size:24px; margin-bottom: 4px;
  }

  .btn{background:var(--primary);color:white;padding:8px 12px;border-radius:10px;font-weight:700; border:none; cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,.06);color:var(--primary)}

  /* --- Navigation Styles (Mobile First) --- */
  .main-nav {
    position: fixed; bottom: 0; left: 0; right: 0; height: 65px;
    background: var(--card); display: flex; justify-content: space-around;
    align-items: center; box-shadow: 0 -2px 10px rgba(2,6,23,.08);
    z-index: 50; border-top: 1px solid var(--border-color);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; color: var(--muted); cursor: pointer; font-size: 12px; font-weight: 500;
    flex: 1; height: 100%;
  }
  .nav-brand { display: none; } /* Hide brand logo in nav on mobile */
  
  .nav-item:hover { color: var(--primary); }
  .nav-item.active { color: var(--primary); font-weight: 700; }
  .nav-item i { font-size: 20px; }

  /* Animations & Transitions */
  .btn, .card, .nav-item {
    transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .btn:active, .card:active, .nav-item:active {
    transform: scale(0.96);
  }
  .card:hover{
    transform:translateY(-6px);
  }
  .view-container { animation: fadeIn .4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .view-container.is-exiting { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; pointer-events: none; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(15px); }
  }
  .nav-item.active i { animation: nav-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes nav-bounce {
    0%   { transform: translateY(0); }
    50%  { transform: translateY(-5px); }
    100% { transform: translateY(0); }
  }

  /* --- Desktop & Tablet Styles --- */
  @media (min-width: 768px) {
    .app-layout {
        flex-direction: row;
    }
    .main-nav {
        position: sticky; top: 0; width: 240px; height: 100vh;
        flex-direction: column; justify-content: flex-start; align-items: stretch;
        padding: 16px;
        gap: 8px; border-top: none;
        border-left: 1px solid var(--border-color);
        box-sizing: border-box;
    }
    .nav-brand {
        display: flex; align-items: center; gap: 12px;
        padding: 0 0 16px;
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
    }
    .nav-item {
        flex-direction: row; justify-content: flex-start; gap: 12px;
        flex: 0 0 auto; width: 100%;
        height: auto; padding: 10px 12px;
        border-radius: 8px;
        margin: 0;
        box-sizing: border-box;
    }
    .nav-item span { font-size: 14px; }
    .nav-item.active { background-color: rgba(15, 118, 110, 0.1); }
    
    .app {
        padding-bottom: 0;
        max-width: none;
        flex-grow: 1;
        margin: 0;
    }
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
    header.app-header {
        display: none;
    }
  }

  @media (min-width: 1024px) {
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
  }
  /* --- End Desktop Styles --- */

  /* --- Modal Styles --- */
  .modal-container {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 16px;
  }
  .modal-backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    animation: fadeIn .3s ease;
  }
  .modal-content {
    position: relative; z-index: 101;
    background: var(--card);
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: fadeInFromBottom .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
  }
  .modal-header h3 { margin: 0; font-size: 18px; }
  .modal-header .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 0 8px; }
  .modal-body { padding: 16px; overflow-y: auto; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
  .form-group input {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
  }
  .form-group textarea {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
    font-family: 'Tajawal', sans-serif;
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }
  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .modal-container.is-exiting .modal-content { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
  .modal-container.is-exiting .modal-backdrop { animation: fadeOut .25s ease forwards; }
  #deleteWorkerBtn {
    background-color: #ef4444;
    color: white;
  }
  #deleteWorkerBtn:hover {
    background-color: #dc2626;
  }

  /* Ensure the confirmation modal appears on top of other modals */
  #confirmModal {
    z-index: 110;
  }

  /* --- Worker Details & Calendar Styles --- */
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
  .calendar-header { font-weight: 700; font-size: 12px; color: var(--muted); padding-bottom: 8px; }
  .calendar-day { height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; position: relative; }
  .calendar-day.not-in-month { color: var(--muted); opacity: 0.5; }
  .calendar-day.present { background-color: rgba(34, 197, 94, 0.2); color: #15803d; font-weight: 700; }
  .calendar-day.absent { background-color: rgba(239, 68, 68, 0.2); color: #b91c1c; font-weight: 700; }
  body.dark .calendar-day.present { color: #6ee7b7; }
  body.dark .calendar-day.absent { color: #fca5a5; }
  .activity-log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; background: var(--bg); }
  .activity-log-item .icon { font-size: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 12px; }
  .activity-log-item .delete-activity { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; }
  .activity-log-item .delete-activity:hover { color: #ef4444; }
  .activity-log-item .note { font-size: 12px; color: var(--muted); margin-top: 4px; padding-right: 44px; }

  /* --- New Note Form Styles --- */
  .add-note-container {
    max-width: 600px;
    margin: 0 auto 24px;
    background: var(--card);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(2,6,23,.08);
    padding: 12px;
  }
  .add-note-container input,
  .add-note-container textarea {
    width: 100%;
    border: none;
    background: transparent;
    padding: 8px;
    font-size: 15px;
    color: var(--text-primary);
    font-family: 'Tajawal', sans-serif;
  }
  .add-note-container input:focus,
  .add-note-container textarea:focus {
    outline: none;
  }
  .add-note-container #newNoteTitle { font-weight: 700; font-size: 16px; }
  .add-note-container #newNoteContent { resize: none; min-height: 40px; }
  .new-note-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  /* --- Notes Feature Styles --- */
  .notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
  }
  .note-card {
    background: var(--card);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(2,6,23,.05);
    border-top: 4px solid var(--primary);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .note-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(2,6,23,.08);
  }
  .note-title { margin: 0 0 8px; font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-content { margin: 0; font-size: 14px; color: var(--muted); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 5; line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; min-height: 112px; }
  .note-footer { margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--muted); text-align: left; }
  #noteContent {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  .color-swatches { display: flex; gap: 10px; margin-top: 8px; }
  .swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  .swatch:hover { transform: scale(1.1); }
  .swatch.selected {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--card);
  }
  /* --- AI Action Dropdown --- */
  .ai-action-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    background-color: var(--card);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 8px;
    z-index: 120;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 150px;
    margin-bottom: 8px;
  }

  /* --- Inventory Styles --- */
  .status-badge {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    color: white;
    text-align: center;
  }

  /* --- Calendar View Styles --- */
  .full-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-left: 1px solid var(--border-color); }
  .full-calendar-header { text-align: center; padding: 8px 4px; font-weight: 700; font-size: 13px; color: var(--muted); border-bottom: 1px solid var(--border-color); }
  .full-calendar-day {
    min-height: 100px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    padding: 4px;
    font-size: 13px;
    font-weight: 700;
  }
  .full-calendar-day.not-in-month { background-color: var(--bg); color: var(--muted); }
  .calendar-event {
    font-size: 12px; padding: 2px 6px; border-radius: 4px; color: white;
    margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    cursor: pointer;
  }


  /* --- Settlement Card Styles --- */
  .settlement-card {
    background: linear-gradient(135deg, var(--accent), #d97706);
    color: white;
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
  }
  /* --- Print Styles --- */
  @media print {
    /* Hide everything on the page by default when printing */
    body > * {
      display: none !important;
    }
    /* Only show the print container and its content */
    #printContainer, #printContainer * {
      display: block !important;
      visibility: visible !important;
    }
  }

  /* --- Toast Notification Styles --- */
  .toast-container {
    position: fixed;
    bottom: 80px; /* Above the nav bar */
    left: 50%;
    transform: translateX(-50%);
    z-index: 120;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    pointer-events: none;
  }
  .toast {
    background-color: #22c55e; /* Green for success */
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: fadeInFromBottom 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .toast.error { background-color: #ef4444; }

  /* --- Switch Toggle Styles --- */
  .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--primary); }
  input:focus + .slider { box-shadow: 0 0 1px var(--primary); }
  input:checked + .slider:before { transform: translateX(22px); }


  /* --- AI Assistant Styles --- */
  .ai-chat-container { display: flex; flex-direction: column; height: 100%; }
  .ai-chat-history { flex-grow: 1; overflow-y: auto; padding: 10px; }
  .ai-chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; margin-bottom: 12px; line-height: 1.6; }
  .ai-chat-bubble.user { background-color: var(--primary); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
  .ai-chat-bubble.model { background-color: var(--card); border-bottom-left-radius: 4px; margin-right: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .ai-chat-bubble.model p:first-child { margin-top: 0; }
  .ai-chat-bubble.model p:last-child { margin-bottom: 0; }
  .ai-chat-bubble.model strong { color: var(--primary); }
  .ai-chat-bubble.model code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 13px; direction: ltr; display: inline-block; }
  .ai-chat-bubble.model pre { background: var(--bg); padding: 10px; border-radius: 8px; overflow-x: auto; font-size: 13px; }
  .ai-chat-bubble.model ul, .ai-chat-bubble.model ol { padding-right: 20px; }
  .ai-chat-input-area { display: flex; gap: 10px; padding: 10px; border-top: 1px solid var(--border-color); }
  #aiPromptInput { flex-grow: 1; resize: none; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text-primary); font-family: 'Tajawal', sans-serif; font-size: 15px; }
  #sendAiPromptBtn { height: 44px; width: 44px; padding: 0; font-size: 18px; flex-shrink: 0; }
  .typing-indicator { display: flex; align-items: center; gap: 5px; }
  .typing-indicator span { width: 8px; height: 8px; background-color: var(--muted); border-radius: 50%; animation: typing-pulse 1.4s infinite ease-in-out both; }
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes typing-pulse {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
  }

  /* *** تحسين: إعادة تصميم أزرار التبويب لتصبح بطاقات ملونة *** */
  .tab-card-container {
    display: grid;
    /* *** تحسين: تعديل حجم الأعمدة لتناسب البطاقات الأصغر *** */
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .tab-card {
    /* *** تحسين: تقليل الحشو لجعل البطاقة أصغر *** */
    padding: 12px 10px;
    border-radius: 12px;
    color: white;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    border: 3px solid transparent;
    opacity: 0.9;
  }
  .tab-card.active { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: var(--accent); opacity: 1; }
  /* *** تحسين: تصغير حجم الأيقونة والنص *** */
  .tab-card i { font-size: 20px; margin-bottom: 6px; }
  .tab-card span { font-weight: 700; font-size: 13px; display: block; }
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn .4s; }

  /* *** إضافة: تنسيقات للجداول الاحترافية داخل النوافذ المنبثقة *** */
  .professional-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .professional-table th, .professional-table td { padding: 12px 10px; text-align: right; border-bottom: 1px solid var(--border-color); }
  .professional-table th { font-size: 13px; color: var(--muted); font-weight: 700; }
  .professional-table tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
  .professional-table tbody tr:hover { background-color: var(--bg); }
  .professional-table .amount-col { font-weight: 700; text-align: left; }
  .professional-table .amount-col.positive { color: #10b981; }
  .professional-table .amount-col.negative { color: #ef4444; }
  .professional-table .icon-cell { width: 40px; text-align: center; }
  .professional-table .icon-cell i { color: var(--muted); }
  @media (max-width: 480px) {
    .professional-table .hide-on-mobile { display: none; }
  }
</style>
</head>
<body>
  <!-- splash -->
  <div id="splash" class="splash" role="dialog" aria-hidden="false">
    <div class="splash-content">
        <div style="font-size:52px; margin-bottom:12px;"><i class="fas fa-paint-roller"></i></div>
        <h1 style="margin:0;font-size:24px;font-weight:800; letter-spacing: 1px;">My Decor Manager</h1>
        <p style="margin:8px 0 0;opacity:.9; font-size: 15px;">تطبيقك لإدارة أعمال الديكور والبناء</p>
        <div class="progress-bar">
            <div class="dot1"></div>
            <div class="dot2"></div>
            <div class="dot3"></div>
        </div>
    </div>
  </div>

  <!-- Main application wrapper for layout -->
  <div class="app-layout" id="appLayout">
    
    <!-- Navigation (bottom bar on mobile, sidebar on desktop) -->
    <nav class="main-nav" id="mainNav">
        <!-- Brand logo for sidebar view -->
        <div class="nav-brand">
            <div class="logo" style="width:40px;height:40px;border-radius:10px;"><i class="fas fa-paint-roller"></i></div>
            <div>
              <div style="font-weight:800; font-size: 15px;">My Decor Manager</div>
            </div>
        </div>
        <!-- Nav items -->
        <div class="nav-item active" data-view="home">
            <i class="fas fa-tachometer-alt"></i>
            <span>الرئيسية</span>
        </div>
        <div class="nav-item" data-view="about">
            <i class="fas fa-info-circle"></i>
            <span>حول</span>
        </div>
        <div class="nav-item" data-view="workers">
            <i class="fas fa-users"></i>
            <span>العمال</span>
        </div>
        <div class="nav-item" data-view="settings">
            <i class="fas fa-cog"></i>
            <span>الاعدادات</span>
        </div>
    </nav>
    
    <!-- Main Content Area -->
    <div class="app" id="app" aria-hidden="true" style="visibility: hidden;">
        <!-- Header for mobile view only -->
        <header class="app-header">
            <div class="brand">
                <div class="logo"><i class="fas fa-paint-roller"></i></div>
                <div>
                <div style="font-weight:800">My Decor Manager</div>
                <div style="font-size:13px;color:var(--muted)">مدير الديكور الخاص بك</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center"><button id="themeToggleHeader" class="btn ghost" title="تبديل الوضع"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <main id="mainContent">
            <!-- Views will be injected here -->
        </main>
    </div>

  </div>

  <!-- *** إضافة: نافذة منبثقة لعرض كل دفعات العميل لمشروع معين *** -->
  <div id="allPaymentsModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>جميع الدفعات المستلمة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="allPaymentsContent">
                  <!-- Full payments list will be injected here -->
              </div>
          </div>
      </div>
  </div>



  <!-- *** إضافة: نافذة منبثقة لعرض كل الأنشطة المالية للمشروع *** -->
  <div id="projectFullFinanceModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>السجل المالي الكامل للمشروع</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="projectFullFinanceContent">
                  <!-- Full log will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لعرض كل نفقات المشروع *** -->
  <div id="allExpensesModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>جميع نفقات المشروع</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="allExpensesContent">
                  <!-- Full expenses list will be injected here -->
              </div>
          </div>
      </div>
  </div>






  <!-- Modal for adding/editing workers -->
  <div id="workerModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="workerModalTitle">إضافة عامل جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="workerForm">
                  <input type="hidden" id="workerId">
                  <input type="hidden" id="workerImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="workerImagePreview" src="" alt="صورة العامل" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="workerImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>

                      <div id="workerImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-user"></i>
                      </div>
                      <input type="file" id="workerImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="workerImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="workerName">اسم العامل</label>
                      <input type="text" id="workerName" required>
                  </div>
                  <div class="form-group">
                      <label for="workerPhone">رقم الهاتف</label>
                      <input type="tel" id="workerPhone">
                  </div>
                  <div class="form-group">
                      <label for="workerDailyRate">الأجرة اليومية الافتراضية (د.ج)</label>
                      <input type="number" id="workerDailyRate" required>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteWorkerBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding attendance/payment -->
  <div id="activityModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="activityModalTitle">إضافة نشاط</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="activityForm">
                  <input type="hidden" id="activityWorkerId">
                  <input type="hidden" id="activityType">
                  <div class="form-group">
                      <label for="activityDate">التاريخ</label>
                      <input type="date" id="activityDate" required>
                  </div>
                  <div id="attendanceRateGroup" class="form-group" style="display: none;">
                      <label for="attendanceDailyRate">أجرة هذا اليوم (د.ج)</label>
                      <input type="number" id="attendanceDailyRate" placeholder="تُستخدم الأجرة الافتراضية إذا ترك فارغاً">
                  </div>
                  <div id="paymentAmountGroup" class="form-group" style="display: none;">
                      <label for="paymentAmount">المبلغ المدفوع (د.ج)</label>
                      <input type="number" id="paymentAmount" placeholder="مثال: 5000">
                  </div>
                  <div id="activityNoteGroup" class="form-group" style="display: none;">
                      <label for="activityNote">ملاحظة (اختياري)</label>
                      <input type="text" id="activityNote" placeholder="مثال: سلفة أسبوعية">
                  </div>
                  <div class="form-actions"><button type="submit" class="btn">حفظ</button></div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for full activity log -->
  <div id="activityLogModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>السجل الكامل للأنشطة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="fullActivityLogContent">
                  <!-- Full log will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing suppliers -->
  <div id="supplierModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="supplierModalTitle">إضافة مورد جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="supplierForm">
                  <input type="hidden" id="supplierId">
                  <input type="hidden" id="supplierImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="supplierImagePreview" src="" alt="صورة المورد" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="supplierImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                      <div id="supplierImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#10b981,#059669); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-truck"></i>
                      </div>
                      <input type="file" id="supplierImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="supplierImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="supplierName">اسم المورد</label>
                      <input type="text" id="supplierName" required>
                  </div>
                  <div class="form-group">
                      <label for="supplierPhone">رقم الهاتف</label>
                      <input type="tel" id="supplierPhone">
                  </div>
                  <div class="form-group">
                      <label for="supplierSpecialty">التخصص (مثال: دهانات, كهرباء)</label>
                      <input type="text" id="supplierSpecialty">
                  </div>
                  <!-- *** إضافة: حقل جديد للملاحظات *** -->
                  <div class="form-group">
                      <label for="supplierNotes">ملاحظات (اختياري)</label>
                      <textarea id="supplierNotes" rows="3" placeholder="أي تفاصيل إضافية عن المورد..."></textarea>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteSupplierBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for attendance confirmation -->
  <div id="attendanceConfirmModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 360px;">
          <div class="modal-header">
              <h3>تأكيد حالة اليوم</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <p style="margin-top:0; margin-bottom: 20px;">الرجاء تحديد حالة العامل لتاريخ <strong id="confirmDate"></strong>:</p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmPresentBtn" style="background-color: #10b981; flex: 1;"><i class="fas fa-check" style="margin-left: 6px;"></i> حضور</button>
                  <button type="button" class="btn" id="confirmAbsentBtn" style="background-color: #ef4444; flex: 1;"><i class="fas fa-times" style="margin-left: 6px;"></i> غياب</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for generic confirmation -->
  <div id="confirmModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 380px;">
          <div class="modal-header">
              <h3 id="confirmModalTitle">تأكيد الحذف</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
              <p id="confirmModalMessage" style="margin-top:0; margin-bottom: 20px; font-size: 15px; line-height: 1.6;"></p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmModalCancelBtn" style="background-color: var(--muted);">إلغاء</button>
                  <button type="button" class="btn" id="confirmModalConfirmBtn">نعم</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing notes -->
  <div id="noteModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3 id="noteModalTitle">إضافة ملاحظة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="noteForm">
                  <input type="hidden" id="noteId">
                  <div class="form-group">
                      <label for="noteTitle">العنوان</label>
                      <input type="text" id="noteTitle" placeholder="عنوان الملاحظة...">
                  </div>
                  <div class="form-group">
                      <label for="noteContent">المحتوى</label>
                      <textarea id="noteContent" rows="8" placeholder="اكتب أفكارك أو مقاساتك هنا..."></textarea>
                  </div>
                  <div class="form-group">
                      <label>اختر لوناً</label>
                      <div class="color-swatches">
                          <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                          <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                          <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                          <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                          <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                      </div>
                      <input type="hidden" id="noteColor" value="#3b82f6">
                  </div>
                  <div class="form-actions" style="position: relative;">
                      <button type="button" class="btn ghost" id="noteAiHelperBtn" style="color: #a855f7; border-color: #a855f7; margin-left: auto; margin-right: 10px;"><i class="fas fa-magic"></i> مساعدة AI</button>
                      <button type="button" class="btn" id="deleteNoteBtn" style="display: none; background-color: #ef4444; margin-left: auto; margin-right: 0;">حذف</button>
                      <button type="submit" class="btn" style="margin-left: 0;">حفظ الملاحظة</button>
                      <div id="noteAiActionDropdown" class="ai-action-dropdown" style="display: none;">
                          <button type="button" data-action="summarize" class="btn ghost" style="text-align: right; width: 100%; border: none;">تلخيص النص</button>
                          <button type="button" data-action="rephrase" class="btn ghost" style="text-align: right; width: 100%; border: none;">إعادة صياغة</button>
                          <button type="button" data-action="suggest_title" class="btn ghost" style="text-align: right; width: 100%; border: none;">اقتراح عنوان</button>
                      </div>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing inventory items -->
  <div id="inventoryModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="inventoryModalTitle">إضافة أداة جديدة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="inventoryForm">
                  <input type="hidden" id="inventoryId">
                  <input type="hidden" id="inventoryImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="inventoryImagePreview" src="" alt="صورة الأداة" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="inventoryImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                      <div id="inventoryImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-toolbox"></i>
                      </div>
                      <input type="file" id="inventoryImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="inventoryImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="inventoryName">اسم الأداة</label>
                      <input type="text" id="inventoryName" required>
                  </div>
                  <div class="form-group">
                      <label for="inventoryQuantity">الكمية</label>
                      <input type="number" id="inventoryQuantity" value="1" required>
                  </div>
                  <div class="form-group">
                      <label for="inventoryStatus">الحالة</label>
                      <select id="inventoryStatus" class="form-group input" style="padding: 10px; width: 100%;"><option value="available">متوفر</option><option value="in_use">قيد الاستخدام</option><option value="maintenance">صيانة</option></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteInventoryBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for lending an item -->
  <div id="lendItemModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="lendItemModalTitle">إعارة أداة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="lendItemForm">
                  <input type="hidden" id="lendItemId">
                  <div class="form-group">
                      <label for="borrowerName">اسم المستعير</label>
                      <input type="text" id="borrowerName" required>
                  </div>
                  <div class="form-group">
                      <label for="borrowDate">تاريخ الإعارة</label>
                      <input type="date" id="borrowDate" required>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">تأكيد الإعارة</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing calendar events -->
  <div id="eventModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="eventModalTitle">إضافة حدث جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="eventForm">
                  <input type="hidden" id="eventId">
                  <div class="form-group">
                      <label for="eventTitle">عنوان الحدث</label>
                      <input type="text" id="eventTitle" required>
                  </div>
                  <div class="form-group">
                      <label for="eventStartDate">تاريخ البدء</label>
                      <input type="date" id="eventStartDate" required>
                  </div>
                  <div class="form-group">
                      <label for="eventEndDate">تاريخ الانتهاء</label>
                      <input type="date" id="eventEndDate" required>
                  </div>
                  <div class="form-group">
                      <label for="eventType">نوع الحدث</label>
                      <select id="eventType" class="form-group input" style="padding: 10px; width: 100%;"><option value="task">مهمة</option><option value="appointment">موعد</option><option value="delivery">تسليم</option><option value="start_work">بدء عمل</option></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteEventBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for event details -->
  <div id="eventDetailsModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
              <h3>تفاصيل الحدث</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <h2 id="eventDetailsTitle" style="margin-top: 0; font-size: 20px;"></h2>
              <div style="margin-bottom: 12px;">
                  <span style="font-size: 14px; color: var(--muted);">النوع:</span>
                  <span id="eventDetailsType" class="status-badge" style="margin-right: 8px;"></span>
              </div>
              <p style="font-size: 15px;"><strong><i class="fas fa-calendar-alt" style="margin-left: 6px; color: var(--muted);"></i>تاريخ البدء:</strong> <span id="eventDetailsStartDate"></span></p>
              <p style="font-size: 15px;"><strong><i class="fas fa-calendar-check" style="margin-left: 6px; color: var(--muted);"></i>تاريخ الانتهاء:</strong> <span id="eventDetailsEndDate"></span></p>
              
              <div class="form-actions" style="margin-top: 24px;">
                  <button type="button" class="btn" id="deleteEventDetailsBtn" style="background-color: #ef4444; margin-left: auto; margin-right: 0;">حذف</button>
                  <button type="button" class="btn ghost" id="analyzeEventDetailsBtn" style="color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i> تحليل</button>
                  <button type="button" class="btn" id="editEventDetailsBtn">تعديل</button>
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإضافة/تعديل المهام *** -->
  <div id="taskModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
              <h3 id="taskModalTitle">إضافة مهمة جديدة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="taskForm">
                  <input type="hidden" id="taskId">
                  <input type="hidden" id="taskProjectId">
                  <div class="form-group">
                      <label for="taskTitle">عنوان المهمة</label>
                      <input type="text" id="taskTitle" required placeholder="مثال: تركيب الجبس لغرفة الجلوس">
                  </div>
                  <div class="form-group">
                      <label for="taskStatus">حالة المهمة</label>
                      <select id="taskStatus" class="form-group input" style="padding: 10px; width: 100%;">
                          <option value="todo">جديدة</option>
                          <option value="inprogress">قيد التنفيذ</option>
                          <option value="done">مكتملة</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="taskAssignedTo">إسناد إلى (يمكن اختيار أكثر من عامل)</label>
                      <select id="taskAssignedTo" multiple class="form-group input" style="padding: 10px; width: 100%; height: 120px;"></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ المهمة</button>
                      <button type="button" class="btn" id="deleteTaskBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإضافة/تعديل المهام *** -->
  <div id="taskModal" class="modal-container" style="display: none;">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
              <h3 id="taskModalTitle">إضافة مهمة جديدة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="taskForm">
                  <input type="hidden" id="taskId">
                  <input type="hidden" id="taskProjectId">
                  <div class="form-group">
                      <label for="taskTitle">عنوان المهمة</label>
                      <input type="text" id="taskTitle" required placeholder="مثال: تركيب الجبس لغرفة الجلوس">
                  </div>
                  <div class="form-group">
                      <label for="taskStatus">حالة المهمة</label>
                      <select id="taskStatus" class="form-group input" style="padding: 10px; width: 100%;">
                          <option value="todo">جديدة</option>
                          <option value="inprogress">قيد التنفيذ</option>
                          <option value="done">مكتملة</option>
                      </select>
                  </div>
                  <div class="form-group">
                      <label for="taskAssignedTo">إسناد إلى (يمكن اختيار أكثر من عامل)</label>
                      <select id="taskAssignedTo" multiple class="form-group input" style="padding: 10px; width: 100%; height: 120px;"></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ المهمة</button>
                      <button type="button" class="btn" id="deleteTaskBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>


  <!-- Container for printing content -->
  <div id="printContainer" class="print-only" style="display: none;"></div>

  <!-- Container for toast notifications -->
  <div id="toastContainer" class="toast-container"></div>

<script>
  // =================================================================
  // 1. CONFIGURATION & APP STATE
  // =================================================================
  
  // --- Database Setup (Dexie.js) ---
  const db = new Dexie('decorManagerDB');
  // *** إضافة: جدول جديد للمهام ورفع إصدار قاعدة البيانات ***
  db.version(19).stores({
      workers: '++id, name, settlements',
      projects: '++id, name, clientId, status', // التعريف الصحيح الذي يشمل الحالة
      clients: '++id, name',
      suppliers: '++id, name',
      inventory: '++id, name, borrowerName',
      calendarEvents: '++id, startDate, endDate',
      expenses: '++id, date, projectId, workerId, supplierId, category, paymentStatus',
      projectPayments: '++id, projectId, date',
      api_configs: '++id, name, provider', // New table for AI API configurations, added provider index
      companyProfiles: '++id, profileName', 
      notes: '++id, updatedAt',
      app_settings: 'key' // A simple key-value store for things like theme
  }).upgrade(tx => {
    // *** إصلاح: تم حذف هذا السطر لأنه يحاول الوصول إلى جدول 'todos' الذي لم يعد موجوداً في هذا الإصدار من قاعدة البيانات ***
    // return tx.table('todos').clear(); 
  });

  // *** إضافة: متغير لتتبع حالة فتح قاعدة البيانات ***
  let isDbOpen = false;

  // حالة التطبيق (البيانات)
  let state = {
    previousView: null, // *** إضافة: لتتبع الواجهة السابقة ***
    currentView: { name: 'home', params: {} },
    projects: [],
    workers: [],
    suppliers: [],
    notes: [], // *** إصلاح: إضافة حالة لتخزين المهام ***
    inventory: [],
    projectPayments: [],
    calendarEvents: [],
    clients: [],
    companyProfiles: [],
    api_configs: []
  };

  // Temporary storage for multi-step modals
  let tempAttendanceData = {};

  // تعريف الوحدات الأساسية للتطبيق
  const appModules = [
    { 
      key: 'projects',
      title: 'إدارة المشاريع',
      description: 'عرض، إضافة، وتعديل المشاريع',
      icon: 'fa-hard-hat',
      color: 'linear-gradient(135deg,#06b6d4,#0284c7)',
    },
    {
      key: 'workers',
      title: 'سجل العمال',
      description: 'قائمة العمال وتسجيل أيام العمل',
      icon: 'fa-users',
      color: 'linear-gradient(135deg,#f97316,#f59e0b)',
    },
    {
      key: 'suppliers',
      title: 'قائمة الموردين',
      description: 'سجل الموردين وبيانات الاتصال',
      icon: 'fa-truck',
      color: 'linear-gradient(135deg,#10b981,#059669)',
    },
    {
      key: 'expenses', 
      title: 'إدارة النفقات', 
      description: 'تتبع وإدارة جميع نفقات المشاريع', 
      icon: 'fa-wallet', 
      color: 'linear-gradient(135deg,#ef4444,#dc2626)' 
    },
    {
      key: 'clients',
      title: 'إدارة العملاء',
      description: 'سجل العملاء وبيانات الاتصال',
      icon: 'fa-address-book',
      color: 'linear-gradient(135deg,#2563eb,#3b82f6)',
    },
    {
      key: 'more_features',
      title: 'ميزات إضافية',
      description: 'أدوات تنظيمية متقدمة',
      icon: 'fa-layer-group',
      color: 'linear-gradient(135deg,#64748b,#475569)',
    }
  ];

  const subModules = [
    { 
      key: 'my_info', 
      title: 'ملفاتي التعريفية', 
      description: 'إدارة معلومات الدفع والشركة', 
      icon: 'fa-user-tie', 
      color: 'linear-gradient(135deg,#a855f7,#9333ea)' 
    },
    { 
      key: 'ai_assistant', 
      title: 'مساعد الذكاء الاصطناعي', 
      description: 'الحصول على أفكار واقتراحات لمشاريعك', 
      icon: 'fa-robot', 
      color: 'linear-gradient(135deg,#0ea5e9,#0284c7)' 
    },
    { key: 'calendar', title: 'الجدول الزمني', description: 'تنظيم مواعيد المشاريع والمهام', icon: 'fa-calendar-alt', color: 'linear-gradient(135deg,#ec4899,#d946ef)' },
    { key: 'inventory', title: 'مخزون الأدوات', description: 'تتبع أدوات ومعدات العمل', icon: 'fa-toolbox', color: 'linear-gradient(135deg,#22c55e,#16a34a)' },
    { key: 'notes', title: 'ملاحظات سريعة', description: 'لتسجيل الأفكار والمقاسات', icon: 'fa-sticky-note', color: 'linear-gradient(135deg,#3b82f6,#2563eb)' }
  ];

  const themes = {
    // Light Themes
    'default-light': { name: 'افتراضي فاتح', type: 'light', colors: { '--primary': '#0f766e', '--accent': '#f59e0b', '--bg': '#f8fafc', '--card': '#ffffff' } },
    'ocean-light': { name: 'محيط فاتح', type: 'light', colors: { '--primary': '#3b82f6', '--accent': '#f43f5e', '--bg': '#f0f9ff', '--card': '#ffffff' } },
    'forest-light': { name: 'غابة فاتحة', type: 'light', colors: { '--primary': '#16a34a', '--accent': '#d97706', '--bg': '#f0fdf4', '--card': '#ffffff' } },
    'sunset-light': { name: 'غروب فاتح', type: 'light', colors: { '--primary': '#f97316', '--accent': '#7c3aed', '--bg': '#fff7ed', '--card': '#ffffff' } },
    'neutral-light': { name: 'محايد فاتح', type: 'light', colors: { '--primary': '#475569', '--accent': '#0f766e', '--bg': '#f1f5f9', '--card': '#ffffff' } },
    // Dark Themes
    'default-dark': { name: 'افتراضي داكن', type: 'dark', colors: { '--primary': '#0d9488', '--accent': '#f59e0b', '--bg': '#071026', '--card': '#0b1220' } },
    'midnight-dark': { name: 'منتصف الليل', type: 'dark', colors: { '--primary': '#38bdf8', '--accent': '#f472b6', '--bg': '#020617', '--card': '#0f172a' } },
    'emerald-dark': { name: 'زمردي داكن', type: 'dark', colors: { '--primary': '#34d399', '--accent': '#facc15', '--bg': '#061e14', '--card': 'rgb(13, 39, 28)' } },
    'purple-dark': { name: 'بنفسجي داكن', type: 'dark', colors: { '--primary': '#a78bfa', '--accent': '#fb923c', '--bg': '#1e1b4b', '--card': '#312e81' } },
    'slate-dark': { name: 'أردوازي داكن', type: 'dark', colors: { '--primary': '#cbd5e1', '--accent': '#0ea5e9', '--bg': '#0f172a', '--card': '#1e293b' } },
  };
  // =================================================================
  // 2. DOM Elements
  // =================================================================
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');
  const themeToggleHeader = document.getElementById('themeToggleHeader');
  const mainContent = document.getElementById('mainContent');
  const mainNav = document.getElementById('mainNav');
  
  // =================================================================
  // 3. CORE FUNCTIONS
  // =================================================================
  
  async function loadState() {
      const workerCount = await db.workers.count();
      if (workerCount === 0) {
          // Database is empty, seed with sample data
          await db.workers.add({ name: "عامل تجريبي", phone: "0555123456", dailyRate: 2000, attendance: [], bonuses: [], payments: [], imageUrl: '' });
          await db.projects.add({ name: "مشروع تجريبي: فيلا", budget: 500000, expenses: 120000 });
          await db.suppliers.add({ name: "مورد تجريبي", specialty: "دهانات" });
      }

      // Load all data into the state object
      state.workers = await db.workers.toArray();
      state.projects = await db.projects.toArray();
      state.suppliers = await db.suppliers.toArray();
      state.notes = await db.notes.toArray();
      state.projectPayments = await db.projectPayments.toArray();
      state.inventory = await db.inventory.toArray();
      state.calendarEvents = await db.calendarEvents.toArray();
      state.expenses = await db.expenses.toArray();
      state.clients = await db.clients.toArray();
      state.companyProfiles = await db.companyProfiles.toArray();
      state.api_configs = await db.api_configs.toArray();
      
      // Always start at home view
      state.currentView = { name: 'home', params: {} };
  }

  async function applyThemeSet(themeName) {
    const theme = themes[themeName];
    if (!theme) return;

    // Apply light/dark class
    document.body.classList.toggle('dark', theme.type === 'dark');

    // Update header toggle icon
    const themeToggleHeader = document.getElementById('themeToggleHeader');
    if (themeToggleHeader) {
        themeToggleHeader.innerHTML = theme.type === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    // Apply CSS variables
    const root = document.documentElement;
    Object.entries(theme.colors).forEach(([key, value]) => {
        root.style.setProperty(key, value);
    });

    await db.app_settings.put({ key: 'selected_theme', value: themeName });
    state.selected_theme = themeName; // Update state immediately
  }

  async function toggleTheme() {
    const currentThemeName = state.selected_theme || 'default-light';
    const currentTheme = themes[currentThemeName];
    const newThemeName = (currentTheme.type === 'light') ? 'default-dark' : 'default-light';
    await applyThemeSet(newThemeName);
    // If on themes page, re-render to show change
    if (state.currentView.name === 'themes') renderView('themes');
  }
  
  async function renderView(viewName, params = {}) {
    // *** تحسين: التأكد من أن قاعدة البيانات مفتوحة قبل محاولة القراءة منها ***
    if (!isDbOpen) {
        console.log("Database not open yet, delaying renderView call...");
        // إذا لم تكن قاعدة البيانات مفتوحة، انتظر قليلاً ثم حاول مرة أخرى
        setTimeout(() => renderView(viewName, params), 100);
        return;
    }

    state.previousView = state.currentView; // *** إضافة: حفظ الواجهة الحالية قبل الانتقال ***
    state.currentView = { name: viewName, params };

    const currentView = mainContent.querySelector('.view-container');
    const transitionDuration = 250;

    // *** تحسين: إضافة try/catch لجلب البيانات لمعالجة أي أخطاء محتملة ***
    try {
        // Re-fetch data that might have changed, ensuring views are always fresh
        state.workers = await db.workers.toArray();
        state.projects = await db.projects.toArray();
        state.suppliers = await db.suppliers.toArray();
        state.notes = await db.notes.toArray();
        state.projectPayments = await db.projectPayments.toArray();
        state.inventory = await db.inventory.toArray();
        state.calendarEvents = await db.calendarEvents.toArray();
        state.expenses = await db.expenses.toArray();
        state.companyProfiles = await db.companyProfiles.toArray();
        state.clients = await db.clients.toArray();
        state.api_configs = await db.api_configs.toArray();
    } catch (error) {
        console.error("Error fetching data in renderView:", error);
        mainContent.innerHTML = `<div class="view-container"><p style="color: #ef4444; text-align: center;">حدث خطأ أثناء تحميل بيانات الواجهة.</p></div>`;
        return; // إيقاف التنفيذ إذا فشل جلب البيانات
    }

    const renderNewContent = async () => {
        mainContent.innerHTML = '';
        let content = '';

        switch(viewName) {
            case 'home':          content = getHomeView(); break; 
            case 'projects':      content = getProjectsView(); break;
            case 'workers':       content = getWorkersView(); break;
            case 'project-details': content = getProjectDetailsView(params.id); break;
            case 'suppliers':     content = getSuppliersView(); break;
            case 'settings':      content = getSettingsView(); break;
            case 'clients':       content = getClientsView(); break;
            case 'reports':       content = getReportsView(); break;
            case 'more_features': content = getMoreFeaturesView(); break; 
            case 'calendar':      content = getCalendarView(); break;
            case 'expenses':      content = getExpensesView(); break;
            case 'inventory':     content = getInventoryView(); break;
            case 'ai_assistant':  content = getAiAssistantView(); break;
            case 'notes':         content = getNotesView(); break;
            case 'worker-details':content = getWorkerDetailsView(params.id); break;
            case 'my_info':       content = getMyInfoView(); break;
            case 'profile-details': content = getProfileDetailsView(params.id); break;
            case 'expense-details': content = getExpenseDetailsView(params.id); break;
            case 'api_settings':  content = getApiSettingsView(); break;
            case 'factory_reset': content = getFactoryResetView(); break;
            case 'themes':        content = getThemesView(); break;
            case 'about':         content = getAboutView(); break;
            case 'supplier-details': content = getSupplierDetailsView(params.id); break;
            case 'client-details': content = getClientDetailsView(params.id); break;
            case 'inventory-details': content = getInventoryItemDetailsView(params.id); break;
            default:              content = `<h3>View Not Found: ${viewName}</h3>`;
        } 
        
        mainContent.innerHTML = `<div class="view-container">${content}</div>`;
        
        if (viewName === 'settings') {
            document.getElementById('navigateToApiSettings')?.addEventListener('click', () => renderView('api_settings'));
            document.getElementById('navigateToThemes')?.addEventListener('click', () => renderView('themes'));
            document.getElementById('navigateToFactoryReset')?.addEventListener('click', () => renderView('factory_reset'));
        }
        if (viewName === 'api_settings') {
            document.getElementById('addApiConfigBtn')?.addEventListener('click', () => openApiConfigModal());
            mainContent.querySelectorAll('[data-action="toggle-api-active"]').forEach(toggle => toggle.addEventListener('change', (e) => toggleActiveApi(parseInt(e.currentTarget.dataset.id))));
        }
        if (viewName === 'workers') {
            document.getElementById('addWorkerBtn')?.addEventListener('click', () => openWorkerModal());
            mainContent.querySelectorAll('[data-action="view-worker"]').forEach(card => card.addEventListener('click', (e) => renderView('worker-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'projects') {
            document.getElementById('addProjectBtn')?.addEventListener('click', () => openProjectModal());
            mainContent.querySelectorAll('[data-action="view-project"]').forEach(card => card.addEventListener('click', (e) => renderView('project-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'project-details') {
            document.getElementById('backToProjects')?.addEventListener('click', () => renderView('projects'));
            document.getElementById('editProjectBtn')?.addEventListener('click', (e) => openProjectModal(parseInt(e.currentTarget.dataset.id)));
            // *** إضافة: ربط زر تحليل المشروع بالذكاء الاصطناعي ***
            document.getElementById('analyzeProjectBtn')?.addEventListener('click', (e) => handleAnalysisRequest('project', parseInt(e.currentTarget.dataset.id)));
            // Use event delegation for buttons inside tabs
            mainContent.addEventListener('click', e => {
                const addExpenseBtn = e.target.closest('#addExpenseForProjectBtn');
                const addPaymentBtn = e.target.closest('#addProjectPaymentBtn');
                const tabButton = e.target.closest('.tab-card'); // *** تحسين: التبديل باستخدام البطاقات الجديدة ***
                if (addExpenseBtn) openExpenseModal(null, { projectId: parseInt(addExpenseBtn.dataset.id) });
                // *** إضافة: ربط زر "عرض الكل" بالنافذة المنبثقة ***
                const showAllFinanceBtn = e.target.closest('#showAllFinanceBtn');
                if (showAllFinanceBtn) {
                    openProjectFullFinanceModal(parseInt(showAllFinanceBtn.dataset.id));
                }

                // *** إضافة: ربط زر "عرض كل الدفعات" بالنافذة المنبثقة الجديدة ***
                // *** إصلاح: التأكد من وجود الزر قبل استدعاء الدالة وتصحيح الدالة المستدعاة ***
                const showAllPaymentsBtn = e.target.closest('#showAllPaymentsBtn');
                // *** إصلاح: التأكد من أن dataset موجود قبل استخدامه ***
                if (showAllPaymentsBtn && showAllPaymentsBtn.dataset.id) {
                    openAllPaymentsModal(parseInt(showAllPaymentsBtn.dataset.id));
                }

                // *** إضافة: ربط زر "عرض كل النفقات" بالنافذة المنبثقة الجديدة ***
                const showAllExpensesBtn = e.target.closest('#showAllExpensesBtn');
                if (showAllExpensesBtn && showAllExpensesBtn.dataset.id) {
                    openAllExpensesModal(parseInt(showAllExpensesBtn.dataset.id));
                }

                if (addPaymentBtn) openProjectPaymentModal(null, parseInt(addPaymentBtn.dataset.id));
                if (tabButton) switchProjectTab(tabButton.dataset.tab);
            });
        }
        if (viewName === 'worker-details') {
            document.getElementById('editWorkerBtn')?.addEventListener('click', (e) => openWorkerModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('addWorkDayBtn')?.addEventListener('click', () => openActivityModal('attendance'));
            document.getElementById('analyzeWorkerBtn')?.addEventListener('click', (e) => handleAnalysisRequest('worker', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('addBonusBtn')?.addEventListener('click', () => openActivityModal('bonus'));
            document.getElementById('addDeductionBtn')?.addEventListener('click', () => openActivityModal('deduction'));
            mainContent.querySelectorAll('.delete-activity').forEach(btn => btn.addEventListener('click', handleDeleteActivity));
            document.getElementById('backToWorkers')?.addEventListener('click', () => renderView('workers'));
            document.getElementById('settleMonthBtn')?.addEventListener('click', (e) => handleSettleMonth(parseInt(e.currentTarget.dataset.workerId), parseInt(e.currentTarget.dataset.year), parseInt(e.currentTarget.dataset.month)));
            document.getElementById('printReportBtn')?.addEventListener('click', (e) => printWorkerReport(e.currentTarget.dataset.id));
            document.getElementById('showFullLogBtn')?.addEventListener('click', (e) => openFullActivityLog(e.currentTarget.dataset.id));
        }
        if (viewName === 'supplier-details') {
            document.getElementById('editSupplierBtn')?.addEventListener('click', (e) => openSupplierModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeSupplierBtn')?.addEventListener('click', (e) => handleAnalysisRequest('supplier', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('backToSuppliers')?.addEventListener('click', () => renderView('suppliers'));
        }
        if (viewName === 'suppliers') {
            document.getElementById('addSupplierBtn')?.addEventListener('click', () => openSupplierModal());
            mainContent.querySelectorAll('[data-action="view-supplier"]').forEach(card => card.addEventListener('click', (e) => renderView('supplier-details', { id: parseInt(e.currentTarget.dataset.id) })));

        }
        if (viewName === 'notes') {
            mainContent.querySelectorAll('.note-card').forEach(card => card.addEventListener('click', (e) => openNoteModal(parseInt(e.currentTarget.dataset.id))));
            mainContent.querySelectorAll('[data-action="analyze-note"]').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleAnalysisRequest('note', parseInt(e.currentTarget.dataset.id)); }));
            setupInlineNoteForm();
        }
        if (viewName === 'inventory') {
            document.getElementById('addInventoryBtn')?.addEventListener('click', () => openInventoryModal());
            mainContent.querySelectorAll('[data-action="view-inventory-item"]').forEach(card => card.addEventListener('click', (e) => renderView('inventory-details', { id: parseInt(e.currentTarget.dataset.id) })));
            mainContent.querySelectorAll('[data-action="analyze-inventory-item"]').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleAnalysisRequest('inventory', parseInt(e.currentTarget.dataset.id)); }));
        }
        if (viewName === 'inventory-details') {
            document.getElementById('editInventoryBtn')?.addEventListener('click', (e) => openInventoryModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeInventoryBtn')?.addEventListener('click', (e) => handleAnalysisRequest('inventory', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('lendItemBtn')?.addEventListener('click', (e) => openLendModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('returnItemBtn')?.addEventListener('click', (e) => handleReturnItem(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('backToInventory')?.addEventListener('click', () => renderView('inventory'));
        }
        if (viewName === 'calendar') {
            document.getElementById('addEventBtn')?.addEventListener('click', () => openEventModal());
            // Open details modal instead of edit modal directly
            mainContent.querySelectorAll('.calendar-event, [data-action=\"view-event-details\"]').forEach(el => el.addEventListener('click', (e) => {
                openEventDetailsModal(parseInt(e.currentTarget.dataset.id));
            }));
        }
        if (viewName === 'expenses') {
            document.getElementById('addExpenseBtn')?.addEventListener('click', () => openExpenseModal());
            mainContent.querySelectorAll('[data-action="view-expense"]').forEach(card => card.addEventListener('click', (e) => renderView('expense-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'expense-details') {
            document.getElementById('backToExpenses')?.addEventListener('click', () => renderView('expenses'));
            document.getElementById('editExpenseBtn')?.addEventListener('click', (e) => openExpenseModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeExpenseBtn')?.addEventListener('click', (e) => handleAnalysisRequest('expense', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('printExpenseBtn')?.addEventListener('click', (e) => printExpenseReport(parseInt(e.currentTarget.dataset.id)));
        }
        if (viewName === 'my_info') {
            document.getElementById('addProfileBtn')?.addEventListener('click', () => openProfileModal());
            mainContent.querySelectorAll('[data-action="view-profile"]').forEach(card => card.addEventListener('click', (e) => renderView('profile-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'profile-details') {
            document.getElementById('backToProfiles')?.addEventListener('click', () => renderView('my_info'));
            document.getElementById('editProfileBtn')?.addEventListener('click', (e) => openProfileModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeProfileBtn')?.addEventListener('click', (e) => handleAnalysisRequest('profile', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('saveProfileAsImageBtn')?.addEventListener('click', (e) => saveProfileAsImage(parseInt(e.currentTarget.dataset.id)));
        }
        if (viewName === 'about') {
            // No specific listeners needed for the about page for now
        }
        if (viewName === 'ai_assistant') {
            setupAiAssistantListeners();
        }
        if (viewName === 'factory_reset') {
            document.getElementById('factoryResetBtn')?.addEventListener('click', handleFactoryReset);
        }
        if (viewName === 'client-details') {
            document.getElementById('editClientBtn')?.addEventListener('click', (e) => openClientModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('backToClients')?.addEventListener('click', () => renderView('clients'));
        }
        if (viewName === 'themes') {
            mainContent.querySelectorAll('.theme-card').forEach(card => card.addEventListener('click', async (e) => {
                await applyThemeSet(e.currentTarget.dataset.theme);
                renderView('themes'); // Re-render to show the active state
            }));
        }
    };

    const previouslyActiveNavItem = mainNav.querySelector('.nav-item.active');
    const isNewView = !previouslyActiveNavItem || previouslyActiveNavItem.dataset.view !== viewName;

    const isMainNavItem = [...mainNav.querySelectorAll('.nav-item')].some(item => item.dataset.view === viewName);
    if(isMainNavItem) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === viewName);
        });
    }


    if (currentView && isNewView) {
        currentView.classList.add('is-exiting');
        setTimeout(renderNewContent, transitionDuration);
    } else {
        renderNewContent();
    }
  }

  /**
   * Displays a temporary toast notification.
   * @param {string} message The message to display.
   */
  function showToast(message) {
      showCustomToast(message, 'success');
  }

  function showCustomToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      
      if (type === 'error') toast.classList.add('error');
      container.appendChild(toast);

      setTimeout(() => { toast.remove(); }, 3000);
  }
  // --- View Content Generators ---
  function createCardHTML(m) {
    return `
      <div class="card" data-key="${m.key}">
        <div class="icon" style="background:${m.color}"><i class="fas ${m.icon}"></i></div>
        <div>
          <div style="font-weight:900; font-size: 16px;">${m.title}</div>
          <div style="color:var(--muted); font-size:13px; margin-top: 4px;">${m.description}</div>
        </div>
      </div>
    `;
  }

  function getHomeView() {
    // Calculate total expenses paid to all workers
    const totalWorkerExpenses = state.workers.reduce((total, worker) => {
        const workerTotalPaid = (worker.payments || []).reduce((sum, payment) => sum + payment.amount, 0);
        return total + workerTotalPaid;
    }, 0);
    const activeWorkers = state.workers.length;
    const mainGridHTML = appModules.map(createCardHTML).join('');

    return `
      <section class="hero" aria-label="لوحة التحكم">
        <div>
          <h2 style="margin:0;font-weight:800">أهلاً بك</h2>
          <p style="margin:6px 0 0;opacity:.95">نظرة سريعة على أعمالك الحالية.</p>
        </div>
        <div class="kpis" style="margin-top:12px">
            <div class="kpi">
                <div style="font-size:18px;font-weight:800">${totalWorkerExpenses.toLocaleString()} د.ج</div>
                <div style="font-size:12px;opacity:.9">إجمالي المصاريف</div>
            </div>
            <div class="kpi">
                <div style="font-size:18px;font-weight:800">${activeWorkers}</div>
                <div style="font-size:12px;opacity:.9">العمال النشطين</div>
            </div>
        </div>
      </section>
      <div class="grid-cards">${mainGridHTML}</div>
    `;
  }

  function getMoreFeaturesView() {
    const subModulesHTML = subModules.map(createCardHTML).join('');
    
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">ميزات إضافية</h3>
            <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة للرئيسية</button>
        </div>
        <div class="grid-cards" style="margin-top:0;">
            ${subModulesHTML}
        </div>
    `;
  }
  
  function getProjectsView() { 
    const projectsListHTML = state.projects && state.projects.length > 0
        ? state.projects.map(project => {
            const statusStyles = {
                active: { text: 'نشط', bg: '#10b981', gradient: 'linear-gradient(135deg, #10b981, #059669)' },
                completed: { text: 'منتهي', bg: '#6366f1', gradient: 'linear-gradient(135deg, #6366f1, #4f46e5)' },
                default: { text: 'منتهي ', bg: '#64748b', gradient: 'linear-gradient(135deg, #64748b, #475569)' }
            };
            const status = project.status || 'active';
            const style = statusStyles[status] || statusStyles.default;
            return `
            <div class="card" data-action="view-project" data-id="${project.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#06b6d4,#0284c7); font-size: 20px; margin-bottom: 0;"><i class="fas fa-hard-hat"></i></div>
                    <div>
                        <div style="font-weight: 700;">${project.name}</div>
                        <div class="status-badge" style="background: ${style.gradient}; display: inline-block; margin-top: 6px; font-size: 11px;">${style.text}</div>
                    </div>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 700; font-size: 15px; color: var(--primary);">${(project.budget || 0).toLocaleString()} د.ج</div>
                    <div style="font-size: 12px; color: var(--muted);">الميزانية</div>
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي مشاريع بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">إدارة المشاريع</h3>
            <div>
                <button id="addProjectBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة مشروع</button>
                <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${projectsListHTML}
    `;
  }
  
  function getSuppliersView() {
    const suppliersListHTML = state.suppliers && state.suppliers.length > 0
        ? state.suppliers.map(supplier => `
            <div class="card" data-action="view-supplier" data-id="${supplier.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${supplier.imageUrl
                        ? `<img src="${supplier.imageUrl}" alt="${supplier.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#10b981,#059669); font-size: 20px; margin-bottom: 0;"><i class="fas fa-truck"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${supplier.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${supplier.specialty || 'لا يوجد تخصص'}</div>
                    </div>
                </div>
                <div style="text-align: left; font-size: 14px; color: var(--muted); direction: ltr;">${supplier.phone || ''}</div>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي موردين بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">قائمة الموردين</h3>
            <div>
                <button id="addSupplierBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة مورد</button>
                <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${suppliersListHTML}
    `;
  }

  function getSupplierDetailsView(supplierId) {
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (!supplier) return `<p>لم يتم العثور على المورد.</p><button onclick="renderView('suppliers')">العودة</button>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تفاصيل المورد</h3>
            <button id="backToSuppliers" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${supplier.imageUrl
                    ? `<img src="${supplier.imageUrl}" alt="${supplier.name}" style="width:64px; height:64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                    : `<div class="icon" style="width:64px; height:64px; background: linear-gradient(135deg,#10b981,#059669); font-size: 28px; margin-bottom: 0; flex-shrink: 0;"><i class="fas fa-truck"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 20px;">${supplier.name}</h2>
                    <p style="margin: 0; color: var(--muted); font-size: 14px;">${supplier.specialty || 'تخصص غير محدد'}</p>
                </div>
                <button id="editSupplierBtn" data-id="${supplier.id}" class="btn ghost" style="align-self: flex-start;"><i class="fas fa-edit"></i></button>
                <button id="analyzeSupplierBtn" data-id="${supplier.id}" class="btn ghost" style="align-self: flex-start; color: #0ea5e9; border-color: #0ea5e9; margin-right: 8px;"><i class="fas fa-robot"></i></button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size:13px; color:var(--muted);">رقم الهاتف</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; text-align: right;">${supplier.phone || 'غير متوفر'}</div>
                </div>
                ${supplier.phone ? `
                <a href="tel:${supplier.phone}" class="btn" style="background-color: #10b981; padding: 10px 16px; font-size: 15px;">
                    <i class="fas fa-phone" style="margin-left: 8px;"></i> اتصال
                </a>` : ''}
            </div>

            ${supplier.notes ? `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 16px;">
                <div style="font-size:13px; color:var(--muted);">ملاحظات</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${supplier.notes}</div>
            </div>
            ` : ''}
        </div>
    `;
  }

  function getWorkersView() {
    const workersListHTML = state.workers && state.workers.length > 0
        ? state.workers.map(worker => {
            const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
            const balance = totalDue - totalPaid;
            const workerColor = 'linear-gradient(135deg,#f97316,#f59e0b)';
            return `
            <div class="card" data-action="view-worker" data-id="${worker.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${worker.imageUrl
                        ? `<img src="${worker.imageUrl}" alt="${worker.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: ${workerColor}; font-size: 20px; margin-bottom: 0;"><i class="fas fa-user"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${worker.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${worker.phone || 'لا يوجد رقم هاتف'}</div>
                    </div>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 700; font-size: 15px; color: ${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
                    <div style="font-size: 12px; color: var(--muted);">الرصيد الحالي</div>
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي عمال بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">سجل العمال</h3>
            <div>
                <button id="addWorkerBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة عامل</button>
                <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${workersListHTML}
    `;
  }

  function getWorkerDetailsView(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return `<p>لم يتم العثور على العامل.</p><button id="backToWorkers">العودة</button>`;

    // For calendar
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;

    const { totalDue, totalPaid, presentDays, absentDays } = calculateWorkerFinancials(worker, currentYear, currentMonth);
    const balance = totalDue - totalPaid;

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    // --- Settlement Card Logic ---
    const settlementKey = `${currentYear}-${currentMonth}`;
    const isSettled = (worker.settlements || []).includes(settlementKey);
    let settlementCardHTML = '';
    if (isSettled) {
        settlementCardHTML = `
            <div class="card" style="background-color: rgba(34, 197, 94, 0.1); color: #15803d; flex-direction: row; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; cursor: default; transform: none;">
                <i class="fas fa-check-circle"></i>
                <span style="font-weight: 700;">تمت تسوية هذا الشهر بنجاح</span>
            </div>
        `; // The card should only appear if the balance is positive AND we are at or after the end of the month being viewed.
    } else if (balance > 0 && new Date() >= new Date(currentYear, currentMonth + 1, 0)) {
        settlementCardHTML = `
            <div class="settlement-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 800; font-size: 16px;">تسوية راتب الشهر</div>
                        <div style="opacity: 0.9; font-size: 14px;">الرصيد المتبقي: <strong>${balance.toLocaleString()} د.ج</strong></div>
                    </div>
                    <button id="settleMonthBtn" data-worker-id="${worker.id}" data-year="${currentYear}" data-month="${currentMonth}" class="btn" style="background: white; color: var(--accent);">تأكيد الدفع الكامل</button>
                </div>
            </div>`;
    }

    const calendarHTML = generateCalendar(currentMonth, currentYear, worker.attendance || []);
    const activityLogHTML = generateActivityLog(worker, 2, currentYear, currentMonth); // Show only 2 items from the current month

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">${worker.name}</h3>
            <div>
                <button id="analyzeWorkerBtn" data-id="${worker.id}" class="btn ghost" style="margin-left:8px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                <button id="editWorkerBtn" data-id="${worker.id}" class="btn ghost" style="margin-left:8px;"><i class="fas fa-edit"></i></button>
                <button id="printReportBtn" data-id="${worker.id}" class="btn ghost" style="margin-left:8px;"><i class="fas fa-print"></i></button>
                <button id="backToWorkers" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top:0; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;" title="مستحقات هذا الشهر فقط">
                <div style="font-size:13px; color:var(--muted);">إجمالي المستحقات</div>
                <div style="font-weight:800; font-size:18px; color:var(--primary);">${totalDue.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">اجمالي الخصومات</div>
                <div style="font-weight:800; font-size:18px; color:#f97316;">${totalPaid.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">الرصيد المتبقي</div>
                <div style="font-weight:800; font-size:18px; color:${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('worker-details', {id: ${workerId}, month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('worker-details', {id: ${workerId}, month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">›</button>
            </div>
            <div class="calendar">
                ${['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'].map(d => `<div class="calendar-header">${d}</div>`).join('')}
                ${calendarHTML}
            </div>
        </div>

        <!-- Settlement Card -->
        ${settlementCardHTML}

        <!-- Actions & Activity Log -->
        <div style="margin-bottom: 16px; display:flex; gap:10px;">
            <button id="addWorkDayBtn" class="btn" style="flex:1; background-color:#10b981;"><i class="fas fa-calendar-check" style="margin-left:6px;"></i> يوم عمل</button>
            <button id="addBonusBtn" class="btn" style="flex:1; background-color:#3b82f6;"><i class="fas fa-star" style="margin-left:6px;"></i> مكافأة</button>
            <button id="addDeductionBtn" class="btn" style="flex:1; background-color:#8b5cf6;"><i class="fas fa-hand-holding-usd" style="margin-left:6px;"></i> خصم</button>
        </div>
        
        <h4 style="margin: 24px 0 12px; font-weight:700;">أنشطة الشهر</h4>
        <div id="shortActivityLog">
            ${activityLogHTML}
        </div>
        <button id="showFullLogBtn" data-id="${worker.id}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);">عرض السجل الكامل</button>
  `;
  }

  function generateCalendar(month, year, attendance) {
    let calendarHTML = '';
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Add empty cells for days before the 1st of the month
    for (let i = 0; i < firstDay; i++) {
        calendarHTML += `<div class="calendar-day not-in-month"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const record = attendance.find(a => a.date === dateStr);
        const statusClass = record ? record.status : ''; // 'present' or 'absent'
        calendarHTML += `<div class="calendar-day ${statusClass}">${day}</div>`;
    }
    return calendarHTML;
  }

  function generateActivityLog(worker, limit = null, year = null, month = null, format = 'html') {
    let combined = [
        ...(worker.attendance || []).map(a => ({ ...a, type: 'attendance' })),
        ...(worker.payments || []).map(p => ({ ...p, type: p.type || 'payment' })), // Ensure backward compatibility
        ...(worker.bonuses || []).map(b => ({ ...b, type: 'bonus' }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    if (year !== null && month !== null) {
        combined = combined.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getFullYear() === year && itemDate.getMonth() === month;
        });
    }

    const itemsToRender = limit ? combined.slice(0, limit) : combined;

    if (itemsToRender.length === 0) {
        return format === 'html' ? `<p style="text-align:center; color:var(--muted);">لا توجد أنشطة مسجلة.</p>` : 'لا توجد أنشطة مسجلة.';
    }

    if (format === 'text') {
        return itemsToRender.map(item => {
            const date = new Date(item.date).toLocaleDateString('ar-DZ');
            if (item.type === 'attendance') return `${date}: ${item.status === 'present' ? `حضور (أجرة ${item.dailyRate || 0})` : 'غياب'}.`;
            if (item.type === 'bonus') return `${date}: مكافأة (${item.amount}) - ${item.note || ''}.`;
            if (item.type === 'deduction') return `${date}: خصم (${item.amount}) - ${item.note || ''}.`;
            return '';
        }).join('\n');
    }

    return itemsToRender.map((item, index) => {
        const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(item.date));
        if (item.type === 'attendance') {
            const isPresent = item.status === 'present';
            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${isPresent ? '#16a34a' : '#ef4444'}; background: ${isPresent ? 'rgba(34,197,94,.1)' : 'rgba(239,68,68,.1)'};">
                        <i class="fas ${isPresent ? 'fa-check' : 'fa-times'}"></i>
                    </div>
                    <div>
                        <div style="font-weight:500;">${isPresent ? `يوم عمل - ${(item.dailyRate || 0).toLocaleString()} د.ج` : 'غياب'}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                    </div>
                </div>
                <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="attendance" title="حذف">&times;</button>
            </div>`
        } else { // Payment or Deduction
            const isDeduction = item.type === 'deduction';
            const title = `خصم / مصاريف: ${item.amount.toLocaleString()} د.ج`;
            const iconClass = isDeduction ? 'fa-hand-holding-usd' : 'fa-money-bill-wave';
            const iconColor = isDeduction ? '#8b5cf6' : '#f97316';
            const iconBg = isDeduction ? 'rgba(139,92,246,.1)' : 'rgba(249,115,22,.1)';

            if (item.type === 'bonus') {
                return `
                <div class="activity-log-item">
                    <div style="display:flex; align-items:center;">
                        <div class="icon" style="color: #3b82f6; background: rgba(59,130,246,.1);"><i class="fas fa-star"></i></div>
                        <div>
                            <div style="font-weight:500;">مكافأة: ${item.amount.toLocaleString()} د.ج</div>
                            <div style="font-size:13px; color:var(--muted);">${date}</div>
                            ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                        </div>
                    </div>
                    <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="bonus" title="حذف">&times;</button>
                </div>`;
            }

            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${iconColor}; background: ${iconBg};"><i class="fas ${iconClass}"></i></div>
                    <div>
                        <div style="font-weight:500;">${title}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                        ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                    </div>
                </div>
                <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="${item.type}" title="حذف">&times;</button>
            </div>`;
        }
    }).join('');
  }

  function calculateWorkerFinancials(worker, year = null, month = null) {
    const filterByMonth = (item) => {
        // If year or month is null, we want the total, so we include all items.
        if (year === null || month === null) return true; 
        const itemDate = new Date(item.date);
        return itemDate.getFullYear() === year && itemDate.getMonth() === month;
    };

    // Use different variable names to avoid confusion
    const relevantAttendance = (worker.attendance || []).filter(filterByMonth);
    const relevantBonuses = (worker.bonuses || []).filter(filterByMonth);
    const relevantPayments = (worker.payments || []).filter(filterByMonth);

    const presentDays = relevantAttendance.filter(a => a.status === 'present').length;
    const absentDays = relevantAttendance.filter(a => a.status === 'absent').length;
    
    const earningsFromWork = relevantAttendance.filter(a => a.status === 'present').reduce((sum, day) => sum + (day.dailyRate || 0), 0);
    const totalBonuses = relevantBonuses.reduce((sum, b) => sum + b.amount, 0);
    const totalDue = earningsFromWork + totalBonuses;
    const totalPaid = relevantPayments.reduce((sum, p) => sum + p.amount, 0);

    return { totalDue, totalPaid, presentDays, absentDays };
  }

  function getClientsView() {
    const clientsListHTML = state.clients && state.clients.length > 0
        ? state.clients.map(client => {
            const projectsCount = state.projects.filter(p => p.clientId === client.id).length;
            return `
            <div class="card" data-action="view-client" data-id="${client.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px; flex-grow: 1;">
                    ${client.imageUrl
                        ? `<img src="${client.imageUrl}" alt="${client.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#2563eb,#3b82f6); font-size: 20px; margin-bottom: 0;"><i class="fas fa-user-tie"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${client.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${projectsCount > 0 ? `${projectsCount} مشروع مرتبط` : 'لا توجد مشاريع'}</div>
                    </div>
                </div>
                ${client.phone ? `<a href="tel:${client.phone}" onclick="event.stopPropagation()" class="btn ghost" style="padding: 6px 10px; flex-shrink: 0;"><i class="fas fa-phone"></i></a>` : ''}
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي عملاء بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">إدارة العملاء</h3>
            <div>
                <button id="addClientBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة عميل</button>
                <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${clientsListHTML}
    `;
  }

  function getClientDetailsView(clientId) {
    const client = state.clients.find(c => c.id === clientId);
    if (!client) return `<p>لم يتم العثور على العميل.</p><button id="backToClients">العودة</button>`;

    const clientProjects = state.projects.filter(p => p.clientId === clientId);
    const projectsHTML = clientProjects.length > 0
        ? clientProjects.map(p => `<div class="activity-log-item" style="cursor: pointer;" onclick="renderView('project-details', {id: ${p.id}})">${p.name}</div>`).join('')
        : `<p style="text-align:center; color:var(--muted);">لا توجد مشاريع مرتبطة بهذا العميل.</p>`;


    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تفاصيل العميل</h3>
            <button id="backToClients" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${client.imageUrl
                    ? `<img src="${client.imageUrl}" alt="${client.name}" style="width:64px; height:64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                    : `<div class="icon" style="width:64px; height:64px; background: linear-gradient(135deg,#2563eb,#3b82f6); font-size: 28px; margin-bottom: 0; flex-shrink: 0;"><i class="fas fa-user-tie"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 20px;">${client.name}</h2>
                    <p style="margin: 0; color: var(--muted); font-size: 14px;">${client.email || 'لا يوجد بريد إلكتروني'}</p>
                </div>
                <button id="editClientBtn" data-id="${client.id}" class="btn ghost" style="align-self: flex-start;"><i class="fas fa-edit"></i></button>
            </div>
            
            <div class="grid-cards" style="grid-template-columns: 1fr 1fr; margin-top: 0; margin-bottom: 16px;">
                ${client.phone ? `
                    <a href="tel:${client.phone}" class="btn" style="background-color: #10b981; text-decoration: none;">
                        <i class="fas fa-phone" style="margin-left: 8px;"></i> اتصال
                    </a>` : ''}
                ${client.email ? `
                    <a href="mailto:${client.email}" class="btn" style="background-color: #3b82f6; text-decoration: none;">
                        <i class="fas fa-envelope" style="margin-left: 8px;"></i> إيميل
                    </a>` : ''}
            </div>

            ${client.address || client.notes ? `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 12px;">
                ${client.address ? `
                    <div>
                        <div style="font-size:13px; color:var(--muted);">العنوان</div>
                        <div style="font-weight:500; font-size:15px; margin-top: 4px;">${client.address}</div>
                    </div>
                ` : ''}
                ${client.notes ? `
                    <div style="${client.address ? 'margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);' : ''}">
                        <div style="font-size:13px; color:var(--muted);">ملاحظات</div>
                        <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${client.notes}</div>
                    </div>
                ` : ''}
            </div>` : ''}
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">المشاريع المرتبطة</h4>
        <div id="clientProjectsList">
            ${projectsHTML}
        </div>
    `;
  }

  function getProjectDetailsView(projectId) {
    const activeTab = state.currentView.params.tab || 'overview';
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return `<p>لم يتم العثور على المشروع.</p><button id="backToProjects">العودة</button>`;


    const client = project.clientId ? state.clients.find(c => c.id === project.clientId) : null;
    
    // Financial Calculations
    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);
    const totalReceived = clientPayments.reduce((sum, p) => sum + p.amount, 0);
    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);
    // *** تحسين: حساب إجمالي النفقات المدفوعة فقط ***
    const totalExpenses = projectExpenses.filter(e => e.paymentStatus === 'paid').reduce((sum, e) => sum + e.amount, 0);
    // *** تحسين: تعديل الحسابات المالية حسب الطلب الجديد ***
    const budget = project.budget || 0;
    // *** إضافة: حساب "المتبقي على العميل" و "الرصيد الصافي" ***
    const remainingFromClient = budget - totalReceived;
    const netBalance = totalReceived - totalExpenses; // هذا هو الربح/الخسارة
    const budgetExceeded = totalExpenses > budget;

    // *** إضافة: إنشاء رسالة تحذير عند تجاوز الميزانية ***
    const budgetWarningHTML = budgetExceeded ? `
        <div style="background-color: rgba(239, 68, 68, 0.1); color: #dc2626; padding: 10px 15px; border-radius: 8px; text-align: center; font-weight: 700; margin-bottom: 16px;">
            <i class="fas fa-exclamation-triangle" style="margin-left: 8px;"></i>
            تحذير: تم تجاوز الميزانية بمبلغ ${(totalExpenses - budget).toLocaleString()} د.ج
        </div>
    ` : '';

    const overviewTabContent = `
        <!-- *** تحسين: إعادة تصميم بطاقات الملخص المالي لعرض 5 قيم *** -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top:16px; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">الميزانية التقديرية</div>
                <div style="font-weight:800; font-size:18px; color:var(--primary);">${budget.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">المبلغ المستلم</div>
                <div style="font-weight:800; font-size:18px; color:#10b981;">${totalReceived.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">إجمالي النفقات</div>
                <div style="font-weight:800; font-size:18px; color:${budgetExceeded ? '#ef4444' : '#f97316'};">${totalExpenses.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">المتبقي على العميل</div>
                <div style="font-weight:800; font-size:18px; color:${remainingFromClient >= 0 ? 'var(--muted)' : '#ef4444'};">${remainingFromClient.toLocaleString()} د.ج</div>
            </div>
            <!-- *** إضافة: بطاقة جديدة لعرض الرصيد الصافي (الربح/الخسارة) *** -->
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1)); border-color: #a855f7;">
                <div style="font-size:13px; color:var(--muted);">الرصيد الصافي</div>
                <div style="font-weight:800; font-size:18px; color:${netBalance >= 0 ? '#a855f7' : '#ef4444'};">${netBalance.toLocaleString()} د.ج</div>
            </div>
        </div>
        <!-- *** إضافة: عرض معلومات صاحب المنزل وصاحب البناء *** -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; align-items: stretch; text-align: right; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">معلومات إضافية</h4>
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <div style="font-size:14px; color:var(--muted);">صاحب المنزل:</div>
                <div style="font-weight:700; font-size:16px;">${project.homeownerName || 'غير محدد'}</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <div style="font-size:14px; color:var(--muted);">صاحب البناء:</div>
                <div style="font-weight:700; font-size:16px;">${project.builderName || 'غير محدد'}</div>
            </div>
        </div>

        ${budgetWarningHTML}
    `;

    const paymentsListHTML = (limit) => clientPayments.slice(0, limit).map(p => `
        <!-- *** تحسين: عند الضغط يتم فتح نافذة التعديل/الحذف *** -->
        <div class="activity-log-item" style="cursor: pointer;" onclick="openProjectPaymentModal(${p.id}, ${projectId})">
            <div>
                <div style="font-weight: 700;">دفعة مستلمة من العميل</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(p.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #10b981;">+${p.amount.toLocaleString()} د.ج</div>
        </div>
    `).join('');

    const expensesListHTML = (limit) => projectExpenses.slice(0, limit).map(e => {
        const isMaterial = e.category === 'material';
        const icon = isMaterial ? 'fa-boxes' : 'fa-user-hard-hat';
        const linkedTo = e.supplierId ? state.suppliers.find(s => s.id === e.supplierId)?.name : (e.workerId ? state.workers.find(w => w.id === e.workerId)?.name : null);
        const paymentStatusHTML = isMaterial && e.paymentStatus === 'unpaid' ? `<span class="status-badge" style="background-color: #ef4444; font-size: 10px; margin-right: 8px;">غير مدفوع</span>` : '';

        return `
        <div class="activity-log-item" style="cursor: pointer;" onclick="renderView('expense-details', {id: ${e.id}})">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:36px; height:36px; font-size: 16px; margin:0; background: var(--bg); color: var(--muted);"><i class="fas ${icon}"></i></div>
                <div>
                    <div style="font-weight: 700; display: flex; align-items: center;">${paymentStatusHTML} ${e.description}</div>
                    ${linkedTo ? `<div style="font-size: 13px; color: var(--muted);"><i class="fas ${isMaterial ? 'fa-truck' : 'fa-user'}" style="margin-left: 4px;"></i> ${linkedTo}</div>` : ''}
                </div>
            </div>
            <div style="text-align: left;">
                <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${e.amount.toLocaleString()} د.ج</div>
                <div style="font-size: 12px; color: var(--muted);">${new Date(e.date).toLocaleDateString('ar-DZ')}</div>
            </div>
        </div>`;}).join('');

    // *** تحسين: عرض آخر 3 دفعات فقط وإضافة زر "عرض المزيد" ***
    const limitedPaymentsHTML = clientPayments.length > 0
        ? paymentsListHTML(3) + (clientPayments.length > 3 ? `<button id="showAllPaymentsBtn" data-id="${projectId}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);"><i class="fas fa-list-ul" style="margin-left: 8px;"></i> عرض الكل (${clientPayments.length})</button>` : '')
        : `<p style="text-align:center; color:var(--muted);">لم يتم تسجيل أي دفعات من العميل.</p>`;
    
    // *** تحسين: عرض آخر 3 نفقات فقط وإضافة زر "عرض المزيد" ***
    const limitedExpensesHTML = projectExpenses.length > 0
        // *** إضافة: زر "عرض الكل" للنفقات ***
        ? expensesListHTML(3) + (projectExpenses.length > 3 ? `<button id="showAllExpensesBtn" data-id="${projectId}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);"><i class="fas fa-list-ul" style="margin-left: 8px;"></i> عرض الكل (${projectExpenses.length})</button>` : '')
        : `<p style="text-align:center; color:var(--muted);">لا توجد نفقات مسجلة لهذا المشروع.</p>`;

    const financeTabContent = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 12px;">
            <h4 style="margin:0; font-weight:700;">الدفعات المستلمة من العميل</h4>
            <button id="addProjectPaymentBtn" data-id="${project.id}" class="btn" style="background-color:#10b981;"><i class="fas fa-plus" style="margin-left:6px;"></i> إضافة دفعة</button>
        </div>
        ${limitedPaymentsHTML}
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 24px 0 12px;">
            <h4 style="margin:0; font-weight:700;">نفقات المشروع</h4>
            <button id="addExpenseForProjectBtn" data-id="${project.id}" class="btn" style="background-color:#ef4444;"><i class="fas fa-plus" style="margin-left:6px;"></i> إضافة نفقة</button>
        </div>${limitedExpensesHTML} 
    `;

    // *** إضافة: زر "المشروع منتهي" يظهر فقط في حالة انتهاء المشروع ***
    const finishedProjectIndicatorHTML = project.status === 'finished'
        ? `<div class="card" style="cursor: pointer; transform: none; margin-top: 16px; background-color: rgba(34, 197, 94, 0.1);" id="reopenProjectBtn" data-id="${project.id}">
                <div style="color: #15803d; font-weight: 700; display: flex; align-items: center; gap: 8px;"><i class="fas fa-check-circle"></i> هذا المشروع منتهي (اضغط لإعادة التفعيل)</div>
           </div>` : '';

    // *** إضافة: إنشاء واجهة تبويب سجل الديون ***
    const unpaidExpenses = projectExpenses.filter(e => e.paymentStatus === 'unpaid');
    const debtsListHTML = unpaidExpenses.length > 0 ? unpaidExpenses.map(expense => {
        return `
            <!-- *** تحسين: عند الضغط يتم عرض تفاصيل النفقة (الدين) *** -->
            <div class="activity-log-item" style="cursor: pointer;" onclick="renderView('expense-details', {id: ${expense.id}})">
                <div>
                    <div style="font-weight: 700;">${expense.description}</div>
                    <div style="font-size: 13px; color: var(--muted);">${new Date(expense.date).toLocaleDateString('ar-DZ')}</div>
                </div>
                <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${expense.amount.toLocaleString()} د.ج</div>
            </div>
        `;
    }).join('') : `<p style="text-align:center; color:var(--muted);">لا توجد ديون مسجلة لهذا المشروع.</p>`;

    const debtsTabContent = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 12px;">
            <h4 style="margin:0; font-weight:700;">سجل الديون (نفقات غير مدفوعة)</h4>
        </div>
        ${debtsListHTML}
    `;

    return `
        <!-- *** تحسين: نقل زر التعديل للأعلى وتغيير تصميمه *** -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <div style="display: flex; align-items: center;">
                <h3 style="margin:0 0 4px; font-weight:800">${project.name}</h3>
                ${client ? `<div style="font-size: 14px; color: var(--muted); cursor: pointer;" onclick="renderView('client-details', {id: ${client.id}})">العميل: ${client.name}</div>` : ''}
            </div>
            <div>
                <!-- *** إضافة: زر جديد لتحليل المشروع بالذكاء الاصطناعي *** -->
                <button id="analyzeProjectBtn" data-id="${project.id}" class="btn ghost" style="margin-left: 8px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i> تحليل</button>
                <button id="editProjectBtn" data-id="${project.id}" class="btn ghost" style="margin-left: 8px; color: var(--primary); border-color: var(--primary);"><i class="fas fa-edit" style="margin-left:6px;"></i> تعديل</button>
                <button id="backToProjects" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة للمشاريع</button>
            </div>
        </div>

        <!-- *** تحسين: استخدام تصميم البطاقات الملونة للتبويبات *** -->
        <div class="tab-card-container">
            <div class="tab-card ${activeTab === 'overview' ? 'active' : ''}" data-tab="overview" style="background: linear-gradient(135deg, #64748b, #475569);"><i class="fas fa-chart-pie"></i><span>ملخص</span></div>
            <div class="tab-card ${activeTab === 'finance' ? 'active' : ''}" data-tab="finance" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-wallet"></i><span>المالية</span></div>
            <div class="tab-card ${activeTab === 'debts' ? 'active' : ''}" data-tab="debts" style="background: linear-gradient(135deg, #f97316, #ea580c);"><i class="fas fa-book"></i><span>سجل الديون</span></div>
        </div>

        <!-- Tab Content -->
        <div id="overviewTab" class="tab-content ${activeTab === 'overview' ? 'active' : ''}">${overviewTabContent}</div>
        <div id="financeTab" class="tab-content ${activeTab === 'finance' ? 'active' : ''}">${financeTabContent} ${finishedProjectIndicatorHTML}</div>
        <div id="debtsTab" class="tab-content ${activeTab === 'debts' ? 'active' : ''}">${debtsTabContent}</div>
    `;
}

  // *** إصلاح: تم نقل دوال المهام إلى هنا لضمان تعريفها قبل استخدامها ***
  function openTaskModal(taskId = null, projectId = null) {
      const modal = document.getElementById('taskModal');
      const form = document.getElementById('taskForm');
      const titleEl = document.getElementById('taskModalTitle');
      const deleteBtn = document.getElementById('deleteTaskBtn');
      const assignedToSelect = document.getElementById('taskAssignedTo');

      form.reset();
      deleteBtn.style.display = 'none';
      
      // If projectId is not passed, try to get it from the current view state
      const currentProjectId = projectId || state.currentView.params.id;
      document.getElementById('taskProjectId').value = currentProjectId;

      // تعبئة قائمة العمال
      assignedToSelect.innerHTML = state.workers.map(w => `<option value="${w.id}">${w.name}</option>`).join('');

      if (taskId) {
          const task = state.projectTasks.find(t => t.id === taskId);
          if (task) {
              titleEl.textContent = 'تعديل المهمة';
              document.getElementById('taskId').value = task.id;
              document.getElementById('taskTitle').value = task.title;
              document.getElementById('taskStatus').value = task.status;
              // تحديد العمال المسند إليهم
              (task.assignedTo || []).forEach(workerId => {
                  const option = assignedToSelect.querySelector(`option[value="${workerId}"]`);
                  if (option) option.selected = true;
              });
              deleteBtn.style.display = 'block';
          }
      } else {
          titleEl.textContent = 'إضافة مهمة جديدة';
          document.getElementById('taskId').value = '';
      }

      modal.style.display = 'flex';
  }

  function closeTaskModal() {
      document.getElementById('taskModal').style.display = 'none';
  }

  async function handleTaskFormSubmit(e) {
      e.preventDefault();
      try {
          const id = document.getElementById('taskId').value ? parseInt(document.getElementById('taskId').value) : null;
          const projectId = parseInt(document.getElementById('taskProjectId').value);
          
          const assignedTo = Array.from(document.getElementById('taskAssignedTo').selectedOptions).map(opt => parseInt(opt.value));

          const taskData = {
              projectId: projectId,
              title: document.getElementById('taskTitle').value,
              status: document.getElementById('taskStatus').value,
              assignedTo: assignedTo,
              createdAt: new Date().toISOString()
          };

          if (id) {
              await db.projectTasks.update(id, taskData);
          } else {
              await db.projectTasks.add(taskData);
          }
          closeTaskModal();
          await renderView('project-details', { id: projectId, tab: 'tasks' });
          showToast('تم حفظ المهمة بنجاح');
      } catch (error) {
          console.error('Error saving task:', error);
          showCustomToast('حدث خطأ أثناء حفظ المهمة', 'error');
      }
  }

  // *** إضافة: دالة لفتح نافذة عرض كل الدفعات ***
  function openAllPaymentsModal(projectId) {
    // إغلاق النوافذ الأخرى لتجنب التداخل
    document.getElementById('allExpensesModal').style.display = 'none';

    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);

    // *** تحسين: استخدام جدول احترافي لعرض الدفعات ***
    const allPaymentsHTML = clientPayments.length > 0 ? `
        <table class="professional-table">
            <thead>
                <tr>
                    <th class="icon-cell"></th>
                    <th>التاريخ</th>
                    <th>الوصف</th>
                    <th class="amount-col">المبلغ</th>
                </tr>
            </thead>
            <tbody>
                ${clientPayments.map(p => `
                    <tr onclick="openProjectPaymentModal(${p.id}, ${projectId})">
                        <td class="icon-cell"><i class="fas fa-hand-holding-usd"></i></td>
                        <td>${new Date(p.date).toLocaleDateString('ar-DZ')}</td>
                        <td>${p.notes || 'دفعة مستلمة'}</td>
                        <td class="amount-col positive">+${p.amount.toLocaleString()} د.ج</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    ` : '<p style="text-align:center; color:var(--muted);">لا توجد دفعات مسجلة.</p>';

    document.getElementById('allPaymentsContent').innerHTML = allPaymentsHTML;
    document.getElementById('allPaymentsModal').style.display = 'flex';
  }

  // *** إضافة: دالة لفتح نافذة عرض كل النفقات ***
  function openAllExpensesModal(projectId) {
    // إغلاق النوافذ الأخرى لتجنب التداخل
    document.getElementById('allPaymentsModal').style.display = 'none';

    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);

    // *** تحسين: استخدام جدول احترافي لعرض النفقات ***
    const allExpensesHTML = projectExpenses.length > 0 ? `
        <table class="professional-table">
            <thead><tr><th>التاريخ</th><th>الوصف</th><th class="amount-col">المبلغ</th></tr></thead>
            <tbody>
                ${projectExpenses.map(e => `
                    <!-- *** إصلاح: إضافة استدعاء لإغلاق النافذة عند النقر *** -->
                    <tr onclick="closeAllExpensesModal(); renderView('expense-details', {id: ${e.id}})">
                        <td>${new Date(e.date).toLocaleDateString('ar-DZ')}</td>
                        <td>${e.description}</td>
                        <td class="amount-col negative">-${e.amount.toLocaleString()} د.ج</td>
                    </tr>`).join('')}
            </tbody>
        </table>
    ` : '<p style="text-align:center; color:var(--muted);">لا توجد نفقات مسجلة.</p>';

    document.getElementById('allExpensesContent').innerHTML = allExpensesHTML;
    document.getElementById('allExpensesModal').style.display = 'flex';
  }
  
  // *** إضافة: دالة لإغلاق نافذة عرض كل النفقات ***
  function closeAllExpensesModal() {
      document.getElementById('allExpensesModal').style.display = 'none';
  }


  // *** إضافة: دالة لفتح نافذة السجل المالي الكامل ***
  function openProjectFullFinanceModal(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);
    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);

    const paymentsHTML = clientPayments.length > 0 ? clientPayments.map(p => `
        <div class="activity-log-item" style="cursor: pointer;" onclick="openProjectPaymentModal(${p.id}, ${projectId})">
            <div>
                <div style="font-weight: 700;">دفعة مستلمة</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(p.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #10b981;">+${p.amount.toLocaleString()} د.ج</div>
        </div>`).join('') : '';

    const expensesHTML = projectExpenses.length > 0 ? projectExpenses.map(e => `
        <div class="activity-log-item" style="cursor: pointer;" onclick="renderView('expense-details', {id: ${e.id}})">
            <div>
                <div style="font-weight: 700;">${e.description}</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(e.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${e.amount.toLocaleString()} د.ج</div>
        </div>`).join('') : '';

    const fullLogHTML = `
        <h4 style="margin: 0 0 12px;">الدفعات المستلمة</h4>
        ${paymentsHTML || '<p style="text-align:center; color:var(--muted);">لا توجد دفعات.</p>'}
        <h4 style="margin: 24px 0 12px;">النفقات</h4>
        ${expensesHTML || '<p style="text-align:center; color:var(--muted);">لا توجد نفقات.</p>'}`;

    document.getElementById('projectFullFinanceContent').innerHTML = fullLogHTML;
    document.getElementById('projectFullFinanceModal').style.display = 'flex';

    // Attach listener to close other modals if they are open
    const allPaymentsModal = document.getElementById('allPaymentsModal');
    if (allPaymentsModal) allPaymentsModal.style.display = 'none';
  }


  function getCalendarView() {
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const eventTypes = {
        task: { text: 'مهمة', color: '#3b82f6' },
        appointment: { text: 'موعد', color: '#f59e0b' },
        delivery: { text: 'تسليم', color: '#10b981' },
        start_work: { text: 'بدء عمل', color: '#8b5cf6' }
    };

    let daysHTML = '';
    // Add empty cells for days before the 1st of the month
    for (let i = 0; i < firstDayOfMonth; i++) {
        daysHTML += `<div class="full-calendar-day not-in-month"></div>`;
    }

    // Add cells for each day of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(currentYear, currentMonth, day);
        const dateStr = currentDate.toISOString().split('T')[0];

        // Find events that are active on this day
        const dayEvents = state.calendarEvents.filter(event => {
            const startDate = new Date(event.startDate);
            const endDate = new Date(event.endDate);
            // Normalize dates to ignore time part
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);
            return currentDate >= startDate && currentDate <= endDate;
        });

        const eventsHTML = dayEvents.map(event => `
            <div class="calendar-event" data-action="view-event-details" data-id="${event.id}" style="background-color: ${eventTypes[event.type]?.color || '#64748b'};">
                ${event.title}
            </div>
        `).join('');

        daysHTML += `
            <div class="full-calendar-day">
                <div class="day-number">${day}</div>
                ${eventsHTML}
            </div>
        `;
    }

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">الجدول الزمني</h3>
            <div>
                <button id="addEventBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة حدث</button>
                <button onclick="renderView('more_features')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 16px; align-items: stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('calendar', {month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹ الشهر السابق</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('calendar', {month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">الشهر التالي ›</button>
            </div>

            <div class="full-calendar-grid">
                <!-- Headers -->
                ${['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(d => `<div class="full-calendar-header">${d}</div>`).join('')}
                
                <!-- Days -->
                ${daysHTML}
            </div>
        </div>
    `;
  }

  function getReportsView() { 
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تقارير سريعة (قيد الإنشاء)</h3>
            <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>`; 
  }
  
  function getExpensesView() {
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;
    const currentFilter = state.currentView.params.filter || 'all'; // 'all', 'paid', 'unpaid'

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    const monthExpenses = state.expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getFullYear() === currentYear && expenseDate.getMonth() === currentMonth;
    });

    const filteredExpenses = monthExpenses.filter(e => currentFilter === 'all' || e.paymentStatus === currentFilter).sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalMonthExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);

    const filterButtonsHTML = `
        <div class="tab-card-container" style="margin-bottom: 20px;">
            <div class="tab-card ${currentFilter === 'all' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'all', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #64748b, #475569);">
                <i class="fas fa-list"></i>
                <span>الكل</span>
            </div>
            <div class="tab-card ${currentFilter === 'paid' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'paid', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-check-circle"></i>
                <span>المدفوعة</span>
            </div>
            <div class="tab-card ${currentFilter === 'unpaid' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'unpaid', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-exclamation-circle"></i>
                <span>غير المدفوعة</span>
            </div>
        </div>
    `;

    const expensesListHTML = filteredExpenses.length > 0
        ? filteredExpenses.map(expense => {
            const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;
            const isUnpaid = expense.category === 'material' && expense.paymentStatus === 'unpaid';
            const supplier = expense.supplierId ? state.suppliers.find(s => s.id === expense.supplierId) : null;
            
            let linkedToHTML = project ? `<div style="font-size: 13px; color: var(--muted); margin-top: 4px;"><i class="fas fa-hard-hat" style="margin-left: 4px; opacity: 0.7;"></i> ${project.name}</div>` : '';
            const supplierHTML = supplier ? `<div style="font-size: 13px; color: var(--muted); margin-top: 4px;"><i class="fas fa-truck" style="margin-left: 4px; opacity: 0.7;"></i> ${supplier.name}</div>` : '';


            return `
                <div class="card" data-action="view-expense" data-id="${expense.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        ${expense.receiptUrl
                            ? `<img src="${expense.receiptUrl}" alt="إيصال" style="width:48px; height:48px; border-radius: 8px; object-fit: cover;">`
                            : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ef4444,#dc2626); font-size: 20px; margin-bottom: 0;"><i class="fas fa-receipt"></i></div>`
                        }
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 700;">${expense.description}</div>
                            <div style="font-size: 13px; color: var(--muted);">${new Date(expense.date).toLocaleDateString('ar-DZ')}</div>
                            ${linkedToHTML}
                            ${supplierHTML}
                        </div>
                    </div>
                    <div style="text-align: left;">
                        ${isUnpaid ? `<div class="status-badge" style="background-color: #ef4444; font-size: 10px; margin-bottom: 4px;">غير مدفوع</div>` : ''}
                        <div style="font-weight: 700; font-size: 15px; color: #ef4444;">${expense.amount.toLocaleString()} د.ج</div>
                    </div>
                </div>`;
        }).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد مصاريف مسجلة لهذا الشهر.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">إدارة النفقات</h3>
            <div>
                <button id="addExpenseBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة نفقة</button>
                <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('expenses', {month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('expenses', {month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">›</button>
            </div>
            <div style="text-align: center; padding: 10px 0; border-top: 1px solid var(--border-color);">
                <div style="font-size: 14px; color: var(--muted);">إجمالي مصاريف الشهر</div>
                <div style="font-size: 22px; font-weight: 800; color: #ef4444;">${totalMonthExpenses.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- أزرار التصفية -->
        <div class="filter-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
            <div class="${currentFilter === 'all' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'all'})" 
                style="background: linear-gradient(135deg, #64748b, #475569); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'all' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'all' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-list" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">الكل</span>
            </div>
            <div class="${currentFilter === 'paid' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'paid'})" 
                style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'paid' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'paid' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-check-circle" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">المدفوعة</span>
            </div>
            <div class="${currentFilter === 'unpaid' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'unpaid'})" 
                style="background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'unpaid' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'unpaid' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-exclamation-circle" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">غير المدفوعة</span>
            </div>
        </div>

        ${expensesListHTML}
    `;
  }

  function getExpenseDetailsView(expenseId) {
    const expense = state.expenses.find(e => e.id === expenseId);
    if (!expense) return `<p>لم يتم العثور على النفقة.</p><button id="backToExpenses">العودة</button>`;

    const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;
    const supplier = expense.supplierId ? state.suppliers.find(s => s.id === expense.supplierId) : null;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تفاصيل النفقة</h3>
            <div>
                <!-- *** تحسين: زر العودة الذكي *** -->
                <button onclick="goBackToPreviousView()" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        <div class="form-actions" style="margin-bottom: 16px;">
                <button id="editExpenseBtn" data-id="${expense.id}" class="btn ghost" style="flex: 1;"><i class="fas fa-edit" style="margin-left: 8px;"></i> تعديل</button>
                <button id="analyzeExpenseBtn" data-id="${expense.id}" class="btn ghost" style="margin-left:8px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                <button id="printExpenseBtn" data-id="${expense.id}" class="btn ghost" style="margin-left:8px;"><i class="fas fa-print"></i></button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            
            ${expense.receiptUrl ? `
            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">صورة الإيصال</h4>
                <img src="${expense.receiptUrl}" alt="صورة الإيصال" style="width: 100%; max-width: 300px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border-color); display: block; margin: 0 auto;">
            </div>
            ` : ''}

            <div style="margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">وصف النفقة</div>
                <div style="font-weight:700; font-size:18px; margin-top: 4px;">${expense.description}</div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                <div style="font-size:14px; color:var(--muted);">المبلغ</div>
                <div style="font-weight:800; font-size:22px; color: #ef4444;">${expense.amount.toLocaleString()} د.ج</div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">التاريخ</div>
                <div style="font-weight:700; font-size:16px;">${new Date(expense.date).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</div>
            </div>

            ${project ? `
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">المشروع المرتبط</div>
                <div style="font-weight:700; font-size:16px;"><i class="fas fa-hard-hat" style="margin-left: 6px; opacity: 0.7;"></i> ${project.name}</div>
            </div>
            ` : ''}

            ${expense.notes ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <div style="font-size:13px; color: var(--muted);">ملاحظات</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${expense.notes}</div>
            </div>` : ''}

            <!-- *** إضافة: عرض حالة الدفع في تفاصيل النفقة *** -->
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">حالة الدفع</div>
                <div class="status-badge" style="background-color: ${expense.paymentStatus === 'paid' ? '#10b981' : '#ef4444'};">${expense.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع'}</div>
            </div>


        </div>
    `;
  }
  
  function getInventoryView() {
    const statusStyles = {
        available: { text: 'متوفر', bg: '#10b981' },
        in_use: { text: 'قيد الاستخدام', bg: '#f59e0b' },
        maintenance: { text: 'صيانة', bg: '#ef4444' },
    };

    const inventoryListHTML = state.inventory && state.inventory.length > 0
        ? state.inventory.map(item => `
            <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px; cursor: default; transform: none;">
                <div data-action="view-inventory-item" data-id="${item.id}" style="display:flex; align-items:center; gap: 12px; flex-grow: 1; cursor: pointer;">
                    ${item.imageUrl
                        ? `<img src="${item.imageUrl}" alt="${item.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 20px; margin-bottom: 0;"><i class="fas fa-toolbox"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${item.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">الكمية: ${item.quantity || 1}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                    <button data-action="analyze-inventory-item" data-id="${item.id}" class="btn ghost" style="padding: 6px 10px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                    <div class="status-badge" style="background-color: ${statusStyles[item.status]?.bg || '#64748b'};">
                        ${statusStyles[item.status]?.text || 'غير معروف'}
                    </div>
                </div>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد أدوات في المخزون بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">مخزون الأدوات</h3>
            <div>
                <button id="addInventoryBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة أداة</button>
                <button onclick="renderView('more_features')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${inventoryListHTML}
    `;
  }

  function getInventoryItemDetailsView(itemId) {
    const item = state.inventory.find(i => i.id === itemId);
    if (!item) return `<p>لم يتم العثور على الأداة.</p><button onclick="renderView('inventory')">العودة</button>`;

    const statusStyles = {
        available: { text: 'متوفر', bg: '#10b981' },
        in_use: { text: 'قيد الاستخدام', bg: '#f59e0b' },
        maintenance: { text: 'صيانة', bg: '#ef4444' },
    };

    let actionButtonHTML = '';
    if (item.status === 'available') {
        actionButtonHTML = `<button id="lendItemBtn" data-id="${item.id}" class="btn" style="width: 100%; background-color: #3b82f6; margin-top: 16px;"><i class="fas fa-hand-holding" style="margin-left: 8px;"></i> إعارة الأداة</button>`;
    } else if (item.status === 'in_use') {
        actionButtonHTML = `<button id="returnItemBtn" data-id="${item.id}" class="btn" style="width: 100%; background-color: #10b981; margin-top: 16px;"><i class="fas fa-undo" style="margin-left: 8px;"></i> تأكيد الاسترجاع</button>`;
    }

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تفاصيل الأداة</h3>
            <button id="backToInventory" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${item.imageUrl
                    ? `<img src="${item.imageUrl}" alt="${item.name}" style="width:64px; height:64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                    : `<div class="icon" style="width:64px; height:64px; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 28px; margin-bottom: 0; flex-shrink: 0;"><i class="fas fa-toolbox"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 20px;">${item.name}</h2>
                    <p style="margin: 0; color: var(--muted); font-size: 14px;">الكمية: ${item.quantity || 1}</p>
                </div>
                <button id="editInventoryBtn" data-id="${item.id}" class="btn ghost" style="align-self: flex-start;"><i class="fas fa-edit"></i></button>
                <button id="analyzeInventoryBtn" data-id="${item.id}" class="btn ghost" style="align-self: flex-start; color: #0ea5e9; border-color: #0ea5e9; margin-right: 8px;"><i class="fas fa-robot"></i></button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size:14px; color:var(--muted);">الحالة الحالية:</div>
                <div class="status-badge" style="background-color: ${statusStyles[item.status]?.bg || '#64748b'};">${statusStyles[item.status]?.text || 'غير معروف'}</div>
            </div>

            ${item.status === 'in_use' && item.borrowerName ? `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 12px;">
                <div style="font-size:13px; color:var(--muted);">مُعارة إلى: <strong style="color: var(--text-primary);">${item.borrowerName}</strong></div>
                <div style="font-size:13px; color:var(--muted); margin-top: 4px;">تاريخ الإعارة: <strong style="color: var(--text-primary);">${new Date(item.borrowDate).toLocaleDateString('ar-DZ')}</strong></div>
            </div>` : ''}

            ${actionButtonHTML}
        </div>
    `;
  }
  
  function getNotesView() {
    // Sort notes by last updated time, descending
    const notesListHTML = state.notes && state.notes.length > 0
        ? state.notes.sort((a, b) => b.updatedAt - a.updatedAt).map(note => `
            <div class="note-card" data-id="${note.id}" style="border-top-color: ${note.color || 'var(--primary)'}; padding: 0;">
                <div data-action="view-note" style="padding: 16px; cursor: pointer;">
                    <h4 class="note-title">${note.title || 'ملاحظة بدون عنوان'}</h4>
                    <p class="note-content">${note.content ? note.content.replace(/\n/g, '<br>') : 'لا يوجد محتوى'}</p>
                </div>
                <div class="note-footer" style="padding: 8px 16px;">
                    <span style="font-size: 12px; color: var(--muted);">آخر تحديث: ${new Date(note.updatedAt).toLocaleDateString('ar-DZ')}</span>
                    <button data-action="analyze-note" data-id="${note.id}" class="btn ghost" style="padding: 4px 8px; font-size: 12px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                </div>
            </div>
        `).join('')
        : ``;

    const emptyStateHTML = !notesListHTML ? `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد ملاحظات. أضف ملاحظتك الأولى!</p>` : '';

    // Add a specific listener for the note content part to open the modal
    mainContent.querySelectorAll('[data-action="view-note"]').forEach(el => {
        el.addEventListener('click', (e) => {
            openNoteModal(parseInt(e.currentTarget.closest('.note-card').dataset.id));
        });
    });
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">ملاحظات سريعة</h3>
            <button onclick="renderView('more_features')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>
        
        <!-- Inline Note Form -->
        <div id="addNoteFormContainer" class="add-note-container">
            <input type="text" id="newNoteTitle" placeholder="عنوان..." style="display: none;">
            <textarea id="newNoteContent" placeholder="اكتب ملاحظة..." rows="1"></textarea>
            <div id="newNoteActions" class="new-note-actions" style="display: none;">
                <div class="color-swatches">
                    <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                    <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                    <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                    <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                    <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                </div>
                <button id="saveNewNoteBtn" class="btn">حفظ</button>
            </div>
        </div>

        <div class="notes-grid">
            ${notesListHTML}
        </div>
        ${emptyStateHTML}
    `;
  }

  
  function getSettingsView() {
    const isDark = document.body.classList.contains('dark');
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">الإعدادات</h3>
            <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>
        <div id="navigateToThemes" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-bottom: 12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ec4899,#d946ef); font-size: 20px; margin-bottom: 0;"><i class="fas fa-palette"></i></div>
                    <div>
                        <div style="font-weight:700;">تخصيص الثيمات</div>
                        <div style="font-size:13px; color: var(--muted)">تغيير ألوان ومظهر التطبيق</div>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
            </div>
        </div>

        <div id="navigateToApiSettings" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#0ea5e9,#0284c7); font-size: 20px; margin-bottom: 0;"><i class="fas fa-robot"></i></div>
                <div style="flex: 1 1 0%;">
                    <div style="font-weight:700;">إعدادات مساعد الذكاء الاصطناعي</div>
                    <div style="font-size:13px; color: var(--muted)">إدارة مفاتيح API الخاصة بك</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>

        <div id="navigateToFactoryReset" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px; border-top: 2px solid #ef4444;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ef4444,#b91c1c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-power-off"></i></div>
                <div>
                    <div style="font-weight:700; color: #ef4444;">إعادة ضبط المصنع</div>
                    <div style="font-size:13px; color: var(--muted)">حذف جميع البيانات والعودة للحالة الأولية</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>
    `;
  }

  function getApiSettingsView() {
    const activeApiId = state.active_api_id;
    const apiListHTML = state.api_configs && state.api_configs.length > 0
      ? state.api_configs.map(config => {
        const isActive = config.id === activeApiId;
        return `
            <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right; margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100%; margin-bottom: 12px;">
                    <h5 style="margin:0; font-weight:700;">${config.name}</h5>
                    <label class="switch">
                        <input type="checkbox" data-action="toggle-api-active" data-id="${config.id}" ${isActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="font-size: 13px; color: var(--muted); width: 100%; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                    المزود: ${config.provider} | النموذج: ${config.model}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100%; margin-top: 12px;">
                    <span style="font-size: 13px; color: #10b981; font-weight: 700;"><i class="fas fa-check-circle" style="margin-left: 4px;"></i> صالح</span>
                    <button onclick="deleteApiConfig(${config.id})" class="btn ghost" style="color: #ef4444; border-color: transparent;"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
      }).join('')
      : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم تقم بإضافة أي إعدادات API بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">إعدادات الذكاء الاصطناعي</h3>
            <div>
                <button id="addApiConfigBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة API</button>
                <button onclick="renderView('settings')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${apiListHTML}
    `;
  }

  function getThemesView() {
    const currentThemeName = state.selected_theme || 'default-light';
    
    const createThemeCard = (themeKey) => {
        const theme = themes[themeKey];
        const isActive = themeKey === currentThemeName;
        return `
            <div class="card theme-card" data-theme="${themeKey}" style="padding: 12px; border-color: ${isActive ? 'var(--primary)' : 'transparent'};">
                <div style="display: flex; gap: 8px; width: 100%; height: 60px; margin-bottom: 12px;">
                    <div style="flex: 1; background-color: ${theme.colors['--bg']}; border-radius: 6px;"></div>
                    <div style="flex: 2; background-color: ${theme.colors['--card']}; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--primary']};"></div>
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--accent']};"></div>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 14px;">${theme.name}</div>
                ${isActive ? `<div style="position: absolute; top: 8px; left: 8px; color: var(--primary); font-size: 18px;"><i class="fas fa-check-circle"></i></div>` : ''}
            </div>
        `;
    };

    const lightThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'light').map(createThemeCard).join('');
    const darkThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'dark').map(createThemeCard).join('');

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تخصيص الثيمات</h3>
            <button onclick="renderView('settings')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة للإعدادات</button>
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الفاتحة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${lightThemesHTML}
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الداكنة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${darkThemesHTML}
        </div>
    `;
  }

  function getAiAssistantView() {
    if (!state.active_api_id) {
        return `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; color: var(--accent); margin-bottom: 16px;"><i class="fas fa-robot"></i></div>
                <h3 style="margin:0 0 8px;">مساعد الذكاء الاصطناعي غير نشط</h3>
                <p style="color: var(--muted); line-height: 1.6;">
                    لاستخدام هذه الميزة، يرجى الذهاب إلى الإعدادات وتفعيل أحد مفاتيح الـ API.
                </p>
                <button onclick="renderView('api_settings')" class="btn" style="margin-top: 16px;">الذهاب إلى الإعدادات</button>
            </div>
        `;
    }

    // Reset history and add the initial assistant message
    const welcomeMessage = "مرحباً! أنا مساعدك الذكي، والآن يمكنني الوصول إلى بيانات تطبيقك. اسألني عن عمالك، مشاريعك، أو أي شيء آخر!";
    state.aiChatHistory = [
        { role: 'model', content: welcomeMessage }
    ];

    const suggestions = [
        'ما هو رصيد العامل "عامل تجريبي"؟',
        'كم عدد أيام عمل بلال في شهر يونيو؟',
        'لخص لي مصاريف شراء الدهانات',
        'ما هي الأدوات المعارة حالياً؟'
    ];

    const suggestionsHTML = suggestions.map(s => `<button class="btn ghost suggestion-btn" style="font-size: 13px; padding: 6px 10px;">${s}</button>`).join('');

    return `
        <h3 style="margin:0 0 16px;font-weight:800">مساعد الذكاء الاصطناعي</h3>
        <div class="ai-chat-container card" style="padding: 0; align-items: stretch; height: calc(100vh - 220px);">
            <div id="aiChatHistory" class="ai-chat-history">
                <div class="ai-chat-bubble model">
                    <p>${welcomeMessage}</p>
                    <p>يمكنك طرح أسئلة عامة عن الديكور أو أسئلة محددة حول بياناتك. جرب أحد الاقتراحات التالية:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                        ${suggestionsHTML}
                    </div>
                </div>
            </div>
            <div class="ai-chat-input-area">
                <textarea id="aiPromptInput" placeholder="اكتب سؤالك هنا..." rows="1"></textarea>
                <button id="sendAiPromptBtn" class="btn" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    `;
  }
  
  function getFactoryResetView() {
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800; color: #ef4444;">إعادة ضبط المصنع</h3>
            <button onclick="renderView('settings')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة للإعدادات</button>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: center; text-align: center; border-color: #ef4444;">
            <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
            <h4 style="margin: 0 0 8px; font-size: 18px;">تحذير: إجراء لا يمكن التراجع عنه</h4>
            <p style="color: var(--muted); line-height: 1.7; max-width: 400px; margin-bottom: 24px;">
                أنت على وشك حذف جميع البيانات المخزنة في التطبيق بشكل نهائي، بما في ذلك العمال، المشاريع، الملاحظات، وجميع الإعدادات الأخرى.
                لا يمكن استرجاع هذه البيانات بعد الحذف.
            </p>
            <button id="factoryResetBtn" class="btn" style="background-color: #ef4444; padding: 10px 24px; font-size: 16px;">
                <i class="fas fa-trash-alt" style="margin-left: 8px;"></i> نعم، أفهم وأريد الحذف
            </button>
        </div>
    `;
  }

  function getAboutView() {
    const appInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right;">
            <h4 style="margin:0 0 12px; font-weight:800;">عن التطبيق</h4>
            <p style="margin:0; line-height:1.7;">
                <strong>My Decor Manager</strong> هو مساعدك الرقمي الشامل لإدارة أعمال الديكور والبناء. مصمم لتبسيط مهامك اليومية، من تتبع العمال والمشاريع إلى إدارة النفقات والموردين، كل ذلك في مكان واحد سهل الاستخدام.
            </p>
        </div>
    `;

    const devInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right; margin-top: 20px;">
            <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
                <img src="images/billel.png" alt="بلال بورابعة" style="width:80px; height:80px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color);">
                <div style="flex-grow: 1;">
                    <h4 style="margin: 0 0 4px; font-weight:800; font-size: 18px;">بلال بورابعة</h4>
                    <p style="margin: 0; color: var(--primary); font-size: 14px; font-weight: 700;">مطور برمجيات</p>
                </div>
            </div>
            <p style="margin:16px 0 0; line-height:1.7; border-top: 1px solid var(--border-color); padding-top: 16px; width: 100%;">👨‍💻 مطور برمجيات منذ 2014، شغوف بالذكاء الاصطناعي وهندسة البرمجيات. صاحب مدونة تقنية ومؤلف كتاب حول نظام أندرويد يصدر في 2025. معروف بلقب إمبراطور التقنية، بخبرة في تطوير التطبيقات عبر Android Studio وVisual Studio Code، مع مشاريع تعليمية وإبداعية لمشاركة المعرفة ودعم المطورين.</p>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); width: 100%;">
                <h5 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">تواصل معي</h5>
                <div style="display: flex; gap: 20px; font-size: 24px;">
                    <a href="https://www.facebook.com/billel.bouraba" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-facebook"></i></a>
                    <a href="https://www.instagram.com/billel_bouraba/?hl=fr" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-instagram"></i></a>
                    <a href="mailto:billel.dadi123@gmail.com" style="color: var(--muted); text-decoration: none;"><i class="fas fa-envelope"></i></a>
                </div>
            </div>
        </div>
    `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">حول التطبيق</h3>
            <button onclick="renderView('home')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
        </div>
        ${appInfo}${devInfo}`;
  }

  function getMyInfoView() {
    const profilesListHTML = state.companyProfiles && state.companyProfiles.length > 0
        ? state.companyProfiles.map(profile => `
            <div class="card" data-action="view-profile" data-id="${profile.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${profile.logoUrl
                        ? `<img src="${profile.logoUrl}" alt="${profile.profileName}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 20px; margin-bottom: 0;"><i class="fas fa-id-card"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${profile.profileName}</div>
                        <div style="font-size: 13px; color: var(--muted);">${profile.profession || 'ملف شخصي'}</div>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--muted);"></i>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم تقم بإنشاء أي ملفات تعريفية بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">ملفاتي التعريفية</h3>
            <div>
                <button id="addProfileBtn" class="btn" style="margin-left: 8px;"><i class="fas fa-plus" style="margin-left: 6px;"></i> إضافة ملف</button>
                <button onclick="renderView('more_features')" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>
        ${profilesListHTML}
    `;
  }

  function getProfileDetailsView(profileId) {
    const profile = state.companyProfiles.find(p => p.id === profileId);
    if (!profile) return `<p>لم يتم العثور على الملف التعريفي.</p><button id="backToProfiles">العودة</button>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
            <h3 style="margin:0; font-weight:800">تفاصيل الملف</h3>
            <div>
                <button id="analyzeProfileBtn" data-id="${profile.id}" class="btn ghost" style="margin-left:8px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                <button id="editProfileBtn" data-id="${profile.id}" class="btn ghost" style="margin-left:8px;"><i class="fas fa-edit"></i></button>
                <button id="saveProfileAsImageBtn" data-id="${profile.id}" class="btn ghost" style="margin-left:8px;"><i class="fas fa-camera"></i></button>
                <button id="backToProfiles" class="btn"><i class="fas fa-arrow-right" style="margin-left: 6px;"></i> العودة</button>
            </div>
        </div>

        <div id="profileCardToSave" style="background: linear-gradient(135deg, #0b1220, #071026); color: #f1f5f9; border-radius: 12px; padding: 20px; text-align: right; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 12px; left: 12px; font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.3);">My Decor Manager</div>
            
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${profile.logoUrl
                    ? `<img src="${profile.logoUrl}" alt="${profile.profileName}" style="width:80px; height:80px; border-radius: 16px; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color);">`
                    : `<div class="icon" style="width:80px; height:80px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 36px; margin-bottom: 0; flex-shrink: 0; border-radius: 16px; color: white;"><i class="fas fa-id-card"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 22px; font-weight: 800; color: white;">${profile.ownerName || profile.profileName}</h2>
                    <p style="margin: 0; color: #c084fc; font-size: 16px; font-weight: 700;">${profile.profession || 'مهنة غير محددة'}</p>
                </div>
            </div>

            <h4 style="margin: 16px 0 10px; font-size: 14px; color: rgba(255,255,255,0.5);">معلومات الدفع</h4>

            ${profile.ccp ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">CCP</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white; letter-spacing: 1px;">${profile.ccp}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.ccp}'); showToast('تم نسخ رقم CCP بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.rip ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">RIP / BaridiMob</div>
                    <div style="font-weight:700; font-size:16px; direction: ltr; margin-top: 4px; word-break: break-all; color: white;">${profile.rip}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.rip}'); showToast('تم نسخ رقم RIP بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.phone1 ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">رقم الهاتف 1</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white;">${profile.phone1}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.phone1}'); showToast('تم نسخ رقم الهاتف بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.phone2 ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">رقم الهاتف 2</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white;">${profile.phone2}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.phone2}'); showToast('تم نسخ رقم الهاتف بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.address ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size:13px; color: rgba(255,255,255,0.5);">العنوان</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; line-height: 1.6; color: white;">${profile.address}</div>
            </div>
            ` : ''}

            ${profile.privateNotes ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size:13px; color: rgba(255,255,255,0.5);">معلومات إضافية</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; line-height: 1.6; color: white; white-space: pre-wrap;">${profile.privateNotes}</div>
            </div>
            ` : ''}
        </div>
    `;
  }

  async function saveProfileAsImage(profileId) {
    const cardElement = document.getElementById('profileCardToSave');
    if (!cardElement) return;

    const profile = state.companyProfiles.find(p => p.id === profileId);
    const fileName = `info-${(profile.profileName || 'profile').replace(/\s+/g, '-').toLowerCase()}.png`;

    try {
        const canvas = await html2canvas(cardElement, {
            scale: 2, // Higher scale for better quality
            backgroundColor: null, // Use the element's actual background
            useCORS: true, // Important for external images/logos
        });
        const imageURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imageURL;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Oops, something went wrong!', error);
        alert('حدث خطأ أثناء إنشاء الصورة.');
    }
  }

  // *** إضافة: دالة للعودة إلى الواجهة السابقة ***
  function goBackToPreviousView() {
    if (state.previousView && state.previousView.name) {
        renderView(state.previousView.name, state.previousView.params);
    } else {
        // Fallback to a default view if no previous view is stored
        renderView('home');
    }
  }

  // --- Expense Modal ---
  function closeAllExpenseModals() {
      // إغلاق جميع النوافذ المنبثقة المتعلقة بالنفقات
      const modals = [
          'allExpensesModal',
          'projectFullFinanceModal',
          'expenseModal'
      ];
      
      modals.forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (modal) {
              modal.style.display = 'none';
          }
      });
  }

  function openExpenseModal(expenseId = null, prefill = {}) {
      // إغلاق جميع النوافذ المنبثقة المتعلقة بالنفقات أولاً
      closeAllExpenseModals();

      // Get elements each time the modal is opened to ensure they exist.
      const expenseModal = document.getElementById('expenseModal');
      const expenseForm = document.getElementById('expenseForm');
      const expenseModalTitle = document.getElementById('expenseModalTitle');
      const expenseIdInput = document.getElementById('expenseId');
      const expenseDescriptionInput = document.getElementById('expenseDescription');
      const expenseAmountInput = document.getElementById('expenseAmount');
      const expenseDateInput = document.getElementById('expenseDate');
      const expenseProjectInput = document.getElementById('expenseProjectName');
      const expenseWorkerInput = document.getElementById('expenseWorker');
      const expenseSupplierInput = document.getElementById('expenseSupplier');
      const expenseCategoryInput = document.getElementById('expenseCategory');
      const expensePaymentStatusInput = document.getElementById('expensePaymentStatus');
      const deleteExpenseBtn = document.getElementById('deleteExpenseBtn');
      const expenseImageDataBase64 = document.getElementById('expenseImageDataBase64');
      const expenseImagePreview = document.getElementById('expenseImagePreview');

      if (!expenseForm) return; // Safety check

      expenseForm.reset();
      resetExpenseImagePreview();
      // Populate project datalist and worker dropdown
      const projectDatalist = document.getElementById('project-list');
      projectDatalist.innerHTML = state.projects.map(p => `<option value="${p.name}"></option>`).join('');
      // Removed worker and supplier dropdown population

      if (expenseId) {
          const expense = state.expenses.find(e => e.id === expenseId);
          if (expense) {
              expenseModalTitle.textContent = 'تعديل النفقة';
              expenseIdInput.value = expense.id;
              expenseDescriptionInput.value = expense.description;
              expenseAmountInput.value = expense.amount;
              expenseDateInput.value = expense.date;
              // Find project name from ID and set it to the input
              if (expense.projectId) {
                  const project = state.projects.find(p => p.id === expense.projectId);
                  expenseProjectInput.value = project ? project.name : '';
              }
              document.querySelector(`input[name="expensePaymentStatus"][value="${expense.paymentStatus || 'paid'}"]`).checked = true;
              if (expense.receiptUrl) {
                  expenseImageDataBase64.value = expense.receiptUrl;
                  expenseImagePreview.src = expense.receiptUrl;
                  showExpenseImagePreview(true);
              }
              deleteExpenseBtn.style.display = 'inline-block';
          }
      } else {
          expenseModalTitle.textContent = 'إضافة نفقة جديدة';
          expenseIdInput.value = '';
          expenseDateInput.valueAsDate = new Date();
          deleteExpenseBtn.style.display = 'none';
          // Handle pre-filling from project details view
          if (prefill.projectId) {
              const project = state.projects.find(p => p.id === prefill.projectId);
              if (project) expenseProjectInput.value = project.name;
          }
      }
      
      expenseModal.style.display = 'flex';
  }

  function closeExpenseModal() {
      closeAllExpenseModals();
  }

  function resetExpenseImagePreview() {
      document.getElementById('expenseImageDataBase64').value = '';
      document.getElementById('expenseImageInput').value = '';
      const expenseImagePreview = document.getElementById('expenseImagePreview');
      expenseImagePreview.src = '';
      expenseImagePreview.style.display = 'none';
      expenseImagePlaceholder.style.display = 'flex';
      expenseImageRemoveBtn.style.display = 'none';
  }

  function showExpenseImagePreview(show) {
      const expenseImagePreview = document.getElementById('expenseImagePreview');
      const expenseImagePlaceholder = document.getElementById('expenseImagePlaceholder');
      const expenseImageRemoveBtn = document.getElementById('expenseImageRemoveBtn');
      expenseImagePreview.style.display = show ? 'block' : 'none';
      expenseImagePlaceholder.style.display = show ? 'none' : 'flex';
      expenseImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  async function handleExpenseFormSubmit(e) {
      e.preventDefault();
      const expenseIdInput = document.getElementById('expenseId');
      const expenseDescriptionInput = document.getElementById('expenseDescription');
      const expenseAmountInput = document.getElementById('expenseAmount');
      const expenseDateInput = document.getElementById('expenseDate');
      const expenseProjectNameInput = document.getElementById('expenseProjectName');
      const expenseImageDataBase64 = document.getElementById('expenseImageDataBase64');

      const id = expenseIdInput.value ? parseInt(expenseIdInput.value) : null;
      let projectId = null;
      const projectName = expenseProjectNameInput.value.trim();

      if (projectName) {
          let project = state.projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
          if (project) {
              projectId = project.id;
          } else {
              // Project doesn't exist, create it
              projectId = await db.projects.add({ name: projectName, budget: 0, expenses: 0 });
          }
      }

      const paymentStatus = document.querySelector('input[name="expensePaymentStatus"]:checked').value;
      const expenseData = {
          description: expenseDescriptionInput.value,
          amount: parseFloat(expenseAmountInput.value) || 0,
          date: expenseDateInput.value,
          projectId: projectId,
          paymentStatus: paymentStatus,
          receiptUrl: expenseImageDataBase64.value,
          notes: document.getElementById('expenseNotes').value,
      };

      if (id) {
          await db.expenses.update(id, expenseData);
      } else {
          await db.expenses.add(expenseData);
      }
      // After saving, decide where to go back
      if (projectId) {
          renderView('project-details', { id: projectId, tab: 'finance' });
      } else {
          renderView('expenses');
      }
      closeExpenseModal();
  }

  // --- Worker Modal Functions ---
  const workerModal = document.getElementById('workerModal');
  const workerForm = document.getElementById('workerForm');
  const workerModalTitle = document.getElementById('workerModalTitle');
  const workerIdInput = document.getElementById('workerId');
  const workerNameInput = document.getElementById('workerName');
  const workerPhoneInput = document.getElementById('workerPhone');
  const workerDailyRateInput = document.getElementById('workerDailyRate');
  const deleteWorkerBtn = document.getElementById('deleteWorkerBtn');
  // Worker Image Elements
  const workerImageInput = document.getElementById('workerImageInput');
  const workerImagePreview = document.getElementById('workerImagePreview');
  const workerImagePlaceholder = document.getElementById('workerImagePlaceholder');
  const workerImageUploadBtn = document.getElementById('workerImageUploadBtn');
  const workerImageRemoveBtn = document.getElementById('workerImageRemoveBtn');
  const workerImageDataBase64 = document.getElementById('workerImageDataBase64');
  
  // Activity Modal Elements
  const activityModal = document.getElementById('activityModal');
  const activityForm = document.getElementById('activityForm');

  // --- Supplier Modal Functions ---
  const supplierModal = document.getElementById('supplierModal');
  const supplierForm = document.getElementById('supplierForm');
  const supplierModalTitle = document.getElementById('supplierModalTitle');
  const supplierIdInput = document.getElementById('supplierId');
  const supplierNameInput = document.getElementById('supplierName');
  const supplierPhoneInput = document.getElementById('supplierPhone');
  const supplierSpecialtyInput = document.getElementById('supplierSpecialty');
  const deleteSupplierBtn = document.getElementById('deleteSupplierBtn');
  // Supplier Image Elements
  const supplierImageInput = document.getElementById('supplierImageInput');
  const supplierImagePreview = document.getElementById('supplierImagePreview');
  const supplierImagePlaceholder = document.getElementById('supplierImagePlaceholder');
  const supplierImageUploadBtn = document.getElementById('supplierImageUploadBtn');
  const supplierImageRemoveBtn = document.getElementById('supplierImageRemoveBtn');
  const supplierImageDataBase64 = document.getElementById('supplierImageDataBase64');

  // --- Generic Confirmation Modal ---
  const confirmModal = document.getElementById('confirmModal');
  const confirmModalMessage = document.getElementById('confirmModalMessage');
  const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
  const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
  let onConfirmCallback = null;

  function openConfirmModal(message, onConfirm) {
      onConfirmCallback = onConfirm;
      confirmModalMessage.innerHTML = message;
      confirmModal.style.display = 'flex';
  }

  function closeConfirmModal() {
      confirmModal.style.display = 'none';
      onConfirmCallback = null;
  }

  // --- Event Details Modal ---
  const eventDetailsModal = document.getElementById('eventDetailsModal');
  function openEventDetailsModal(eventId) {
      const event = state.calendarEvents.find(e => e.id === eventId);
      if (!event) return;

      const eventTypes = {
          task: { text: 'مهمة', color: '#3b82f6' },
          appointment: { text: 'موعد', color: '#f59e0b' },
          delivery: { text: 'تسليم', color: '#10b981' },
          start_work: { text: 'بدء عمل', color: '#8b5cf6' }
      };

      document.getElementById('eventDetailsTitle').textContent = event.title;
      const typeBadge = document.getElementById('eventDetailsType');
      typeBadge.textContent = eventTypes[event.type]?.text || 'غير معروف';
      typeBadge.style.backgroundColor = eventTypes[event.type]?.color || '#64748b';
      document.getElementById('eventDetailsStartDate').textContent = new Intl.DateTimeFormat('ar-DZ', { dateStyle: 'full' }).format(new Date(event.startDate));
      document.getElementById('eventDetailsEndDate').textContent = new Intl.DateTimeFormat('ar-DZ', { dateStyle: 'full' }).format(new Date(event.endDate));

      document.getElementById('editEventDetailsBtn').onclick = () => {
          closeEventDetailsModal();
          openEventModal(eventId);
      };
      document.getElementById('deleteEventDetailsBtn').onclick = () => {
          // We can reuse the delete button logic from the edit modal
          deleteEventBtn.dataset.id = eventId; // Temporarily set id
          deleteEventBtn.click();
      };
      document.getElementById('analyzeEventDetailsBtn').onclick = () => {
          // We can close the details modal before showing the analysis modal for a cleaner UI
          closeEventDetailsModal();
          handleAnalysisRequest('event', eventId);
      };

      eventDetailsModal.style.display = 'flex';
  }
  function closeEventDetailsModal() {
      eventDetailsModal.style.display = 'none';
  }

  // --- Calendar Event Modal Functions ---
  const eventModal = document.getElementById('eventModal');
  const eventForm = document.getElementById('eventForm');
  const eventModalTitle = document.getElementById('eventModalTitle');
  const eventIdInput = document.getElementById('eventId');
  const eventTitleInput = document.getElementById('eventTitle');
  const eventStartDateInput = document.getElementById('eventStartDate');
  const eventEndDateInput = document.getElementById('eventEndDate');
  const eventTypeInput = document.getElementById('eventType');
  const deleteEventBtn = document.getElementById('deleteEventBtn');

  function openEventModal(eventId = null) {
      eventForm.reset();
      if (eventId) {
          const event = state.calendarEvents.find(e => e.id === eventId);
          if (event) {
              eventModalTitle.textContent = 'تعديل الحدث';
              eventIdInput.value = event.id;
              eventTitleInput.value = event.title;
              eventStartDateInput.value = event.startDate;
              eventEndDateInput.value = event.endDate;
              eventTypeInput.value = event.type;
              deleteEventBtn.style.display = 'inline-block';
          }
      } else {
          eventModalTitle.textContent = 'إضافة حدث جديد';
          eventIdInput.value = '';
          eventStartDateInput.valueAsDate = new Date();
          eventEndDateInput.valueAsDate = new Date();
          deleteEventBtn.style.display = 'none';
      }
      eventModal.style.display = 'flex';
  }

  function closeEventModal() {
      eventModal.style.display = 'none';
  }

  async function handleEventFormSubmit(e) {
      e.preventDefault();
      const id = eventIdInput.value ? parseInt(eventIdInput.value) : null;
      
      // Basic validation to ensure end date is not before start date
      if (eventEndDateInput.value < eventStartDateInput.value) {
          alert('تاريخ الانتهاء لا يمكن أن يكون قبل تاريخ البدء.');
          return;
      }

      const eventData = {
          title: eventTitleInput.value,
          startDate: eventStartDateInput.value,
          endDate: eventEndDateInput.value,
          type: eventTypeInput.value,
      };

      if (id) {
          await db.calendarEvents.update(id, eventData);
      } else {
          await db.calendarEvents.add(eventData);
      }
      renderView('calendar');
      closeEventModal();
  }

  // --- Lend Item Modal Functions ---
  const lendItemModal = document.getElementById('lendItemModal');
  const lendItemForm = document.getElementById('lendItemForm');

  // Lend Item Modal Listeners
  lendItemForm.addEventListener('submit', handleLendFormSubmit);
  lendItemModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeLendModal();
      }
  });

  function openLendModal(itemId) {
      lendItemForm.reset();
      document.getElementById('lendItemId').value = itemId;
      document.getElementById('borrowDate').valueAsDate = new Date();
      lendItemModal.style.display = 'flex';
  }

  function closeLendModal() {
      lendItemModal.style.display = 'none';
  }

  async function handleLendFormSubmit(e) {
      e.preventDefault();
      const itemId = parseInt(document.getElementById('lendItemId').value);
      const borrowerName = document.getElementById('borrowerName').value;
      const borrowDate = document.getElementById('borrowDate').value;

      await db.inventory.update(itemId, {
          status: 'in_use',
          borrowerName: borrowerName,
          borrowDate: borrowDate
      });
      closeLendModal();
      renderView('inventory-details', { id: itemId });
  }

  async function handleReturnItem(itemId) {
      await db.inventory.update(itemId, { status: 'available', borrowerName: '', borrowDate: '' });
      renderView('inventory-details', { id: itemId });
  }

  // --- Inventory Modal Functions ---
  const inventoryModal = document.getElementById('inventoryModal');
  const inventoryForm = document.getElementById('inventoryForm');
  const inventoryModalTitle = document.getElementById('inventoryModalTitle');
  const inventoryIdInput = document.getElementById('inventoryId');
  const inventoryNameInput = document.getElementById('inventoryName');
  const inventoryQuantityInput = document.getElementById('inventoryQuantity');
  const inventoryStatusInput = document.getElementById('inventoryStatus');
  const deleteInventoryBtn = document.getElementById('deleteInventoryBtn');
  const inventoryImageInput = document.getElementById('inventoryImageInput');
  const inventoryImagePreview = document.getElementById('inventoryImagePreview');
  const inventoryImagePlaceholder = document.getElementById('inventoryImagePlaceholder');
  const inventoryImageUploadBtn = document.getElementById('inventoryImageUploadBtn');
  const inventoryImageRemoveBtn = document.getElementById('inventoryImageRemoveBtn');
  const inventoryImageDataBase64 = document.getElementById('inventoryImageDataBase64');

  function openInventoryModal(itemId = null) {
      inventoryForm.reset();
      resetInventoryImagePreview();
      if (itemId) {
          const item = state.inventory.find(i => i.id === itemId);
          if (item) {
              inventoryModalTitle.textContent = 'تعديل الأداة';
              inventoryIdInput.value = item.id;
              inventoryNameInput.value = item.name;
              inventoryQuantityInput.value = item.quantity;
              inventoryStatusInput.value = item.status;
              if (item.imageUrl) {
                  inventoryImageDataBase64.value = item.imageUrl;
                  inventoryImagePreview.src = item.imageUrl;
                  showInventoryImagePreview(true);
              }
              deleteInventoryBtn.style.display = 'inline-block';
          }
      } else {
          inventoryModalTitle.textContent = 'إضافة أداة جديدة';
          inventoryIdInput.value = '';
          deleteInventoryBtn.style.display = 'none';
      }
      inventoryModal.style.display = 'flex';
  }

  function closeInventoryModal() {
      inventoryModal.style.display = 'none';
  }

  function resetInventoryImagePreview() {
      inventoryImageDataBase64.value = '';
      inventoryImageInput.value = '';
      inventoryImagePreview.src = '';
      inventoryImagePreview.style.display = 'none';
      inventoryImagePlaceholder.style.display = 'flex';
      inventoryImageRemoveBtn.style.display = 'none';
  }

  function showInventoryImagePreview(show) {
      inventoryImagePreview.style.display = show ? 'block' : 'none';
      inventoryImagePlaceholder.style.display = show ? 'none' : 'flex';
      inventoryImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }


  // --- Inline Note Form Logic ---
  function setupInlineNoteForm() {
      const container = document.getElementById('addNoteFormContainer');
      const titleInput = document.getElementById('newNoteTitle');
      const contentTextarea = document.getElementById('newNoteContent');
      const actionsDiv = document.getElementById('newNoteActions');
      const saveBtn = document.getElementById('saveNewNoteBtn');
      let selectedColor = '#3b82f6';

      const expandForm = () => {
          titleInput.style.display = 'block';
          actionsDiv.style.display = 'flex';
          contentTextarea.rows = 3;
      };

      const collapseForm = () => {
          titleInput.style.display = 'none';
          actionsDiv.style.display = 'none';
          contentTextarea.rows = 1;
          titleInput.value = '';
          contentTextarea.value = '';
      };

      contentTextarea.addEventListener('focus', expandForm);

      actionsDiv.querySelectorAll('.swatch').forEach(swatch => {
          swatch.addEventListener('click', () => {
              actionsDiv.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
              swatch.classList.add('selected');
              selectedColor = swatch.dataset.color;
          });
      });

      saveBtn.addEventListener('click', async () => {
          if (contentTextarea.value.trim() === '' && titleInput.value.trim() === '') {
              collapseForm();
              return;
          }
          await db.notes.add({ title: titleInput.value, content: contentTextarea.value, color: selectedColor, updatedAt: Date.now() });
          collapseForm();
          renderView('notes');
      });
  }

  // --- Note Modal Functions ---
  const noteModal = document.getElementById('noteModal');
  const noteForm = document.getElementById('noteForm');
  const noteModalTitle = document.getElementById('noteModalTitle');
  const noteIdInput = document.getElementById('noteId');
  const noteTitleInput = document.getElementById('noteTitle');
  const noteContentInput = document.getElementById('noteContent');
  const noteColorInput = document.getElementById('noteColor');
  const deleteNoteBtn = document.getElementById('deleteNoteBtn');

  // This function is now only for EDITING existing notes
  function openNoteModal(noteId = null) {
      noteForm.reset();
      // Reset color swatches
      document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
      const defaultSwatch = document.querySelector('.swatch[data-color="#3b82f6"]');
      defaultSwatch.classList.add('selected');
      noteColorInput.value = '#3b82f6';

      if (noteId) { // Only proceed if it's an existing note
          const note = state.notes.find(n => n.id === noteId);
          if (note) {
              noteModalTitle.textContent = 'تعديل الملاحظة';
              noteIdInput.value = note.id;
              noteTitleInput.value = note.title;
              noteContentInput.value = note.content;
              noteColorInput.value = note.color;
              const currentSwatch = document.querySelector(`.swatch[data-color="${note.color}"]`);
              if (currentSwatch) {
                  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                  currentSwatch.classList.add('selected');
              }
              deleteNoteBtn.style.display = 'inline-block';
          }
          noteModal.style.display = 'flex';
      }
  }

  function closeNoteModal() {
      noteModal.style.display = 'none';
  }

  async function handleNoteFormSubmit(e) {
      e.preventDefault();
      const id = noteIdInput.value ? parseInt(noteIdInput.value) : null;
      const noteData = {
          title: noteTitleInput.value,
          content: noteContentInput.value,
          color: noteColorInput.value,
          updatedAt: Date.now(),
      };

      if (id) {
          await db.notes.update(id, noteData);
      } else {
          await db.notes.add(noteData);
      }
      renderView('notes');
      closeNoteModal();
  }

  async function handleInventoryFormSubmit(e) {
      e.preventDefault();
      const id = inventoryIdInput.value ? parseInt(inventoryIdInput.value) : null;
      const itemData = {
          name: inventoryNameInput.value,
          quantity: parseInt(inventoryQuantityInput.value) || 1,
          status: inventoryStatusInput.value,
          imageUrl: inventoryImageDataBase64.value,
      };

      if (id) {
          await db.inventory.update(id, itemData);
      } else {
          await db.inventory.add(itemData);
      }
      renderView('inventory');
      closeInventoryModal();
  }



  function openSupplierModal(supplierId = null) {
      supplierForm.reset();
      resetSupplierImagePreview();
      if (supplierId) {
          const supplier = state.suppliers.find(s => s.id === supplierId);
          if (supplier) {
              supplierModalTitle.textContent = 'تعديل بيانات المورد';
              supplierIdInput.value = supplier.id;
              supplierNameInput.value = supplier.name;
              supplierPhoneInput.value = supplier.phone;
              supplierSpecialtyInput.value = supplier.specialty;
              document.getElementById('supplierNotes').value = supplier.notes || '';
              if (supplier.imageUrl) {
                  supplierImageDataBase64.value = supplier.imageUrl;
                  supplierImagePreview.src = supplier.imageUrl;
                  showSupplierImagePreview(true);
              }
              deleteSupplierBtn.style.display = 'inline-block';
          }
      } else {
          supplierModalTitle.textContent = 'إضافة مورد جديد';
          supplierIdInput.value = '';
          deleteSupplierBtn.style.display = 'none';
      }
      supplierModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
  }

  function closeSupplierModal() {
      supplierModal.style.display = 'none';
      document.body.style.overflow = '';
  }

  function resetSupplierImagePreview() {
      supplierImageDataBase64.value = '';
      supplierImageInput.value = '';
      supplierImagePreview.src = '';
      supplierImagePreview.style.display = 'none';
      supplierImagePlaceholder.style.display = 'flex';
      supplierImageRemoveBtn.style.display = 'none';
  }

  function showSupplierImagePreview(show) {
      supplierImagePreview.style.display = show ? 'block' : 'none';
      supplierImagePlaceholder.style.display = show ? 'none' : 'flex';
      supplierImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  async function handleSupplierFormSubmit(e) {
      e.preventDefault();
      const id = supplierIdInput.value ? parseInt(supplierIdInput.value) : null;
      const supplierData = {
          name: supplierNameInput.value,
          phone: supplierPhoneInput.value,
          specialty: supplierSpecialtyInput.value,
          imageUrl: supplierImageDataBase64.value,
          notes: document.getElementById('supplierNotes').value,
      };

      if (id) {
          await db.suppliers.update(id, supplierData);
      } else {
          await db.suppliers.add(supplierData);
      }
      renderView('suppliers');
      closeSupplierModal();
  }


  function openWorkerModal(workerId = null) {
      workerForm.reset(); 
      resetImagePreview();
      if (workerId) {
          const worker = state.workers.find(w => w.id === workerId);
          if (worker) {
              workerModalTitle.textContent = 'تعديل بيانات العامل';
              workerIdInput.value = worker.id; 
              workerNameInput.value = worker.name;
              workerPhoneInput.value = worker.phone;
              workerDailyRateInput.value = worker.dailyRate;
              if (worker.imageUrl) {
                  workerImageDataBase64.value = worker.imageUrl;
                  workerImagePreview.src = worker.imageUrl;
                  showImagePreview(true);
              }
              deleteWorkerBtn.style.display = 'inline-block';
          }
      } else {
          workerModalTitle.textContent = 'إضافة عامل جديد';
          workerIdInput.value = '';
          deleteWorkerBtn.style.display = 'none';
      }
      workerModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
  }

  function openAttendanceConfirmModal(data) {
      tempAttendanceData = data;
      const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(data.date));
      document.getElementById('confirmDate').textContent = date;
      document.getElementById('attendanceConfirmModal').style.display = 'flex';
  }

  function closeAttendanceConfirmModal() { 
      document.getElementById('attendanceConfirmModal').style.display = 'none';
  }

  async function saveAttendance(status) {
      const { worker, date, dailyRate } = tempAttendanceData;
      worker.attendance.push({ id: Date.now(), date, status, dailyRate });
      await db.workers.update(worker.id, { attendance: worker.attendance });
      renderView('worker-details', { id: worker.id, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeAttendanceConfirmModal();
      closeActivityModal();
  }

  async function handleSettleMonth(workerId, year, month) {
      const worker = state.workers.find(w => w.id === workerId);
      if (!worker) return;

      const { totalDue, totalPaid } = calculateWorkerFinancials(worker, year, month);
      const balance = totalDue - totalPaid;

      if (balance > 0) {
          const settlementKey = `${year}-${month}`;
          const monthName = new Intl.DateTimeFormat('ar-DZ', { month: 'long' }).format(new Date(year, month));

          if (!worker.payments) worker.payments = [];
          worker.payments.push({ id: Date.now(), date: new Date(year, month, new Date(year, month + 1, 0).getDate()).toISOString().split('T')[0], amount: balance, note: `تسوية راتب شهر ${monthName}`, type: 'deduction' });
          
          if (!worker.settlements) worker.settlements = [];
          worker.settlements.push(settlementKey);

          await db.workers.update(workerId, { payments: worker.payments, settlements: worker.settlements });
          await renderView('worker-details', { id: workerId, year, month });
      }
  }

  async function openFullActivityLog(workerId) {
      const worker = state.workers.find(w => w.id == workerId);
      if (!worker) return;

      const fullLogHTML = generateActivityLog(worker); // No limit
      const logModalContent = document.getElementById('fullActivityLogContent');
      logModalContent.innerHTML = fullLogHTML;
      
      // Re-attach event listeners for delete buttons inside the modal
      logModalContent.querySelectorAll('.delete-activity').forEach(btn => btn.addEventListener('click', handleDeleteActivity));

      document.getElementById('activityLogModal').style.display = 'flex';
  }

  function closeFullActivityLog() {
      document.getElementById('activityLogModal').style.display = 'none';
  }

  function resetImagePreview() {
      workerImageDataBase64.value = '';
      workerImageInput.value = ''; // Reset file input
      workerImagePreview.src = '';
      workerImagePreview.style.display = 'none';
      workerImagePlaceholder.style.display = 'flex';
      workerImageRemoveBtn.style.display = 'none';
  }

  function closeWorkerModal() {
      workerModal.classList.add('is-exiting');
      document.body.style.overflow = '';
      setTimeout(() => {
          workerModal.style.display = 'none';
          workerModal.classList.remove('is-exiting');
      }, 250);
  }

  function showImagePreview(show) {
      workerImagePreview.style.display = show ? 'block' : 'none';
      workerImagePlaceholder.style.display = show ? 'none' : 'flex';
      workerImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  function openActivityModal(type) {
      const workerId = state.currentView.params.id;
      if (!workerId) return;

      activityForm.reset();
      document.getElementById('activityWorkerId').value = workerId;
      document.getElementById('activityType').value = type;
      document.getElementById('activityDate').valueAsDate = new Date();
      
      const worker = state.workers.find(w => w.id == workerId);

      const isFinancial = type === 'deduction' || type === 'bonus';
      const paymentGroup = document.getElementById('paymentAmountGroup');
      const noteGroup = document.getElementById('activityNoteGroup');
      const attendanceRateGroup = document.getElementById('attendanceRateGroup');

      paymentGroup.style.display = isFinancial ? 'block' : 'none';
      noteGroup.style.display = isFinancial ? 'block' : 'none';
      document.getElementById('paymentAmount').required = isFinancial;
      
      attendanceRateGroup.style.display = type === 'attendance' ? 'block' : 'none';
      if (type === 'attendance' && worker) {
          document.getElementById('attendanceDailyRate').value = worker.dailyRate || '';
      }

      let title = 'تسجيل يوم عمل';
      if (type === 'deduction') title = 'تسجيل خصم / مصاريف';
      if (type === 'bonus') title = 'تسجيل مكافأة (منحة)';
      document.getElementById('activityModalTitle').textContent = title;
      
      activityModal.style.display = 'flex';
  }

  function closeActivityModal() {
      activityModal.style.display = 'none';
  }

  async function handleWorkerFormSubmit(e) {
      e.preventDefault();
      const id = workerIdInput.value ? parseInt(workerIdInput.value) : null;
      const workerData = {
          name: workerNameInput.value,
          phone: workerPhoneInput.value,
          imageUrl: workerImageDataBase64.value,
          dailyRate: parseFloat(workerDailyRateInput.value) || 0,
      };

      if (id) { // Update existing worker
          await db.workers.update(id, workerData);
      } else { // Add new worker
          workerData.attendance = [];
          workerData.bonuses = [];
          workerData.payments = [];
          workerData.settlements = [];
          await db.workers.add(workerData);
      }
      renderView(id ? state.currentView.name : 'workers', id ? { id: id } : {});
      closeWorkerModal();
  }

  async function handleActivityFormSubmit(e) {
      e.preventDefault();
      const workerId = parseInt(document.getElementById('activityWorkerId').value);
      const type = document.getElementById('activityType').value;
      const date = document.getElementById('activityDate').value;

      const worker = state.workers.find(w => w.id == workerId);
      if (!worker) return;

      // Remove any existing attendance record for this date to avoid duplicates
      if (type === 'attendance' && worker.attendance) { 
          worker.attendance = worker.attendance.filter(a => a.date !== date);
      }

      if (type === 'deduction') {
          const amount = parseFloat(document.getElementById('paymentAmount').value);
          const note = document.getElementById('activityNote').value;
          if (!amount || amount <= 0) return;
          if (!worker.payments) worker.payments = []; 
          // Save with type and note
          worker.payments.push({ id: Date.now(), date, amount, note, type }); 
          await db.workers.update(workerId, { payments: worker.payments });
      } else if (type === 'bonus') {
          const amount = parseFloat(document.getElementById('paymentAmount').value);
          const note = document.getElementById('activityNote').value;
          if (!amount || amount <= 0) return;
          if (!worker.bonuses) worker.bonuses = [];
          worker.bonuses.push({ id: Date.now(), date, amount, note }); 
          await db.workers.update(workerId, { bonuses: worker.bonuses });
      } else { // attendance
          if (!worker.attendance) worker.attendance = [];
          const dailyRate = parseFloat(document.getElementById('attendanceDailyRate').value) || worker.dailyRate || 0;
          // Open confirmation modal instead of saving directly
          openAttendanceConfirmModal({ worker, date, dailyRate });
          return; // Stop execution here, will be continued by saveAttendance()
      }
      
      renderView('worker-details', { id: workerId, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeActivityModal();
  }

  function setupAiAssistantListeners() {
    const input = document.getElementById('aiPromptInput');
    const sendBtn = document.getElementById('sendAiPromptBtn');
    const history = document.getElementById('aiChatHistory');

    if (!input || !sendBtn || !history) return;

    const toggleSendButton = () => {
        sendBtn.disabled = input.value.trim() === '';
    };

    input.addEventListener('input', toggleSendButton);
    sendBtn.addEventListener('click', handleSendAiPrompt);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) handleSendAiPrompt();
        }
    });
    history.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-btn')) {
            input.value = e.target.textContent;
            toggleSendButton();
            handleSendAiPrompt();
        }
    });
  }

  function handleFactoryReset() {
      openConfirmModal('هل أنت متأكد تماماً من رغبتك في حذف جميع البيانات؟ هذا الإجراء نهائي ولا يمكن التراجع عنه.', async () => {
          closeConfirmModal();
          showToast('جاري إعادة الضبط...');
          await db.delete(); // Deletes the entire database
          // Wait a moment for the toast to be visible, then reload
          setTimeout(() => { location.reload(); }, 1500);
      });
  }

  async function handleDeleteActivity(e) {
      const btn = e.currentTarget;
      const workerId = parseInt(btn.dataset.workerId);
      openConfirmModal('هل أنت متأكد من حذف هذا النشاط؟', async () => {
          const { activityId, type } = btn.dataset;
          const worker = state.workers.find(w => w.id == workerId);
          if (!worker) return;

          if (type === 'attendance' && worker.attendance) {
              worker.attendance = worker.attendance.filter(a => a.id != activityId);
              await db.workers.update(workerId, { attendance: worker.attendance });
          } else if (type === 'deduction' && worker.payments) {
              worker.payments = worker.payments.filter(p => p.id != activityId);
              await db.workers.update(workerId, { payments: worker.payments });
          } else if (type === 'bonus' && worker.bonuses) {
              worker.bonuses = worker.bonuses.filter(b => b.id != activityId);
              await db.workers.update(workerId, { bonuses: worker.bonuses });
          }
          
          closeConfirmModal();
          await renderView('worker-details', { id: workerId });
          if (document.getElementById('activityLogModal').style.display === 'flex') {
              openFullActivityLog(workerId); // Refresh the full log modal if it's open
          }
      });
  }
  
  async function printWorkerReport(workerId) {
    const worker = state.workers.find(w => w.id == workerId);
    if (!worker) return;

    const { totalDue, totalPaid, presentDays } = calculateWorkerFinancials(worker, -1, -1); // Get total financials for report
    const balance = totalDue - totalPaid;
    const activityLogHTML = generateActivityLog(worker);

    const printContent = `
        <div style="font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px;">
            <h1 style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">تقرير العامل</h1>
            
            <h2 style="margin-top: 30px;">بيانات العامل</h2>
            <p><strong>الاسم:</strong> ${worker.name}</p>
            <p><strong>رقم الهاتف:</strong> ${worker.phone || 'غير متوفر'}</p>
            <p><strong>الأجرة اليومية:</strong> ${worker.dailyRate.toLocaleString()} د.ج</p>

            <h2 style="margin-top: 30px;">ملخص مالي</h2>
            <table style="width: 100%; border-collapse: collapse; text-align: right;">
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px; border: 1px solid #ddd;">الوصف</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">القيمة</th>
                </tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">إجمالي أيام الحضور</td><td style="padding: 8px; border: 1px solid #ddd;">${presentDays} يوم</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">إجمالي المستحقات</td><td style="padding: 8px; border: 1px solid #ddd;">${totalDue.toLocaleString()} د.ج</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">اجمالي الخصومات</td><td style="padding: 8px; border: 1px solid #ddd;">${totalPaid.toLocaleString()} د.ج</td></tr>
                <tr style="font-weight: bold;">
                    <td style="padding: 8px; border: 1px solid #ddd;">الرصيد المتبقي</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${balance.toLocaleString()} د.ج</td>
                </tr>
            </table>

            <h2 style="margin-top: 30px;">سجل الأنشطة</h2>
            <div class="activity-log-print-container">
                ${activityLogHTML.replace(/class="delete-activity".*?<\/button>/g, '')}
            </div>
        </div>
    `;

    document.getElementById('printContainer').innerHTML = printContent;
    window.print();
  }

  async function printExpenseReport(expenseId) {
    const expense = state.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    const worker = expense.workerId ? state.workers.find(w => w.id === expense.workerId) : null;
    const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;

    const printContent = `
        <div style="font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; max-width: 800px; margin: auto;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 24px;">وصل مصروفات</h1>
                <div style="text-align: left;">
                    <div style="font-size: 14px;">My Decor Manager</div>
                    <div style="font-size: 12px; color: #555;">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-DZ')}</div>
                </div>
            </header>
            
            <h2 style="margin-top: 30px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">تفاصيل المعاملة</h2>
            <table style="width: 100%; border-collapse: collapse; text-align: right; font-size: 15px; margin-top: 15px;">
                <tr style="line-height: 2;"><td style="padding: 8px; width: 30%; color: #555;">الوصف:</td><td style="padding: 8px; font-weight: bold;">${expense.description}</td></tr>
                <tr style="line-height: 2;"><td style="padding: 8px; color: #555;">التاريخ:</td><td style="padding: 8px; font-weight: bold;">${new Date(expense.date).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</td></tr>
                ${project ? `<tr style="line-height: 2;"><td style="padding: 8px; color: #555;">المشروع:</td><td style="padding: 8px; font-weight: bold;">${project.name}</td></tr>` : ''}
                ${worker ? `<tr style="line-height: 2;"><td style="padding: 8px; color: #555;">الشخص:</td><td style="padding: 8px; font-weight: bold;">${worker.name}</td></tr>` : ''}
                <tr style="line-height: 2; font-size: 18px; background: #f9f9f9;">
                    <td style="padding: 12px; color: #555;">المبلغ الإجمالي:</td>
                    <td style="padding: 12px; font-weight: 800; color: #d9534f; text-align: left;">${expense.amount.toLocaleString()} د.ج</td>
                </tr>
            </table>

            ${expense.receiptUrl ? `
            <div style="margin-top: 30px;">
                <h2 style="font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">صورة الإيصال المرفقة</h2>
                <img src="${expense.receiptUrl}" alt="صورة الإيصال" style="width: 100%; max-width: 400px; border-radius: 8px; border: 1px solid #ddd; display: block; margin: 15px auto;">
            </div>
            ` : ''}
        </div>
    `;

    document.getElementById('printContainer').innerHTML = printContent;
    window.print();
  }

  // HTML for the new Project Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="projectModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectModalTitle">إضافة مشروع جديد</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-group">
                        <label for="projectName">اسم المشروع</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <!-- *** إضافة: حقل جديد لاسم صاحب المنزل *** -->
                    <div class="form-group">
                        <label for="homeownerName">اسم صاحب المنزل (اختياري)</label>
                        <input type="text" id="homeownerName" placeholder="مثال: السيد أحمد">
                    </div>
                    <!-- *** إضافة: حقل جديد لاسم صاحب البناء *** -->
                    <div class="form-group">
                        <label for="builderName">اسم صاحب البناء (اختياري)</label>
                        <input type="text" id="builderName" placeholder="مثال: شركة البناء الحديث">
                    </div>
                    <div class="form-group">
                        <label for="projectBudget">الميزانية التقديرية (د.ج)</label>
                        <input type="number" id="projectBudget">
                    </div>
                    <!-- *** إضافة: عرض حالة المشروع داخل نافذة التعديل *** -->
                    <div class="form-group" id="projectStatusContainer" style="display: none;">
                        <label>حالة المشروع الحالية</label>
                        <span id="projectStatusBadge" class="status-badge"></span>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ التعديلات</button>
                        <!-- *** تحسين: زر إنهاء المشروع يظهر هنا فقط إذا كان المشروع نشطاً *** -->
                        <button type="button" class="btn" id="finishProjectBtn" style="display: none; background-color: #f97316; margin-left: auto; margin-right: 0;">إنهاء المشروع</button>
                        <button type="button" class="btn" id="deleteProjectBtn" style="display: none; background-color: #ef4444;">حذف المشروع</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`);


  // HTML for the new Client Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="clientModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clientModalTitle">إضافة عميل جديد</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId">
                    <input type="hidden" id="clientImageDataBase64">

                    <div class="form-group" style="text-align: center; position: relative;">
                        <img id="clientImagePreview" src="" alt="صورة العميل" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                        <button type="button" id="clientImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                        <div id="clientImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#2563eb,#3b82f6); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <input type="file" id="clientImageInput" accept="image/*" style="display: none;">
                        <button type="button" id="clientImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                    </div>

                    <div class="form-group">
                        <label for="clientName">اسم العميل</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">رقم الهاتف</label>
                        <input type="tel" id="clientPhone">
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">البريد الإلكتروني (اختياري)</label>
                        <input type="email" id="clientEmail">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">العنوان (اختياري)</label>
                        <input type="text" id="clientAddress">
                    </div>
                    <div class="form-group">
                        <label for="clientNotes">ملاحظات خاصة (اختياري)</label>
                        <textarea id="clientNotes" rows="3" placeholder="أي تفاصيل مهمة عن العميل..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ</button>
                        <button type="button" class="btn" id="deleteClientBtn" style="display: none; background-color: #ef4444;">حذف</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new API Config Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="apiConfigModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="apiConfigModalTitle">إضافة مفتاح API جديد</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="apiConfigForm">
                    <div class="form-group">
                        <label for="apiConfigProvider">مزود الخدمة</label> 
                        <select id="apiConfigProvider" class="form-group input" style="padding: 10px; width: 100%;"><option value="openrouter">OpenRouter</option></select>
                    </div>
                    <div class="form-group">
                        <label for="apiConfigModel">النموذج</label>
                        <select id="apiConfigModel" class="form-group input" style="padding: 10px; width: 100%;">
                            <!-- سيتم ملء الخيارات هنا بواسطة JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="apiConfigKey">مفتاح API</label>
                        <input type="password" id="apiConfigKey" required placeholder="أدخل مفتاح الـ API هنا">
                    </div>
                    <div class="form-actions"><button type="submit" class="btn">حفظ</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Profile Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="profileModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="profileModalTitle">إضافة ملف تعريفي</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <input type="hidden" id="profileId">
                    <input type="hidden" id="profileLogoDataBase64">

                    <div class="form-group" style="text-align: center; position: relative;">
                        <img id="profileLogoPreview" src="" alt="الشعار" style="width: 100px; height: 100px; border-radius: 16px; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                        <button type="button" id="profileLogoRemoveBtn" title="إزالة الشعار" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                        <div id="profileLogoPlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 16px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <input type="file" id="profileLogoInput" accept="image/*" style="display: none;">
                        <button type="button" id="profileLogoUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">إرفاق شعار</button>

                    <div class="form-group">
                        <label for="profileName">اسم الملف (للتنظيم الداخلي)</label>
                        <input type="text" id="profileName" required placeholder="مثال: حسابي الشخصي">
                    </div>
                    <div class="form-group">
                        <label for="ownerName">اسم صاحب الحساب (اختياري)</label>
                        <input type="text" id="ownerName" placeholder="الاسم الكامل كما يظهر للعميل">
                    </div>
                    <div class="form-group">
                        <label for="profession">المهنة / الصفة</label>
                        <input type="text" id="profession" placeholder="مثال: مصمم ديكور">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone1">رقم الهاتف 1 (اختياري)</label>
                        <input type="tel" id="profilePhone1" placeholder="رقم الهاتف الأساسي">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone2">رقم الهاتف 2</label>
                        <input type="tel" id="profilePhone2" placeholder="رقم هاتف إضافي">
                    </div>
                    <div class="form-group">
                        <label for="profileCcp">حساب CCP</label>
                        <input type="text" id="profileCcp" placeholder="رقم الحساب البريدي الجاري">
                    </div>
                    <div class="form-group">
                        <label for="profileRip">حساب RIP / BaridiMob</label>
                        <input type="text" id="profileRip" placeholder="مفتاح الحساب البنكي">
                    </div>
                    <div class="form-group">
                        <label for="profileAddress">العنوان</label>
                        <input type="text" id="profileAddress" placeholder="عنوان السكن أو العمل">
                    </div>
                    <div class="form-group">
                        <label for="privateNotes">معلومات إضافية (اختياري)</label>
                        <textarea id="privateNotes" rows="3" placeholder="أي معلومات إضافية تود ظهورها في البطاقة..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ الملف</button>
                        <button type="button" class="btn" id="deleteProfileBtn" style="display: none; background-color: #ef4444;">حذف</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Expense Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="expenseModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expenseModalTitle">إضافة نفقة جديدة</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <input type="hidden" id="expenseId">
                    <input type="hidden" id="expenseImageDataBase64">

                    <div class="form-group" style="text-align: center; position: relative;">
                        <img id="expenseImagePreview" src="" alt="صورة الإيصال" style="width: 100px; height: 100px; border-radius: 12px; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                        <button type="button" id="expenseImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                        <div id="expenseImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 12px; background: linear-gradient(135deg,#ef4444,#dc2626); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <input type="file" id="expenseImageInput" accept="image/*" style="display: none;">
                        <button type="button" id="expenseImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">إرفاق إيصال</button>

                    <div class="form-group">
                        <label for="expenseDescription">وصف النفقة</label>
                        <input type="text" id="expenseDescription" required placeholder="مثال: شراء دهانات">
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">المبلغ (د.ج)</label>
                        <input type="number" id="expenseAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">التاريخ</label>
                        <input type="date" id="expenseDate" required style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="expenseProjectName">ربط بمشروع (اكتب للاختيار أو للإضافة)</label>
                        <input type="text" id="expenseProjectName" list="project-list" placeholder="مثال: فيلا بودواو" style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; width: 100%;">
                        <datalist id="project-list"></datalist>
                    </div>
                    <!-- *** إضافة: حقل جديد للملاحظات *** -->
                    <div class="form-group">
                        <label for="expenseNotes">ملاحظات (اختياري)</label>
                        <textarea id="expenseNotes" rows="3" placeholder="أضف أي تفاصيل إضافية هنا..."></textarea>
                    </div>
                    <div class="form-group payment-status-group" style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;">
                        <label style="margin-bottom: 10px; display: block;">حالة الدفع</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="expensePaymentStatus" value="paid" checked style="margin-left: 5px;">مدفوع
                            </label>
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="expensePaymentStatus" value="unpaid" style="margin-left: 5px;">غير مدفوع
                            </label>
                        </div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn">حفظ</button><button type="button" class="btn" id="deleteExpenseBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Project Payment Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="projectPaymentModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectPaymentModalTitle">إضافة دفعة من العميل</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectPaymentForm">
                    <input type="hidden" id="projectPaymentId">
                    <input type="hidden" id="paymentProjectId">
                    <div class="form-group">
                        <!-- *** إصلاح: تم تغيير id ليكون فريداً وتجنب التعارض مع النماذج الأخرى *** -->
                        <label for="projectPaymentAmount">المبلغ المستلم (د.ج)</label>
                        <input type="number" id="projectPaymentAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">تاريخ الاستلام</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <!-- *** إضافة: حقل جديد لإضافة ملاحظات على الدفعة *** -->
                    <div class="form-group">
                        <label for="projectPaymentNotes">ملاحظات (اختياري)</label>
                        <textarea id="projectPaymentNotes" rows="3" placeholder="مثال: دفعة أولى حسب العقد..."></textarea>
                    </div>
                  <div class="form-actions"><button type="submit" class="btn">حفظ الدفعة</button><button type="button" class="btn" id="deleteProjectPaymentBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new AI Analysis Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="aiAnalysisModal" class="modal-container" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="aiAnalysisModalTitle">تحليل بالذكاء الاصطناعي</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="aiAnalysisModalBody" style="min-height: 150px; line-height: 1.7;">
                <!-- AI response will be injected here -->
            </div>
        </div>
    </div>`);



  // Client Modal Functions
  function openClientModal(clientId = null) {
      const modal = document.getElementById('clientModal');
      const titleEl = document.getElementById('clientModalTitle');
      const form = document.getElementById('clientForm');
      const deleteBtn = document.getElementById('deleteClientBtn');
      const idInput = document.getElementById('clientId');

      // Reset form
      const imageRemoveBtn = document.getElementById('clientImageRemoveBtn');
      if (imageRemoveBtn) {
          resetClientImagePreview();
      }
      form.reset();
      deleteBtn.style.display = 'none';

      if (clientId) {
          const client = state.clients.find(c => c.id === clientId);
          if (client) {
              titleEl.textContent = 'تعديل بيانات العميل';
              document.getElementById('clientName').value = client.name;
              document.getElementById('clientPhone').value = client.phone || '';
              document.getElementById('clientEmail').value = client.email || '';
              document.getElementById('clientAddress').value = client.address || '';
              document.getElementById('clientNotes').value = client.notes || '';
              if (client.imageUrl) {
                  document.getElementById('clientImageDataBase64').value = client.imageUrl;
                  document.getElementById('clientImagePreview').src = client.imageUrl;
                  showClientImagePreview(true);
              }
              idInput.value = client.id;
              deleteBtn.style.display = 'block';
          }
      } else {
          titleEl.textContent = 'إضافة عميل جديد';
          idInput.value = '';
      }

      modal.style.display = 'flex';
  }

  function closeClientModal() {
      document.getElementById('clientModal').style.display = 'none';
  }

  async function handleClientFormSubmit(e) {
      e.preventDefault();
      
      const clientData = {
          name: document.getElementById('clientName').value,
          phone: document.getElementById('clientPhone').value,
          email: document.getElementById('clientEmail').value,
          address: document.getElementById('clientAddress').value,
          notes: document.getElementById('clientNotes').value,
          imageUrl: document.getElementById('clientImageDataBase64').value,
      };

      const clientId = document.getElementById('clientId').value;
      
      try {
          if (clientId) {
              // Update existing client
              await db.clients.update(parseInt(clientId), clientData);
              showToast('تم تحديث بيانات العميل بنجاح');
          } else {
              // Add new client
              await db.clients.add(clientData);
              showToast('تم إضافة العميل بنجاح');
          }
          
          closeClientModal();
          renderView(clientId ? 'client-details' : 'clients', clientId ? { id: parseInt(clientId) } : {});
      } catch (error) {
          console.error('Error saving client:', error);
          showCustomToast('حدث خطأ أثناء حفظ بيانات العميل', 'error');
      }
  }

  // Project Modal Functions
  function openProjectModal(projectId = null) {
      const modal = document.getElementById('projectModal');
      const titleEl = document.getElementById('projectModalTitle');
      const form = document.getElementById('projectForm');
      const deleteBtn = document.getElementById('deleteProjectBtn');
      const idInput = document.getElementById('projectId');
      // *** إضافة: جلب زر إنهاء المشروع من نافذة التعديل ***
      const finishBtn = document.getElementById('finishProjectBtn');
      // *** إضافة: جلب حاوية وشارة الحالة ***
      const statusContainer = document.getElementById('projectStatusContainer');
      const statusBadge = document.getElementById('projectStatusBadge');

      form.reset();
      deleteBtn.style.display = 'none';
      finishBtn.style.display = 'none'; // إخفاؤه افتراضياً
      statusContainer.style.display = 'none'; // إخفاء حاوية الحالة افتراضياً

      if (projectId) {
          const project = state.projects.find(p => p.id === projectId);
          if (project) {
              titleEl.textContent = 'تعديل المشروع';
              document.getElementById('projectName').value = project.name;
              // *** إضافة: تعبئة الحقول الجديدة عند التعديل ***
              document.getElementById('homeownerName').value = project.homeownerName || '';
              document.getElementById('builderName').value = project.builderName || '';
              document.getElementById('projectBudget').value = project.budget || '';
              idInput.value = project.id;
              deleteBtn.style.display = 'block';

              // *** تحسين: عرض الحالة داخل نافذة التعديل ***
              statusContainer.style.display = 'block';
              statusBadge.textContent = project.status === 'finished' ? 'منتهي' : 'نشط';
              statusBadge.style.backgroundColor = project.status === 'finished' ? 'var(--muted)' : '#10b981';

              // *** تحسين: إظهار زر الإنهاء فقط إذا كان المشروع نشطاً ***
              if (project.status !== 'finished') {
                  finishBtn.style.display = 'block';
              }
          }
      } else {
          titleEl.textContent = 'إضافة مشروع جديد';
          idInput.value = '';
      }

      modal.style.display = 'flex';
  }
  // *** تحسين: دالة موحدة لتغيير حالة المشروع مع معالجة الأخطاء ***
  async function toggleProjectStatus(projectId, newStatus) {
      try {
          await db.projects.update(projectId, { status: newStatus });
          console.log(`Project ${projectId} status successfully updated to '${newStatus}'`);
          // لا تقم بإعادة العرض هنا، سيتم التحكم به من الخارج
      } catch (error) {
          console.error("Failed to update project status:", error);
          alert("حدث خطأ أثناء تحديث حالة المشروع. يرجى المحاولة مرة أخرى.");
          // Re-throw the error to stop the calling function's flow if needed
          throw error;
      }
  }

  // *** إضافة: ربط أزرار حالة المشروع (إنهاء وإعادة فتح) ***
  mainContent.addEventListener('click', async (e) => {
      const reopenBtn = e.target.closest('#reopenProjectBtn');
      if (reopenBtn) {
          const id = parseInt(reopenBtn.dataset.id);
          // التأكيد قبل إعادة تفعيل المشروع
          openConfirmModal('هل تريد إعادة تفعيل هذا المشروع؟', async () => {
              try {
                  await toggleProjectStatus(id, 'active'); // تحديث الحالة
                  renderView('project-details', { id: id });
                  showToast('تمت إعادة تفعيل المشروع.');
                  closeConfirmModal();
              } catch (error) {
                  showCustomToast('حدث خطأ أثناء إعادة تفعيل المشروع', 'error');
              }
          });
      }
  });

  function closeProjectModal() {
      document.getElementById('projectModal').style.display = 'none';
  }

  async function handleProjectFormSubmit(e) {
      e.preventDefault();
      
      const projectData = {
          name: document.getElementById('projectName').value,
          // *** إضافة: حفظ القيم الجديدة في قاعدة البيانات ***
          homeownerName: document.getElementById('homeownerName').value,
          builderName: document.getElementById('builderName').value,
          budget: parseFloat(document.getElementById('projectBudget').value) || 0,
          // clientId is removed
      };

      const projectId = document.getElementById('projectId').value;
      
      try {
          if (projectId) {
              await db.projects.update(parseInt(projectId), projectData);
              showToast('تم تحديث المشروع بنجاح');
          } else {
              // *** إضافة: تحديد الحالة الافتراضية للمشروع الجديد ***
              projectData.status = 'active';
              await db.projects.add(projectData);
              showToast('تم إضافة المشروع بنجاح');
          }
          closeProjectModal();
          // *** تحسين: الانتقال إلى تفاصيل المشروع بعد الحفظ أو التعديل ***
          renderView(projectId ? 'project-details' : 'projects', projectId ? { id: parseInt(projectId) } : {});
      } catch (error) {
          console.error('Error saving project:', error);
          showCustomToast('حدث خطأ أثناء حفظ المشروع', 'error');
      }
  }

  // Project Payment Modal Functions
  function openProjectPaymentModal(paymentId = null, projectId) {
      const modal = document.getElementById('projectPaymentModal');
      const form = document.getElementById('projectPaymentForm');
      const titleEl = document.getElementById('projectPaymentModalTitle');
      const deleteBtn = document.getElementById('deleteProjectPaymentBtn');
      
      form.reset();
      document.getElementById('paymentProjectId').value = projectId;
      deleteBtn.style.display = 'none';

      if (paymentId) {
          const payment = state.projectPayments.find(p => p.id === paymentId);
          if (payment) {
              titleEl.textContent = 'تعديل دفعة العميل';
              document.getElementById('projectPaymentId').value = payment.id; 
              // *** إصلاح: استخدام الـ id الجديد للحقل ***
              document.getElementById('projectPaymentAmount').value = payment.amount;
              document.getElementById('paymentDate').value = payment.date;
              // *** إضافة: تعبئة حقل الملاحظات عند التعديل ***
              document.getElementById('projectPaymentNotes').value = payment.notes || '';
              deleteBtn.style.display = 'block';
          }
      } else {
          titleEl.textContent = 'إضافة دفعة من العميل';
          document.getElementById('projectPaymentId').value = '';
          document.getElementById('paymentDate').valueAsDate = new Date();
      }

      modal.style.display = 'flex';
  }

  function closeProjectPaymentModal() {
      document.getElementById('projectPaymentModal').style.display = 'none';
  }

  async function handleProjectPaymentFormSubmit(e) {
      e.preventDefault();
      if (!e.target.checkValidity()) return; // Prevent submission if form is invalid
      const paymentId = document.getElementById('projectPaymentId').value;
      const projectId = parseInt(document.getElementById('paymentProjectId').value);
      const paymentData = {
          projectId: projectId,
          // *** إصلاح: القراءة من الـ id الصحيح وتحويل القيمة إلى رقم ***
          amount: parseFloat(document.getElementById('projectPaymentAmount').value) || 0,
          date: document.getElementById('paymentDate').value,
          // *** إضافة: حفظ قيمة الملاحظات في قاعدة البيانات ***
          notes: document.getElementById('projectPaymentNotes').value,
      };

      if (paymentId) {
          await db.projectPayments.update(parseInt(paymentId), paymentData);
          showToast('تم تحديث الدفعة بنجاح');
      } else {
          await db.projectPayments.add(paymentData);
          showToast('تم إضافة الدفعة بنجاح');
      }
      closeProjectPaymentModal();
      renderView('project-details', { id: projectId, tab: 'finance' });
  }

  // *** إصلاح: إضافة معالج حدث لزر حذف الدفعة ***
  document.getElementById('deleteProjectPaymentBtn').addEventListener('click', () => {
      // فتح نافذة التأكيد قبل الحذف
      openConfirmModal('هل أنت متأكد من حذف هذه الدفعة؟', async () => {
          const paymentId = parseInt(document.getElementById('projectPaymentId').value);
          const projectId = parseInt(document.getElementById('paymentProjectId').value);
          if (paymentId) {
              // تنفيذ عملية الحذف من قاعدة البيانات
              await db.projectPayments.delete(paymentId);
              showToast('تم حذف الدفعة بنجاح');
              closeProjectPaymentModal();
              closeConfirmModal();
              // تحديث الواجهة مباشرة لإظهار التغيير
              renderView('project-details', { id: projectId, tab: 'finance' });
          }
      });
  });

  function deleteWorker() {
      // Implementation for deleting a worker will be added in the next step
  }

  // *** إضافة: دالة لإظهار رسالة منبثقة مع زر تراجع ***
  function showUndoToast(message, onUndo) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.backgroundColor = '#f97316'; // Orange color for this special toast

      const messageSpan = document.createElement('span');
      messageSpan.innerHTML = message;

      const undoButton = document.createElement('button');
      undoButton.textContent = onUndo.name === 'reopenProject' ? 'إعادة تفعيل' : 'تراجع'; // *** تحسين: تغيير نص الزر حسب السياق ***
      undoButton.style.cssText = 'background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-right: 15px; font-weight: 700;';
      
      undoButton.onclick = () => {
          onUndo();
          toast.remove();
      };

      toast.appendChild(messageSpan);
      toast.appendChild(undoButton);
      container.appendChild(toast);

      setTimeout(() => { toast.remove(); }, 6000); // Remove after 6 seconds if not undone
  }

  function resetClientImagePreview() {
      document.getElementById('clientImageDataBase64').value = '';
      document.getElementById('clientImageInput').value = '';
      const preview = document.getElementById('clientImagePreview');
      preview.src = '';
      preview.style.display = 'none';
      document.getElementById('clientImagePlaceholder').style.display = 'flex';
      document.getElementById('clientImageRemoveBtn').style.display = 'none';
  }

  function showClientImagePreview(show) {
      const preview = document.getElementById('clientImagePreview');
      const placeholder = document.getElementById('clientImagePlaceholder');
      const removeBtn = document.getElementById('clientImageRemoveBtn');
      preview.style.display = show ? 'block' : 'none';
      placeholder.style.display = show ? 'none' : 'flex';
      removeBtn.style.display = show ? 'inline-block' : 'none';
  }

  function deleteClient() {
      // Implementation for deleting a worker will be added in the next step
  }

  function switchProjectTab(tabId) {
    // Update URL without reloading to remember the tab
    const projectId = state.currentView.params.id;
    state.currentView.params.tab = tabId;

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    // Deactivate all tab buttons
    document.querySelectorAll('.tab-card').forEach(button => button.classList.remove('active'));
    // Show the selected tab content
    document.getElementById(`${tabId}Tab`).classList.add('active');
    // Activate the selected tab button
    document.querySelector(`.tab-card[data-tab="${tabId}"]`).classList.add('active');
  }

  // =================================================================
  // 4. EVENT LISTENERS & INITIALIZATION
  // =================================================================
  window.addEventListener('load', () => {
    setTimeout(() => {
      splash.classList.add('hidden');
      const appElement = document.getElementById('app');
      appElement.setAttribute('aria-hidden', 'false');
      appElement.style.visibility = 'visible';
    }, 1500);
  });
  
  themeToggleHeader.addEventListener('click', toggleTheme);
  mainContent.addEventListener('click', (e) => {
    const card = e.target.closest('.card[data-key]');
    if (card) {
        renderView(card.dataset.key, {});
    }
  });


  mainNav.addEventListener('click', (e) => {
    const navItem = e.target.closest('.nav-item[data-view]');
    if (navItem) {
        const currentActive = mainNav.querySelector('.nav-item.active');
        if (!currentActive || currentActive.dataset.view !== navItem.dataset.view) {
            renderView(navItem.dataset.view, {});
        }
    }
  });

  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  // تم نقل هذه الروابط هنا لضمان تنفيذها مرة واحدة بعد تحميل الصفحة
  document.getElementById('projectForm').addEventListener('submit', handleProjectFormSubmit);

  // Worker Modal Listeners
  workerForm.addEventListener('submit', handleWorkerFormSubmit);
  workerModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeWorkerModal();
      }
  });
  deleteWorkerBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا العامل؟<br>سيتم حذف جميع بياناته بشكل نهائي.', async () => {
          const id = parseInt(workerIdInput.value);
          await db.workers.delete(id);
          renderView('workers');
          closeWorkerModal();
          closeConfirmModal();
      });
  });

  // Supplier Modal Listeners
  supplierForm.addEventListener('submit', handleSupplierFormSubmit);
  supplierModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeSupplierModal();
      }
  });
  deleteSupplierBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا المورد؟', async () => {
          const id = parseInt(supplierIdInput.value);
          await db.suppliers.delete(id);
          renderView('suppliers');
          closeSupplierModal();
          closeConfirmModal();
      });
  });

  document.getElementById('deleteProjectBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا المشروع؟ سيتم أيضاً حذف جميع النفقات المرتبطة به.', async () => {
          const id = parseInt(document.getElementById('projectId').value);
          await db.projects.delete(id);
          renderView('projects');
          closeProjectModal();
          closeConfirmModal();
      });
  });

  // *** إضافة: معالج حدث لزر إنهاء المشروع ***
  document.getElementById('finishProjectBtn')?.addEventListener('click', () => {
      const projectId = parseInt(document.getElementById('projectId').value);
      if (projectId) {
          openConfirmModal('هل أنت متأكد من إنهاء هذا المشروع؟', async () => {
              try {
                  await toggleProjectStatus(projectId, 'finished');
                  showToast('تم إنهاء المشروع بنجاح');
                  closeProjectModal();
                  closeConfirmModal();
                  // تحديث العرض مع الانتقال مباشرة إلى تبويب الملخص
                  renderView('project-details', { id: projectId, tab: 'summary' });
              } catch (error) {
                  showCustomToast('حدث خطأ أثناء إنهاء المشروع', 'error');
              }
          });
      }
  });

  // *** إصلاح: ربط الأحداث لنافذة المشروع المنبثقة (Modal) ***
  document.getElementById('projectModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeProjectModal();
      }
  });


  // Client View Listeners
  mainContent.addEventListener('click', (e) => {
      if (e.target.closest('#addClientBtn')) { openClientModal(); }
      if (e.target.closest('[data-action="view-client"]')) { renderView('client-details', { id: parseInt(e.target.closest('[data-action="view-client"]').dataset.id) }); }
  });

  // Supplier Image Listeners
  supplierImageUploadBtn.addEventListener('click', () => supplierImageInput.click());
  supplierImagePlaceholder.addEventListener('click', () => supplierImageInput.click());
  supplierImagePreview.addEventListener('click', () => supplierImageInput.click());
  supplierImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              supplierImageDataBase64.value = compressedDataUrl;
              supplierImagePreview.src = compressedDataUrl;
              showSupplierImagePreview(true);
          });
      }
  });
  supplierImageRemoveBtn.addEventListener('click', () => resetSupplierImagePreview());



  // Worker Image Listeners
  workerImageUploadBtn.addEventListener('click', () => workerImageInput.click());
  workerImagePlaceholder.addEventListener('click', () => workerImageInput.click());
  workerImagePreview.addEventListener('click', () => workerImageInput.click());

  workerImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              workerImageDataBase64.value = compressedDataUrl;
              workerImagePreview.src = compressedDataUrl;
              showImagePreview(true);
          });
      }
  });

  workerImageRemoveBtn.addEventListener('click', () => resetImagePreview());

  /**
   * Compresses an image file using a canvas.
   * @param {File} file The image file to compress.
   * @param {number} maxSize The maximum width or height of the output image.
   * @param {number} quality A number between 0 and 1 indicating the image quality.
   * @param {function(string): void} callback The function to call with the compressed base64 data URL.
   */
  function compressImage(file, maxSize, quality, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if (width > height) {
                  if (width > maxSize) { height *= maxSize / width; width = maxSize; }
              } else {
                  if (height > maxSize) { width *= maxSize / height; height = maxSize; }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              callback(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = event.target.result;
      };
      reader.readAsDataURL(file);
  }

  // Client Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  const clientForm = document.getElementById('clientForm');
  const clientModal = document.getElementById('clientModal');
  const deleteClientBtn = document.getElementById('deleteClientBtn');

  if (clientForm) {
    clientForm.addEventListener('submit', handleClientFormSubmit);
  }
  if (clientModal) {
    clientModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeClientModal();
      }
  });
  }
  if (deleteClientBtn) {
    deleteClientBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا العميل؟', async () => {
          const id = parseInt(document.getElementById('clientId').value);
          await db.clients.delete(id);
          renderView('clients');
          closeClientModal();
          closeConfirmModal();
      });
  });
  }
  // Client Image Listeners
  document.getElementById('clientImageUploadBtn').addEventListener('click', () => document.getElementById('clientImageInput').click());
  document.getElementById('clientImagePlaceholder').addEventListener('click', () => document.getElementById('clientImageInput').click());
  document.getElementById('clientImagePreview').addEventListener('click', () => document.getElementById('clientImageInput').click());
  document.getElementById('clientImageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              document.getElementById('clientImageDataBase64').value = compressedDataUrl;
              document.getElementById('clientImagePreview').src = compressedDataUrl;
              showClientImagePreview(true);
          });
      }
  });
  document.getElementById('clientImageRemoveBtn').addEventListener('click', () => resetClientImagePreview());

  // Activity Modal Listeners
  activityForm.addEventListener('submit', handleActivityFormSubmit);
  activityModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeActivityModal();
      }
  });

  // Attendance Confirmation Modal Listeners
  const attendanceConfirmModal = document.getElementById('attendanceConfirmModal');
  document.getElementById('confirmPresentBtn').addEventListener('click', () => saveAttendance('present'));
  document.getElementById('confirmAbsentBtn').addEventListener('click', () => saveAttendance('absent'));
  attendanceConfirmModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeAttendanceConfirmModal();
      }
  });

  // Full Activity Log Modal Listeners
  const activityLogModal = document.getElementById('activityLogModal');
  activityLogModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeFullActivityLog();
      }
  });

  // Generic Confirm Modal Listeners
  confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
  confirmModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeConfirmModal();
      }
  });
  confirmModalConfirmBtn.addEventListener('click', () => {
      if (typeof onConfirmCallback === 'function') {
          onConfirmCallback();
      }
  });

  // *** إضافة: ربط النافذة المنبثقة لجميع الدفعات ***
  document.getElementById('allPaymentsModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          document.getElementById('allPaymentsModal').style.display = 'none';
      }
  });

  // *** إضافة: ربط النافذة المنبثقة لجميع النفقات ***
  document.getElementById('allExpensesModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeAllExpensesModal();
      }
  });

  // *** إضافة: ربط النافذة المنبثقة للسجل المالي الكامل ***
  document.getElementById('projectFullFinanceModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          document.getElementById('projectFullFinanceModal').style.display = 'none';
      }
  });


  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('projectPaymentForm').addEventListener('submit', handleProjectPaymentFormSubmit);
  document.getElementById('projectPaymentModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) { closeProjectPaymentModal(); }
  });

  // AI Analysis Modal Listener
  document.getElementById('aiAnalysisModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          document.getElementById('aiAnalysisModal').style.display = 'none';
      }
  });

  // Profile Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('profileForm')?.addEventListener('submit', handleProfileFormSubmit);
  document.getElementById('profileModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeProfileModal();
      }
  });
  document.getElementById('deleteProfileBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا الملف التعريفي؟', async () => {
          const id = parseInt(document.getElementById('profileId').value);
          if (id) {
              await db.companyProfiles.delete(id);
              renderView('my_info');
              closeProfileModal();
              closeConfirmModal();
          }
      });
  });
  document.getElementById('profileLogoUploadBtn')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoPlaceholder')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoPreview')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.8, (compressedDataUrl) => {
              document.getElementById('profileLogoDataBase64').value = compressedDataUrl;
              document.getElementById('profileLogoPreview').src = compressedDataUrl;
              showProfileLogoPreview(true);
          });
      }
  });
  document.getElementById('profileLogoRemoveBtn')?.addEventListener('click', () => resetProfileLogoPreview());

  function openProfileModal(profileId = null) {
      const form = document.getElementById('profileForm');
      form.reset();
      resetProfileLogoPreview();
      if (profileId) {
          const profile = state.companyProfiles.find(p => p.id === profileId);
          if (profile) {
              document.getElementById('profileModalTitle').textContent = 'تعديل الملف التعريفي';
              document.getElementById('profileId').value = profile.id;
              document.getElementById('profileName').value = profile.profileName;
              document.getElementById('ownerName').value = profile.ownerName;
              document.getElementById('profession').value = profile.profession;
              document.getElementById('profileCcp').value = profile.ccp;
              document.getElementById('profilePhone1').value = profile.phone1;
              document.getElementById('profilePhone2').value = profile.phone2;
              document.getElementById('profileRip').value = profile.rip;
              document.getElementById('profileAddress').value = profile.address;
              document.getElementById('privateNotes').value = profile.privateNotes;
              if (profile.logoUrl) {
                  document.getElementById('profileLogoDataBase64').value = profile.logoUrl;
                  document.getElementById('profileLogoPreview').src = profile.logoUrl;
                  showProfileLogoPreview(true);
              }
              document.getElementById('deleteProfileBtn').style.display = 'inline-block';
          }
      } else {
          document.getElementById('profileModalTitle').textContent = 'إضافة ملف تعريفي جديد';
          document.getElementById('profileId').value = '';
          document.getElementById('deleteProfileBtn').style.display = 'none';
      }
      document.getElementById('profileModal').style.display = 'flex';
  }

  // Note Modal Listeners
  noteForm.addEventListener('submit', handleNoteFormSubmit);
  noteModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeNoteModal();
      }
  });
  noteModal.querySelectorAll('.swatch').forEach(swatch => {
      swatch.addEventListener('click', () => {
          noteModal.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
          swatch.classList.add('selected');
          noteColorInput.value = swatch.dataset.color;
      });
  });
  deleteNoteBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه الملاحظة؟', async () => {
          const id = parseInt(noteIdInput.value);
          if (id) {
              await db.notes.delete(id);
              renderView('notes');
              closeNoteModal();
              closeConfirmModal();
          }
      });
  });
  // Note AI Helper Dropdown
  document.getElementById('noteAiHelperBtn').addEventListener('click', (e) => {
      const dropdown = document.getElementById('noteAiActionDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'flex' : 'none';
      e.stopPropagation();
  });
  document.getElementById('noteAiActionDropdown').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
          handleNoteAiAction(e.target.dataset.action);
          document.getElementById('noteAiActionDropdown').style.display = 'none';
      }
  });
  document.body.addEventListener('click', () => {
      document.getElementById('noteAiActionDropdown').style.display = 'none';
  });

  // Inventory Modal Listeners
  inventoryForm.addEventListener('submit', handleInventoryFormSubmit);
  inventoryModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeInventoryModal();
      }
  });
  deleteInventoryBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه الأداة؟', async () => {
          const id = parseInt(inventoryIdInput.value);
          if (id) {
              await db.inventory.delete(id);
              renderView('inventory');
              closeInventoryModal();
              closeConfirmModal();
          }
      });
  });
  inventoryImageUploadBtn.addEventListener('click', () => inventoryImageInput.click());
  inventoryImagePlaceholder.addEventListener('click', () => inventoryImageInput.click());
  inventoryImagePreview.addEventListener('click', () => inventoryImageInput.click());
  inventoryImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              inventoryImageDataBase64.value = compressedDataUrl;
              inventoryImagePreview.src = compressedDataUrl;
              showInventoryImagePreview(true);
          });
      }
  });
  inventoryImageRemoveBtn.addEventListener('click', () => resetInventoryImagePreview());

  // Calendar Event Modal Listeners
  eventForm.addEventListener('submit', handleEventFormSubmit);
  eventModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeEventModal();
      }
  });
  deleteEventBtn.addEventListener('click', () => {
      // This button can be clicked from two places, so we check both possible sources for the ID
      const id = parseInt(eventIdInput.value) || parseInt(deleteEventBtn.dataset.id);
      if (id) {
          openConfirmModal('هل أنت متأكد من حذف هذا الحدث؟', async () => {
              await db.calendarEvents.delete(id);
              renderView('calendar');
              closeEventModal();
              closeEventDetailsModal();
              closeConfirmModal();
          });
      }
  });

    // Task Modal Listeners (ensure task form doesn't trigger full page reload)
    const taskModal = document.getElementById('taskModal');
    const taskForm = document.getElementById('taskForm');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');

    if (taskForm) {
        taskForm.addEventListener('submit', handleTaskFormSubmit);
    }
    if (taskModal) {
        taskModal.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
                closeTaskModal();
            }
        });
    }
    if (deleteTaskBtn) {
        deleteTaskBtn.addEventListener('click', () => {
            const id = parseInt(document.getElementById('taskId').value) || parseInt(deleteTaskBtn.dataset.id);
            if (id) {
                openConfirmModal('هل أنت متأكد من حذف هذه المهمة؟', async () => {
                    await db.projectTasks.delete(id);
                    const projectId = parseInt(document.getElementById('taskProjectId').value);
                    renderView('project-details', { id: projectId, tab: 'tasks' });
                    closeTaskModal();
                    closeConfirmModal();
                });
            }
        });
    }

  // Event Details Modal Listeners
  eventDetailsModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeEventDetailsModal();
      }
  });
  deleteEventDetailsBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا الحدث؟', async () => {
          const id = parseInt(deleteEventBtn.dataset.id);
          if (id) {
              await db.calendarEvents.delete(id);
              renderView('calendar');
              closeEventDetailsModal();
              closeConfirmModal();
          }
      });
  });

  // Expense Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('expenseForm')?.addEventListener('submit', handleExpenseFormSubmit);
  document.getElementById('expenseModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeExpenseModal();
      }
  });
  document.getElementById('deleteExpenseBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه النفقة؟', async () => {
          const id = parseInt(document.getElementById('expenseId').value);
          if (id) {
              await db.expenses.delete(id);
              // *** تحسين: العودة إلى العرض السابق بدلاً من عرض النفقات دائماً ***
              renderView(state.currentView.name, state.currentView.params);
              closeExpenseModal();
              closeConfirmModal();
          }
      });
  });
  document.getElementById('expenseImageUploadBtn')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImagePlaceholder')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImagePreview')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImageInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 800, 0.8, (compressedDataUrl) => {
              document.getElementById('expenseImageDataBase64').value = compressedDataUrl;
              document.getElementById('expenseImagePreview').src = compressedDataUrl;
              showExpenseImagePreview(true);
          });
      }
  });
  document.getElementById('expenseImageRemoveBtn')?.addEventListener('click', () => resetExpenseImagePreview());

  function closeProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
  }

  function resetProfileLogoPreview() {
      document.getElementById('profileLogoDataBase64').value = '';
      document.getElementById('profileLogoInput').value = '';
      document.getElementById('profileLogoPreview').src = '';
      document.getElementById('profileLogoPreview').style.display = 'none';
      document.getElementById('profileLogoPlaceholder').style.display = 'flex';
      document.getElementById('profileLogoRemoveBtn').style.display = 'none';
  }

  function showProfileLogoPreview(show) {
      document.getElementById('profileLogoPreview').style.display = show ? 'block' : 'none';
      document.getElementById('profileLogoPlaceholder').style.display = show ? 'none' : 'flex';
      document.getElementById('profileLogoRemoveBtn').style.display = show ? 'inline-block' : 'none';
  }

  async function handleProfileFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('profileId').value ? parseInt(document.getElementById('profileId').value) : null;
      const profileData = {
          profileName: document.getElementById('profileName').value,
          ownerName: document.getElementById('ownerName').value,
          profession: document.getElementById('profession').value,
          ccp: document.getElementById('profileCcp').value,
          phone1: document.getElementById('profilePhone1').value,
          phone2: document.getElementById('profilePhone2').value,
          rip: document.getElementById('profileRip').value,
          address: document.getElementById('profileAddress').value,
          privateNotes: document.getElementById('privateNotes').value,
          logoUrl: document.getElementById('profileLogoDataBase64').value,
      };

      if (id) {
          await db.companyProfiles.update(id, profileData);
      } else {
          await db.companyProfiles.add(profileData);
      }
      renderView('my_info');
      closeProfileModal();
  }

  // API Config Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('apiConfigForm')?.addEventListener('submit', handleApiConfigFormSubmit);
  document.getElementById('apiConfigModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeApiConfigModal();
      }
  });
  document.getElementById('apiConfigProvider')?.addEventListener('change', populateApiModels);


  async function toggleActiveApi(apiId, forceActivate = false) {
      let isActivating = forceActivate;
      if (!forceActivate) {
          const checkbox = document.querySelector(`[data-action="toggle-api-active"][data-id="${apiId}"]`);
          if (checkbox) {
              isActivating = checkbox.checked;
          }
      }

      if (isActivating) {
          await db.app_settings.put({ key: 'active_api_id', value: apiId });
          state.active_api_id = apiId;
      } else if (state.active_api_id === apiId) {
          await db.app_settings.delete('active_api_id');
          state.active_api_id = null;
      }
      renderView('api_settings');
  }

  async function deleteApiConfig(apiId) {
      openConfirmModal('هل أنت متأكد من حذف إعداد الـ API هذا؟', async () => {
          await db.api_configs.delete(apiId);
          if (state.active_api_id === apiId) {
              await db.app_settings.delete('active_api_id');
              state.active_api_id = null;
          }
          closeConfirmModal();
          renderView('api_settings');
      });
  }

  const availableModels = {
      openrouter: [
          { id: 'openai/gpt-3.5-turbo', name: 'ChatGPT 3.5 Turbo' }
      ]
  };

  function populateApiModels() {
      const provider = document.getElementById('apiConfigProvider').value;
      const modelSelect = document.getElementById('apiConfigModel');
      const models = availableModels[provider] || [];
      modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
  }

  async function handleApiConfigFormSubmit(e) {
      e.preventDefault();
      const provider = document.getElementById('apiConfigProvider').value;
      const modelId = document.getElementById('apiConfigModel').value;
      const apiKey = document.getElementById('apiConfigKey').value;

      if (!apiKey) {
          showCustomToast('الرجاء إدخال مفتاح API.', 'error');
          return;
      }
      if (!modelId) {
          showCustomToast('الرجاء اختيار نموذج.', 'error');
          return;
      }

      const providerModels = availableModels[provider] || [];
      const selectedModel = providerModels.find(m => m.id === modelId);
      if (!selectedModel) {
          showCustomToast('نموذج غير صالح.', 'error');
          return;
      }

      // Create a descriptive name
      const configName = provider === 'gemini' ? 'Google Gemini' : `OpenRouter: ${selectedModel.name}`;

      const configData = {
          name: configName,
          provider: provider,
          apiKey: apiKey,
          model: modelId,
      };

      const newId = await db.api_configs.add(configData);

      if (!state.active_api_id) {
          await toggleActiveApi(newId, true); // Activate it and re-render
      }

      showToast('تم حفظ الإعداد بنجاح!');
      renderView('api_settings');
      closeApiConfigModal();
  }

  function openApiConfigModal() {
      const form = document.getElementById('apiConfigForm');
      form.reset();
      populateApiModels(); // Populate models for the default provider
      document.getElementById('apiConfigModal').style.display = 'flex';
  }

  function closeApiConfigModal() {
      document.getElementById('apiConfigModal').style.display = 'none';
  }

  // =================================================================
  // 5. AI ASSISTANT LOGIC
  // =================================================================

  /**
   * Gathers and formats the current application state for the AI context.
   * @returns {string} A formatted string containing the app context.
   */
  function getAppContextForAI() {
      // Create detailed summaries for the AI.
      const workersDetails = state.workers.map(worker => {
        const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
        const allActivities = [
            ...(worker.attendance || []).map(a => ({ type: a.status, date: a.date, amount: a.dailyRate })),
            ...(worker.payments || []).map(p => ({ type: 'payment', date: p.date, amount: p.amount, note: p.note })),
            ...(worker.bonuses || []).map(b => ({ type: 'bonus', date: b.date, amount: b.amount, note: b.note }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));

        return {
            name: worker.name,
            dailyRate: worker.dailyRate,
            balance: totalDue - totalPaid,
            activities: allActivities.slice(0, 15) // Limit to last 15 activities to keep context size reasonable
        };
      });

      const inventoryDetails = state.inventory.map(item => {
        let details = {
            name: item.name,
            status: item.status,
            quantity: item.quantity,
        };
        if (item.status === 'in_use') {
            details.borrower = item.borrowerName;
            details.borrowDate = item.borrowDate;
        }
        return details;
      });

      const expensesDetails = state.expenses.map(e => ({
        description: e.description,
        amount: e.amount,
        date: e.date
      }));

      // Include payment info from "My Info"
      const profilesInfo = state.companyProfiles.map(p => ({
          profileName: p.profileName,
          paymentInfo: { ccp: p.ccp, rip: p.rip, phone: p.phone1 }
      }));
      
      const contextData = {
          currentDate: new Date().toISOString().split('T')[0],
          workers: workersDetails,
          inventory: inventoryDetails,
          expenses: expensesDetails,
          myPaymentProfiles: profilesInfo
      };

      const systemPrompt = `أنت مساعد ذكاء اصطناعي في تطبيق "مدير الديكور". لديك الوصول إلى البيانات الحالية للتطبيق بصيغة JSON. استخدم هذه البيانات للإجابة على أسئلة المستخدم المتعلقة بأعماله. كن موجزاً ومباشراً في إجاباتك.\n\nبيانات التطبيق الحالية:\n${JSON.stringify(contextData, null, 2)}`;

      return systemPrompt;
  }

  async function handleAnalysisRequest(type, id) {
      const modal = document.getElementById('aiAnalysisModal');
      const modalBody = document.getElementById('aiAnalysisModalBody');
      const modalTitle = document.getElementById('aiAnalysisModalTitle');

      modal.style.display = 'flex';
      modalBody.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%;"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;

      let itemData, prompt;

      try {
          switch (type) {
              // *** إضافة: حالة جديدة لتحليل بيانات المشروع ***
              case 'project':
                const project = state.projects.find(p => p.id === id);
                if (!project) throw new Error('لم يتم العثور على المشروع.');

                // جمع البيانات المالية للمشروع
                const clientPayments = state.projectPayments.filter(p => p.projectId === id);
                const totalReceived = clientPayments.reduce((sum, p) => sum + p.amount, 0);
                const projectExpenses = state.expenses.filter(e => e.projectId === id);
                const totalPaidExpenses = projectExpenses.filter(e => e.paymentStatus === 'paid').reduce((sum, e) => sum + e.amount, 0);
                const netBalance = totalReceived - totalPaidExpenses;

                itemData = {
                    name: project.name,
                    budget: project.budget,
                    totalReceived: totalReceived,
                    totalPaidExpenses: totalPaidExpenses,
                    netBalance: netBalance
                };
                modalTitle.textContent = `تحليل المشروع: ${project.name}`;
                prompt = `بصفتك مستشاراً مالياً، حلل بيانات المشروع التالية وقدم ملخصاً واضحاً للحالة المالية، مع تحديد أي مخاطر (مثل تجاوز الميزانية) وتقديم توصية عملية واحدة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                break;
              case 'worker':
                const worker = state.workers.find(w => w.id === id);
                if (!worker) throw new Error('لم يتم العثور على العامل.');
                
                // Create a clean data object for the AI, not HTML
                const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
                const activitiesSummary = generateActivityLog(worker, 10, null, null, 'text'); // Get text summary

                itemData = { 
                    name: worker.name, 
                    balance: totalDue - totalPaid,
                    recent_activities_summary: activitiesSummary
                };
                modalTitle.textContent = `تحليل العامل: ${worker.name}`;
                prompt = `حلل بيانات العامل التالية وقدم ملخصاً عن أدائه المالي والتزامه مع توصية قصيرة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                break;
              case 'supplier':
                  const supplier = state.suppliers.find(s => s.id === id);
                  if (!supplier) throw new Error('لم يتم العثور على المورد.');
                  itemData = { ...supplier }; // Create a copy
                  delete itemData.imageUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل المورد: ${supplier.name}`;
                  prompt = `حلل بيانات المورد التالية وقدم ملخصاً عنه مع اقتراح للتعامل معه بناءً على تخصصه. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'inventory':
                  const item = state.inventory.find(i => i.id === id);
                  if (!item) throw new Error('لم يتم العثور على الأداة.');
                  itemData = { ...item }; // Create a copy
                  delete itemData.imageUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل الأداة: ${item.name}`;
                  prompt = `حلل بيانات الأداة التالية وقدم ملخصاً لحالتها الحالية مع توصية للصيانة أو المتابعة. إذا كانت مُعارة، اذكر لمن وتاريخ الإعارة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'profile':
                  const profile = state.companyProfiles.find(p => p.id === id);
                  if (!profile) throw new Error('لم يتم العثور على الملف التعريفي.');
                  itemData = { ...profile }; // Create a copy
                  delete itemData.logoUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل الملف: ${profile.profileName}`;
                  prompt = `حلل بيانات الدفع التالية ولخصها مع ذكر أي معلومات قد تكون ناقصة ومهمة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'expense':
                  const expense = state.expenses.find(e => e.id === id);
                  if (!expense) throw new Error('لم يتم العثور على النفقة.');
                  itemData = { ...expense }; // Create a copy
                  delete itemData.receiptUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل النفقة: ${expense.description}`;
                  prompt = `حلل بيانات النفقة التالية وقدم ملخصاً لها، مع ذكر المبلغ والتاريخ وأي مشروع أو عامل مرتبط بها. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'event':
                  const event = state.calendarEvents.find(e => e.id === id);
                  if (!event) throw new Error('لم يتم العثور على الحدث.');
                  itemData = event;
                  modalTitle.textContent = `تحليل الحدث: ${event.title}`;
                  prompt = `حلل بيانات الحدث التالي في الجدول الزمني وقدم ملخصاً له مع توصية قصيرة للاستعداد. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'note':
                  const note = state.notes.find(n => n.id === id);
                  if (!note) throw new Error('لم يتم العثور على الملاحظة.');
                  itemData = { title: note.title, content: note.content };
                  modalTitle.textContent = `تحليل الملاحظة`;
                  prompt = `بصفتك مساعداً ذكياً، قم بتحليل الملاحظة التالية. لخصها، استخرج أي معلومات مهمة (مثل مقاسات، مهام، أرقام هواتف)، واقترح عنواناً أفضل إن أمكن. الملاحظة: ${JSON.stringify(itemData, null, 2)}.`;
                  break;
              default:
                  throw new Error('نوع التحليل غير معروف.');
          }

          // We send a single-turn request for this, no need for full history
          const historyForAnalysis = [{ role: 'user', content: prompt }];
          const responseText = await callAI(historyForAnalysis);

          if (!responseText) {
              modalBody.innerHTML = `<p>عذراً، لم يتم تلقي رد من المساعد.</p>`;
          } else {
              modalBody.innerHTML = marked.parse(responseText);
          }

      } catch (error) {
          modalBody.innerHTML = `
              <p style="color: #ef4444;">حدث خطأ أثناء طلب التحليل.</p>
              <p style="font-size: 13px; color: var(--muted); direction: ltr; text-align: right; white-space: pre-wrap;">${error.message}</p>
              <button onclick="renderView('api_settings')" class="btn ghost" style="margin-top: 12px;">التحقق من إعدادات الـ API</button>
          `;
      }
  }






  async function handleSendAiPrompt() {
      const input = document.getElementById('aiPromptInput');
      const history = document.getElementById('aiChatHistory');
      const sendBtn = document.getElementById('sendAiPromptBtn');
      const prompt = input.value.trim();
      if (!prompt) return;

      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      // Add user message to UI and state
      const userBubble = document.createElement('div');
      userBubble.className = 'ai-chat-bubble user';
      userBubble.textContent = prompt;
      history.appendChild(userBubble);
      
      // Add user message to the history that will be sent to the AI
      state.aiChatHistory.push({ role: 'user', content: prompt });

      history.scrollTop = history.scrollHeight;

      const typingBubble = document.createElement('div');
      typingBubble.className = 'ai-chat-bubble model';
      typingBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      history.appendChild(typingBubble);
      history.scrollTop = history.scrollHeight;

      try {
          // 1. Get the app context
          const appContextPrompt = getAppContextForAI();

          // 2. Create the full history with the system prompt at the beginning
          const historyWithContext = [
              { role: 'user', content: appContextPrompt }, // The system prompt is framed as a user message for simplicity with some APIs
              ...state.aiChatHistory.slice(-1) // Get the last user message
          ];
          const responseText = await callAI(historyWithContext);
          if (!responseText) {
              typingBubble.innerHTML = `عذراً، لم يتم تلقي رد من المساعد. يرجى المحاولة مرة أخرى لاحقاً.`;
          } else {
              typingBubble.innerHTML = marked.parse(responseText);
              state.aiChatHistory.push({ role: 'model', content: responseText });
          }
      } catch (error) {
          typingBubble.innerHTML = `عذراً، حدث خطأ أثناء الاتصال بالمساعد. يرجى التحقق من إعدادات الـ API أو المحاولة لاحقاً. <br><small style="color: var(--muted);">${error.message}</small>`;
      } finally {
          input.disabled = false;
          input.focus();
          history.scrollTop = history.scrollHeight;
      }
  }

  async function callAI(chatHistory) {
      if (!state.active_api_id) throw new Error("لا يوجد مفتاح API نشط.");

      const config = state.api_configs.find(c => c.id === state.active_api_id);
      if (!config) throw new Error("لم يتم العثور على إعدادات الـ API النشطة.");

      // Map our history to the format the API expects.
      const messages = chatHistory.map(msg => ({
          role: msg.role === 'model' ? 'assistant' : msg.role,
          content: msg.content
      }));

      if (config.provider !== 'openrouter') {
          throw new Error(`مزود الخدمة '${config.provider}' غير مدعوم.`);
      }

      const url = 'https://openrouter.ai/api/v1/chat/completions';
      const options = {
          method: 'POST',
          headers: {
              'Authorization': `Bearer ${config.apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': 'https://my-decor-manager.app', // Example referrer
              'X-Title': 'My Decor Manager',
          },
          body: JSON.stringify({ model: config.model, messages: messages })
      };

      try {
          const response = await fetch(url, options);

          if (!response.ok) {
              // Try to parse the error response from the API for a more detailed message
              let errorDetails = `Status: ${response.status} ${response.statusText}`;
              try {
                  const errorData = await response.json();
                  if (errorData.error && errorData.error.message) {
                      errorDetails = errorData.error.message;
                  }
              } catch (e) {
                  // Could not parse JSON, stick with the status text
              }
              throw new Error(`فشل طلب الـ API:\n${errorDetails}`);
          }

          const data = await response.json();
          const content = data.choices?.[0]?.message?.content;
          
          if (!content) throw new Error("لم يتم العثور على محتوى في رد الـ API.");

          return content;
      } catch (error) {
          // Re-throw network errors or errors from the !response.ok block
          throw error;
      }
  }

  async function handleNoteAiAction(action) {
      const noteContentInput = document.getElementById('noteContent');
      const noteTitleInput = document.getElementById('noteTitle');
      const text = noteContentInput.value;
      const helperBtn = document.getElementById('noteAiHelperBtn');

      if (!text) {
          showCustomToast('لا يوجد محتوى لمعالجته.', 'error');
          return;
      }

      let prompt;
      switch (action) {
          case 'summarize':
              prompt = `لخص النص التالي في بضع نقاط رئيسية:\n\n${text}`;
              break;
          case 'rephrase':
              prompt = `أعد صياغة النص التالي بأسلوب أكثر وضوحاً واحترافية:\n\n${text}`;
              break;
          case 'suggest_title':
              prompt = `اقترح عنواناً قصيراً ومناسباً للملاحظة التالية:\n\n${text}`;
              break;
          default: return;
      }

      const originalBtnContent = helperBtn.innerHTML;
      helperBtn.innerHTML = `<div class="typing-indicator" style="padding: 0 10px;"><span></span><span></span><span></span></div>`;
      helperBtn.disabled = true;

      try {
          const historyForAction = [{ role: 'user', content: prompt }];
          const responseText = await callAI(historyForAction);

          if (responseText) {
              if (action === 'suggest_title') {
                  noteTitleInput.value = responseText.replace(/["']/g, ''); // Remove quotes
              } else {
                  noteContentInput.value = responseText;
              }
          }
      } catch (error) {
          showCustomToast(error.message, 'error');
      } finally {
          helperBtn.innerHTML = originalBtnContent;
          helperBtn.disabled = false;
      }
  }
  // First-time setup
  // *** تحسين: إضافة معالجة أخطاء احترافية لتهيئة التطبيق ***
  async function initializeApp() {
    try {
        // محاولة فتح قاعدة البيانات للتحقق من سلامتها
        // *** تحسين: تعيين isDbOpen إلى true بعد الفتح الناجح ***
        await db.open();
        isDbOpen = true; 

        // تحميل البيانات الأولية وتطبيق الإعدادات
        await loadState();
        
        const savedTheme = await db.app_settings.get('selected_theme');
        const themeToApply = savedTheme ? savedTheme.value : 'default-light';
        await applyThemeSet(themeToApply);
        state.active_api_id = (await db.app_settings.get('active_api_id'))?.value || null;
        state.selected_theme = themeToApply;
        
        // عرض الواجهة الرئيسية
        await renderView(state.currentView.name || 'home', state.currentView.params || {});

    } catch (error) {
        console.error("Dexie initialization failed:", error);
        // عرض رسالة خطأ واضحة للمستخدم في حال فشل التهيئة
        mainContent.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <h3 style="color: #ef4444;">حدث خطأ فادح أثناء تهيئة قاعدة البيانات.</h3>
                <p style="color: var(--muted); line-height: 1.6;">قد يكون هذا بسبب تحديث للتطبيق. لحل المشكلة، يرجى محاولة مسح بيانات الموقع من إعدادات المتصفح ثم إعادة تحميل الصفحة.</p>
            </div>`;
    }
  }

  initializeApp();
</script>
</body>
</html>
